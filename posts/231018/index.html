<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Prometheus Operator support an auth proxy for Service Discovery | (p)retired</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="CRD linting
Returning to yesterday&rsquo;s failing tests, it&rsquo;s unclear how to introspect the E2E tests.
kubectl get namespaces
NAME                      STATUS   AGE
...
allns-s2os2u-0-90f56669   Active   22h
allns-s2qhuw-0-6b33d5eb   Active   4m23s
kubectl get all \
--namespace=allns-s2os2u-0-90f56669
No resources found in allns-s2os2u-0-90f56669 namespace.
kubectl get all \
--namespace=allns-s2qhuw-0-6b33d5eb
NAME                                                        READY   STATUS             RESTARTS   AGE
pod/prometheus-operator-6c96477b9c-q6qm2                    1/1     Running            0          4m12s
pod/prometheus-operator-admission-webhook-68bc9f885-nq6r8   0/1     ImagePullBackOff   0          4m7s

NAME                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
service/prometheus-operator   ClusterIP   10.152.183.247   &lt;none&gt;        443/TCP   4m9s

NAME                                                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/prometheus-operator                     1/1     1            1           4m12s
deployment.apps/prometheus-operator-admission-webhook   0/1     1            0           4m7s

NAME                                                              DESIRED   CURRENT   READY   AGE
replicaset.apps/prometheus-operator-6c96477b9c                    1         1         1       4m13s
replicaset.apps/prometheus-operator-admission-webhook-68bc9f885   1         1         0       4m8s
kubectl logs deployment/prometheus-operator-admission-webhook \
--namespace=allns-s2qhuw-0-6b33d5eb
Error from server (BadRequest): container &#34;prometheus-operator-admission-webhook&#34; in pod &#34;prometheus-operator-admission-webhook-68bc9f885-nq6r8&#34; is waiting to start: trying and failing to pull image
NAME=&#34;prometheus-operator-admission-webhook&#34;
FILTER=&#34;{.spec.template.spec.containers[?(@.name==\&#34;${NAME}\&#34;)].image}&#34;

kubectl get deployment/prometheus-operator-admission-webhook \
--namespace=allns-s2qjz2-0-fad82c03 \
--output=jsonpath=&#34;${FILTER}&#34;
quay.io/prometheus-operator/admission-webhook:52d1e55af
Want:">
    <meta name="generator" content="Hugo 0.153.0-DEV">
    
    
    
    
      <meta name="robots" content="index, follow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.cf4aecb341f2e16e80e407465df095cee730d71e19c4574f8e9b28d163dc4225.css" >



  


    

    
    
      

    

    

    <script data-goatcounter="https://pretired.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
 
    <meta property="og:url" content="https://pretired.dazwilkin.com/posts/231018/">
  <meta property="og:site_name" content="(p)retired">
  <meta property="og:title" content="Prometheus Operator support an auth proxy for Service Discovery">
  <meta property="og:description" content="CRD linting
Returning to yesterday’s failing tests, it’s unclear how to introspect the E2E tests.
kubectl get namespaces NAME STATUS AGE ... allns-s2os2u-0-90f56669 Active 22h allns-s2qhuw-0-6b33d5eb Active 4m23s kubectl get all \ --namespace=allns-s2os2u-0-90f56669 No resources found in allns-s2os2u-0-90f56669 namespace. kubectl get all \ --namespace=allns-s2qhuw-0-6b33d5eb NAME READY STATUS RESTARTS AGE pod/prometheus-operator-6c96477b9c-q6qm2 1/1 Running 0 4m12s pod/prometheus-operator-admission-webhook-68bc9f885-nq6r8 0/1 ImagePullBackOff 0 4m7s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/prometheus-operator ClusterIP 10.152.183.247 &lt;none&gt; 443/TCP 4m9s NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/prometheus-operator 1/1 1 1 4m12s deployment.apps/prometheus-operator-admission-webhook 0/1 1 0 4m7s NAME DESIRED CURRENT READY AGE replicaset.apps/prometheus-operator-6c96477b9c 1 1 1 4m13s replicaset.apps/prometheus-operator-admission-webhook-68bc9f885 1 1 0 4m8s kubectl logs deployment/prometheus-operator-admission-webhook \ --namespace=allns-s2qhuw-0-6b33d5eb Error from server (BadRequest): container &#34;prometheus-operator-admission-webhook&#34; in pod &#34;prometheus-operator-admission-webhook-68bc9f885-nq6r8&#34; is waiting to start: trying and failing to pull image NAME=&#34;prometheus-operator-admission-webhook&#34; FILTER=&#34;{.spec.template.spec.containers[?(@.name==\&#34;${NAME}\&#34;)].image}&#34; kubectl get deployment/prometheus-operator-admission-webhook \ --namespace=allns-s2qjz2-0-fad82c03 \ --output=jsonpath=&#34;${FILTER}&#34; quay.io/prometheus-operator/admission-webhook:52d1e55af Want:">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-10-18T00:00:00-07:00">
    <meta property="article:modified_time" content="2023-10-18T00:00:00-07:00">
    <meta property="article:tag" content="Prometheus">
    <meta property="article:tag" content="Prometheus-Operator">
    <meta property="article:tag" content="Scrape-Config-Url-Proxy">

  <meta itemprop="name" content="Prometheus Operator support an auth proxy for Service Discovery">
  <meta itemprop="description" content="CRD linting
Returning to yesterday’s failing tests, it’s unclear how to introspect the E2E tests.
kubectl get namespaces NAME STATUS AGE ... allns-s2os2u-0-90f56669 Active 22h allns-s2qhuw-0-6b33d5eb Active 4m23s kubectl get all \ --namespace=allns-s2os2u-0-90f56669 No resources found in allns-s2os2u-0-90f56669 namespace. kubectl get all \ --namespace=allns-s2qhuw-0-6b33d5eb NAME READY STATUS RESTARTS AGE pod/prometheus-operator-6c96477b9c-q6qm2 1/1 Running 0 4m12s pod/prometheus-operator-admission-webhook-68bc9f885-nq6r8 0/1 ImagePullBackOff 0 4m7s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/prometheus-operator ClusterIP 10.152.183.247 &lt;none&gt; 443/TCP 4m9s NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/prometheus-operator 1/1 1 1 4m12s deployment.apps/prometheus-operator-admission-webhook 0/1 1 0 4m7s NAME DESIRED CURRENT READY AGE replicaset.apps/prometheus-operator-6c96477b9c 1 1 1 4m13s replicaset.apps/prometheus-operator-admission-webhook-68bc9f885 1 1 0 4m8s kubectl logs deployment/prometheus-operator-admission-webhook \ --namespace=allns-s2qhuw-0-6b33d5eb Error from server (BadRequest): container &#34;prometheus-operator-admission-webhook&#34; in pod &#34;prometheus-operator-admission-webhook-68bc9f885-nq6r8&#34; is waiting to start: trying and failing to pull image NAME=&#34;prometheus-operator-admission-webhook&#34; FILTER=&#34;{.spec.template.spec.containers[?(@.name==\&#34;${NAME}\&#34;)].image}&#34; kubectl get deployment/prometheus-operator-admission-webhook \ --namespace=allns-s2qjz2-0-fad82c03 \ --output=jsonpath=&#34;${FILTER}&#34; quay.io/prometheus-operator/admission-webhook:52d1e55af Want:">
  <meta itemprop="datePublished" content="2023-10-18T00:00:00-07:00">
  <meta itemprop="dateModified" content="2023-10-18T00:00:00-07:00">
  <meta itemprop="wordCount" content="809">
  <meta itemprop="keywords" content="Prometheus,Prometheus-Operator,Scrape-Config-Url-Proxy">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Prometheus Operator support an auth proxy for Service Discovery">
  <meta name="twitter:description" content="CRD linting
Returning to yesterday’s failing tests, it’s unclear how to introspect the E2E tests.
kubectl get namespaces NAME STATUS AGE ... allns-s2os2u-0-90f56669 Active 22h allns-s2qhuw-0-6b33d5eb Active 4m23s kubectl get all \ --namespace=allns-s2os2u-0-90f56669 No resources found in allns-s2os2u-0-90f56669 namespace. kubectl get all \ --namespace=allns-s2qhuw-0-6b33d5eb NAME READY STATUS RESTARTS AGE pod/prometheus-operator-6c96477b9c-q6qm2 1/1 Running 0 4m12s pod/prometheus-operator-admission-webhook-68bc9f885-nq6r8 0/1 ImagePullBackOff 0 4m7s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/prometheus-operator ClusterIP 10.152.183.247 &lt;none&gt; 443/TCP 4m9s NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/prometheus-operator 1/1 1 1 4m12s deployment.apps/prometheus-operator-admission-webhook 0/1 1 0 4m7s NAME DESIRED CURRENT READY AGE replicaset.apps/prometheus-operator-6c96477b9c 1 1 1 4m13s replicaset.apps/prometheus-operator-admission-webhook-68bc9f885 1 1 0 4m8s kubectl logs deployment/prometheus-operator-admission-webhook \ --namespace=allns-s2qhuw-0-6b33d5eb Error from server (BadRequest): container &#34;prometheus-operator-admission-webhook&#34; in pod &#34;prometheus-operator-admission-webhook-68bc9f885-nq6r8&#34; is waiting to start: trying and failing to pull image NAME=&#34;prometheus-operator-admission-webhook&#34; FILTER=&#34;{.spec.template.spec.containers[?(@.name==\&#34;${NAME}\&#34;)].image}&#34; kubectl get deployment/prometheus-operator-admission-webhook \ --namespace=allns-s2qjz2-0-fad82c03 \ --output=jsonpath=&#34;${FILTER}&#34; quay.io/prometheus-operator/admission-webhook:52d1e55af Want:">

      
    
	
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-dark-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        (p)retired
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Prometheus Operator support an auth proxy for Service Discovery</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2023-10-18T00:00:00-07:00">October 18, 2023</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 4 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 809 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>CRD <a href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/linting.md">linting</a></p>
<p>Returning to yesterday&rsquo;s failing tests, it&rsquo;s unclear how to introspect the E2E tests.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get namespaces
</span></span></code></pre></div><pre tabindex="0"><code>NAME                      STATUS   AGE
...
allns-s2os2u-0-90f56669   Active   22h
allns-s2qhuw-0-6b33d5eb   Active   4m23s
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get all <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>allns-s2os2u-0-90f56669
</span></span></code></pre></div><pre tabindex="0"><code>No resources found in allns-s2os2u-0-90f56669 namespace.
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get all <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>allns-s2qhuw-0-6b33d5eb
</span></span></code></pre></div><pre tabindex="0"><code>NAME                                                        READY   STATUS             RESTARTS   AGE
pod/prometheus-operator-6c96477b9c-q6qm2                    1/1     Running            0          4m12s
pod/prometheus-operator-admission-webhook-68bc9f885-nq6r8   0/1     ImagePullBackOff   0          4m7s

NAME                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
service/prometheus-operator   ClusterIP   10.152.183.247   &lt;none&gt;        443/TCP   4m9s

NAME                                                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/prometheus-operator                     1/1     1            1           4m12s
deployment.apps/prometheus-operator-admission-webhook   0/1     1            0           4m7s

NAME                                                              DESIRED   CURRENT   READY   AGE
replicaset.apps/prometheus-operator-6c96477b9c                    1         1         1       4m13s
replicaset.apps/prometheus-operator-admission-webhook-68bc9f885   1         1         0       4m8s
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl logs deployment/prometheus-operator-admission-webhook <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>allns-s2qhuw-0-6b33d5eb
</span></span></code></pre></div><pre tabindex="0"><code>Error from server (BadRequest): container &#34;prometheus-operator-admission-webhook&#34; in pod &#34;prometheus-operator-admission-webhook-68bc9f885-nq6r8&#34; is waiting to start: trying and failing to pull image
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;prometheus-operator-admission-webhook&#34;</span>
</span></span><span style="display:flex;"><span>FILTER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.spec.template.spec.containers[?(@.name==\&#34;</span><span style="color:#e6db74">${</span>NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;)].image}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get deployment/prometheus-operator-admission-webhook <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>allns-s2qjz2-0-fad82c03 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>FILTER<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><pre tabindex="0"><code>quay.io/prometheus-operator/admission-webhook:52d1e55af
</code></pre><p>Want:</p>
<pre tabindex="0"><code>localhost:32000/admission-webhook:52d1e55af
</code></pre><p>So, that&rsquo;s the first problem, the <code>admission-webhook</code> should also be in <code>localhost:32000</code> <strong>not</strong> <code>quay.io/prometheus-operator</code></p>
<p>So, it appears the only the operator image is passed to the tests:</p>
<p><a href="https://github.com/prometheus-operator/prometheus-operator/blob/6aefeaf6a1eb39253b3d68947c408936aeba3efd/Makefile#L362">https://github.com/prometheus-operator/prometheus-operator/blob/6aefeaf6a1eb39253b3d68947c408936aeba3efd/Makefile#L362</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go test <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>-timeout 120m <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>-v ./test/e2e/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">$(</span>TEST_RUN_ARGS<span style="color:#66d9ef">)</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--kubeconfig<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>KUBECONFIG<span style="color:#66d9ef">)</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--operator-image<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>IMAGE_OPERATOR<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>TAG<span style="color:#66d9ef">)</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>-count<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>So, I revised:</p>
<ol>
<li><code>makefile</code></li>
</ol>
<pre tabindex="0"><code>go test \
-timeout 120m \
-v ./test/e2e/ \
$(TEST_RUN_ARGS) \
--kubeconfig=$(KUBECONFIG) \
--operator-image=$(IMAGE_OPERATOR):$(TAG) \
--config-reloader=$(IMAGE_RELOADER):$(TAG) \
--admission-webhook=$(IMAGE_WEBHOOK):$(TAG) \
-count=1
</code></pre><ol start="2">
<li><code>main-test.go</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">opImage</span>                  <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">crImage</span>                  <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">awImage</span>                  <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestMain</span>(<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">M</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">opImage</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;operator-image&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;operator image, e.g. quay.io/prometheus-operator/prometheus-operator&#34;</span>,
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">crImage</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;config-reloader&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;config-reloader image, e.g. quay.io/prometheus-operator/prometheus-config-reloader&#34;</span>,
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">awImage</span> = <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;admission-webhook&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;admission-webhook image, e.g. quay.io/prometheus-operator/admission-webhook&#34;</span>,
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">prevStableOpImage</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s:v%s&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;quay.io/prometheus-operator/prometheus-operator&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">TrimSpace</span>(string(<span style="color:#a6e22e">prevStableVersion</span>)),
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">prevStableCRImage</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s:v%s&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;quay.io/prometheus-operator/prometheus-config-reloader&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">TrimSpace</span>(string(<span style="color:#a6e22e">prevStableVersion</span>)),
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">prevStableAWImage</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s:v%s&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;quay.io/prometheus-operator/admission-webhook&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">TrimSpace</span>(string(<span style="color:#a6e22e">prevStableVersion</span>)),
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">framework</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">operatorFramework</span>.<span style="color:#a6e22e">New</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">*</span><span style="color:#a6e22e">kubeconfig</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">*</span><span style="color:#a6e22e">opImage</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">*</span><span style="color:#a6e22e">crImage</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">*</span><span style="color:#a6e22e">awImage</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">exampleDir</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">resourcesDir</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">nextSemVer</span>,
</span></span><span style="display:flex;"><span>	); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;failed to setup framework: %v\n&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><ol start="3">
<li><code>framework.go</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Framework</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">opImage</span>         <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">crImage</span>         <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">awImage</span>         <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">kubeconfig</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">opImage</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">crImage</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">awImage</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">exampleDir</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">resourcesDir</span> <span style="color:#66d9ef">string</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">operatorVersion</span> <span style="color:#a6e22e">semver</span>.<span style="color:#a6e22e">Version</span>,
</span></span><span style="display:flex;"><span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Framework</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">f</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Framework</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">opImage</span>:           <span style="color:#a6e22e">opImage</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">crImage</span>:           <span style="color:#a6e22e">crImage</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">awImage</span>:           <span style="color:#a6e22e">awImage</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Framework</span>) <span style="color:#a6e22e">CreateOrUpdatePrometheusOperator</span>(
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">opImage</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">parts</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">opImage</span>, <span style="color:#e6db74">&#34;:&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">parts</span>) &gt; <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">parts</span>) &lt; <span style="color:#ae81ff">2</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(
</span></span><span style="display:flex;"><span>				<span style="color:#e6db74">&#34;expected operator image &#39;%v&#39; split by colon to include the tag but got &#39;%v&#39;&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">opImage</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">parts</span>,
</span></span><span style="display:flex;"><span>			)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Override operator image used, if specified when running tests.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">deploy</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Image</span> = <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">opImage</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">crImage</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">parts</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">crImage</span>, <span style="color:#e6db74">&#34;:&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">parts</span>) &gt; <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">parts</span>) &lt; <span style="color:#ae81ff">2</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(
</span></span><span style="display:flex;"><span>				<span style="color:#e6db74">&#34;expected config-reloader image &#39;%v&#39; split by colon to include the tag but got &#39;%v&#39;&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">crImage</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">parts</span>,
</span></span><span style="display:flex;"><span>			)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Override Prometheus config reloader image</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">arg</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">deploy</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Args</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Contains</span>(<span style="color:#a6e22e">arg</span>, <span style="color:#e6db74">&#34;--prometheus-config-reloader=&#34;</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">deploy</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Args</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#e6db74">&#34;--prometheus-config-reloader=&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">crImage</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">webhookServerImage</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">awImage</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">parts</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">awImage</span>, <span style="color:#e6db74">&#34;:&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">parts</span>) &gt; <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">parts</span>) &lt; <span style="color:#ae81ff">2</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(
</span></span><span style="display:flex;"><span>				<span style="color:#e6db74">&#34;expected admission-webhook image &#39;%v&#39; split by colon to include the tag but got &#39;%v&#39;&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">awImage</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">parts</span>,
</span></span><span style="display:flex;"><span>			)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Override admission webhook image</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">webhookServerImage</span> = <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">awImage</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Framework</span>) <span style="color:#a6e22e">CreateOrUpdateAdmissionWebhookServer</span>(
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">image</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Override operator image used, if specified when running tests.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">deploy</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Template</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Containers</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Image</span> = <span style="color:#a6e22e">image</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">parts</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">image</span>, <span style="color:#e6db74">&#34;:&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">parts</span>) &gt; <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">parts</span>) &lt; <span style="color:#ae81ff">2</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(
</span></span><span style="display:flex;"><span>				<span style="color:#e6db74">&#34;expected image &#39;%v&#39; split by colon to include the image tag but got &#39;%v&#39;&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">image</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">parts</span>,
</span></span><span style="display:flex;"><span>			)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>That got me further through the E2E tests but still failures:</p>
<ol>
<li><code>alertmanager_test.go:64: alertmanager allns-x-amcreatedeletecluster-s2qk0c-0-e229d475/test failed to become available: context deadline exceeded: expected 3 replicas, got 2</code></li>
<li><code>alertmanager_test.go:308: alertmanager allns-x-amexposingwithkubernetesapi-s2qk8p-0-a86fee0c/test-alertmanager failed to become available: context deadline exceeded: expected 1 replicas, got 0</code></li>
<li><code>alertmanager_test.go:248: client rate limiter Wait returned an error: context deadline exceeded</code></li>
<li><code>alertmanager_test.go:564: alertmanager allns-x-amreloadconfig-s2qkzg-0-de59dc20/reload-config failed to become available: context deadline exceeded: expected Available condition to be 'True', got &quot;False&quot; (reason NoPodReady, &quot;pod alertmanager-reload-config-0: containers with incomplete status: [init-config-reloader]&quot;)</code></li>
<li><code>alertmanager_test.go:354: waiting for service alertmanager-test to become ready timed out: requesting endpoints for service alertmanager-test failed: endpoints &quot;alertmanager-test&quot; not found</code></li>
<li><code>alertmanager_test.go:153: failed to update Alertmanager: alertmanager allns-x-amscaling-s2qlro-0-b131bbf6/test failed to become available: context deadline exceeded: expected 5 replicas, got 0</code></li>
<li><code>alertmanager_test.go:756: waiting for service alertmanager-webhook to become ready timed out: requesting endpoints for service alertmanager-webhook failed: endpoints &quot;alertmanager-webhook&quot; not found</code></li>
<li><code>alertmanager_test.go:2140: Operation cannot be fulfilled on statefulsets.apps &quot;alertmanager-test&quot;: the object has been modified; please apply your changes to the latest version and try again</code></li>
<li><code>alertmanager_test.go:2572: alertmanager allns-x-alertmanagercrd-time-in-milli-seconds-s2qm7o-0-7ca9d0a1/test failed to become available: context deadline exceeded: expected 1 replicas, got 0</code></li>
<li><code>alertmanager_test.go:2572: alertmanager allns-x-alertmanagercrd-time-in-seconds-s2qm83-0-b4484f85/test failed to become available: context deadline exceeded: expected Available condition to be 'True', got &quot;False&quot; (reason NoPodReady, &quot;pod alertmanager-test-0: containers with incomplete status: [init-config-reloader]&quot;)</code></li>
<li><code>alertmanager_test.go:2090: failed to update Alertmanager: alertmanager allns-x-ampreserveuseraddedmetadata-s2qm7o-0-d744e1ad/test failed to become available: context deadline exceeded: expected 2 replicas, got 0</code></li>
</ol>
<p>&amp;c.</p>
<p>So, clearly there&rsquo;s an issue with the the AlertManager configuration. Tomorrow&hellip;</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/prometheus/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Prometheus</a>
   </li>
  
   <li class="list di">
     <a href="/tags/prometheus-operator/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Prometheus-Operator</a>
   </li>
  
   <li class="list di">
     <a href="/tags/scrape-config-url-proxy/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Scrape-Config-Url-Proxy</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/231017/">Prometheus Operator support an auth proxy for Service Discovery</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/231013/">Prometheus Operator `ScrapeConfig`</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/220520/">Prometheus Exporters for fly.io and Vultr</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/220225/">Prometheus HTTP Service Discovery of Cloud Run services</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/211005/">Scraping metrics exposed by Google Cloud Run services that require authentication</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210520/">Consul discovers Google Cloud Run</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210519/">Multiplexing gRPC and HTTP (Prometheus) endpoints with Cloud Run</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210419/">Prometheus Service Discovery w/ Consul for Cloud Run</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210305/">Prometheus VPA Recommendations</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201008/">Deploying a Rust HTTP server to DigitalOcean App Platform</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-dark-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://pretired.dazwilkin.com/" >
    &copy;  (p)retired 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>