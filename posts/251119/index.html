<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Migrating to K3s | (p)retired</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="I&rsquo;m migrating from MicroK8s to K3s. This post explains the installation and (re)configuration steps that I took including verification steps:

Install K3s
Use standalone kubectl and update ${KUBECONFIG} (~/.kube/config)
Install System Upgrade Controller
Install kube-prometheus stack (including the Prometheus Operator)
Disable Grafana and Node Exporter
Tweak default scrapeInterval
Install Tailscale Operator
Create Prometheus and Alertmanager Ingresses
Patch Prometheus and Alertmanager externalUrls
Tweak Prometheus resource to allow any serviceMonitors
Tweak Prometheus resource to allow any proemtheusRules

MicroK8s
Why abandon MicroK8s? I&rsquo;ve been using MicroK8s for several years without issue but, after upgrading to Ubuntu 25.10 which includes a Rust replacement for sudo (and doesn&rsquo;t support sudo -E), I created a problem for myself with MicroK8s and have been unable to restore a working Kubernetes cluster. I took the opportunity to reassess my distribution and have long thought to switch to K3s.">
    <meta name="generator" content="Hugo 0.153.0-DEV">
    
    
    
    
      <meta name="robots" content="index, follow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.cf4aecb341f2e16e80e407465df095cee730d71e19c4574f8e9b28d163dc4225.css" >



  


    

    
    
      

    

    

    <script data-goatcounter="https://pretired.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
 
    <meta property="og:url" content="https://pretired.dazwilkin.com/posts/251119/">
  <meta property="og:site_name" content="(p)retired">
  <meta property="og:title" content="Migrating to K3s">
  <meta property="og:description" content="I’m migrating from MicroK8s to K3s. This post explains the installation and (re)configuration steps that I took including verification steps:
Install K3s Use standalone kubectl and update ${KUBECONFIG} (~/.kube/config) Install System Upgrade Controller Install kube-prometheus stack (including the Prometheus Operator) Disable Grafana and Node Exporter Tweak default scrapeInterval Install Tailscale Operator Create Prometheus and Alertmanager Ingresses Patch Prometheus and Alertmanager externalUrls Tweak Prometheus resource to allow any serviceMonitors Tweak Prometheus resource to allow any proemtheusRules MicroK8s Why abandon MicroK8s? I’ve been using MicroK8s for several years without issue but, after upgrading to Ubuntu 25.10 which includes a Rust replacement for sudo (and doesn’t support sudo -E), I created a problem for myself with MicroK8s and have been unable to restore a working Kubernetes cluster. I took the opportunity to reassess my distribution and have long thought to switch to K3s.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-11-19T00:00:00-08:00">
    <meta property="article:modified_time" content="2025-11-19T00:00:00-08:00">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="MicroK8s">
    <meta property="article:tag" content="K3s">
    <meta property="article:tag" content="Kube-Prometheus">
    <meta property="article:tag" content="Tailscale Operator">

  <meta itemprop="name" content="Migrating to K3s">
  <meta itemprop="description" content="I’m migrating from MicroK8s to K3s. This post explains the installation and (re)configuration steps that I took including verification steps:
Install K3s Use standalone kubectl and update ${KUBECONFIG} (~/.kube/config) Install System Upgrade Controller Install kube-prometheus stack (including the Prometheus Operator) Disable Grafana and Node Exporter Tweak default scrapeInterval Install Tailscale Operator Create Prometheus and Alertmanager Ingresses Patch Prometheus and Alertmanager externalUrls Tweak Prometheus resource to allow any serviceMonitors Tweak Prometheus resource to allow any proemtheusRules MicroK8s Why abandon MicroK8s? I’ve been using MicroK8s for several years without issue but, after upgrading to Ubuntu 25.10 which includes a Rust replacement for sudo (and doesn’t support sudo -E), I created a problem for myself with MicroK8s and have been unable to restore a working Kubernetes cluster. I took the opportunity to reassess my distribution and have long thought to switch to K3s.">
  <meta itemprop="datePublished" content="2025-11-19T00:00:00-08:00">
  <meta itemprop="dateModified" content="2025-11-19T00:00:00-08:00">
  <meta itemprop="wordCount" content="988">
  <meta itemprop="keywords" content="Kubernetes,MicroK8s,K3s,Kube-Prometheus,Tailscale Operator">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Migrating to K3s">
  <meta name="twitter:description" content="I’m migrating from MicroK8s to K3s. This post explains the installation and (re)configuration steps that I took including verification steps:
Install K3s Use standalone kubectl and update ${KUBECONFIG} (~/.kube/config) Install System Upgrade Controller Install kube-prometheus stack (including the Prometheus Operator) Disable Grafana and Node Exporter Tweak default scrapeInterval Install Tailscale Operator Create Prometheus and Alertmanager Ingresses Patch Prometheus and Alertmanager externalUrls Tweak Prometheus resource to allow any serviceMonitors Tweak Prometheus resource to allow any proemtheusRules MicroK8s Why abandon MicroK8s? I’ve been using MicroK8s for several years without issue but, after upgrading to Ubuntu 25.10 which includes a Rust replacement for sudo (and doesn’t support sudo -E), I created a problem for myself with MicroK8s and have been unable to restore a working Kubernetes cluster. I took the opportunity to reassess my distribution and have long thought to switch to K3s.">

      
    
	
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-dark-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        (p)retired
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Migrating to K3s</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2025-11-19T00:00:00-08:00">November 19, 2025</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 5 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 988 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>I&rsquo;m migrating from <a href="https://microk8s.io/">MicroK8s</a> to <a href="https://k3s.io/">K3s</a>. This post explains the installation and (re)configuration steps that I took including verification steps:</p>
<ol>
<li>Install <a href="https://k3s.io">K3s</a></li>
<li>Use standalone <code>kubectl</code> and update <code>${KUBECONFIG}</code> (<code>~/.kube/config</code>)</li>
<li>Install <a href="https://github.com/rancher/system-upgrade-controller">System Upgrade Controller</a></li>
<li>Install <a href=""><code>kube-prometheus</code></a> stack (including the Prometheus Operator)</li>
<li>Disable Grafana and Node Exporter</li>
<li>Tweak default <code>scrapeInterval</code></li>
<li>Install Tailscale Operator</li>
<li>Create Prometheus and Alertmanager Ingresses</li>
<li>Patch Prometheus and Alertmanager <code>externalUrl</code>s</li>
<li>Tweak <code>Prometheus</code> resource to allow <em>any</em> <code>serviceMonitor</code>s</li>
<li>Tweak <code>Prometheus</code> resource to allow <em>any</em> <code>proemtheusRule</code>s</li>
</ol>
<h2 id="microk8s"><a href="https://microk8s.io/">MicroK8s</a></h2>
<p>Why abandon MicroK8s? I&rsquo;ve been using MicroK8s for several years without issue <strong>but</strong>, after upgrading to Ubuntu 25.10 which includes a Rust replacement for <code>sudo</code> (and doesn&rsquo;t support <code>sudo -E</code>), I created a problem for myself with MicroK8s and have been unable to restore a working Kubernetes cluster. I took the opportunity to reassess my distribution and have long thought to switch to K3s.</p>
<p>See this issue on the MicroK8s repo: <a href="https://github.com/canonical/microk8s/issues/5266">https://github.com/canonical/microk8s/issues/5266</a></p>
<p>The solution to revert to the previous <code>sudo</code> is valid but, after doing this, I was able to install MicroK8s but unable to get the cluster to start. I tried this 3 times before giving up.</p>
<p>There is an easy way to swap <code>sudo</code>s, <code>sudo.ws</code> is the non-rust version (<code>1</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo update-alternatives --config sudo
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>There are 2 choices for the alternative sudo (providing /usr/bin/sudo).
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>  Selection    Path                     Priority   Status
</span></span><span style="display:flex;"><span>------------------------------------------------------------
</span></span><span style="display:flex;"><span>* 0            /usr/lib/cargo/bin/sudo   50        auto mode
</span></span><span style="display:flex;"><span>  1            /usr/bin/sudo.ws          40        manual mode
</span></span><span style="display:flex;"><span>  2            /usr/lib/cargo/bin/sudo   50        manual mode
</span></span></code></pre></div><h2 id="k3s"><a href="https://k3s.io">K3s</a></h2>
<p>Installation is straightforward <a href="https://docs.k3s.io/quick-start">Quick Start</a></p>
<p>And you can verify using:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo k3s kubectl get node
</span></span></code></pre></div><h2 id="use-standalone-kubectl-and-update-kubeconfig-kubeconfig">Use standalone <code>kubectl</code> and update <code>${KUBECONFIG}</code> (<code>~/.kube/config</code>)</h2>
<p>I prefer to use a standalone <code>kubectl</code> and, on Linux, it&rsquo;s default config file is <code>~/.kube./config</code></p>
<p>Since I have multiple contexts (servers, users) configured, I manually incorporate the output of:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo more /etc/rancher/k3s/k3s.yaml
</span></span></code></pre></div><h2 id="system-upgrade-controller"><a href="https://github.com/rancher/system-upgrade-controller">System Upgrade Controller</a></h2>
<p>This is useful but I&rsquo;m unfamiliar with it. I took the shortest path to getting something working but will need to revist this. I&rsquo;m only running <code>k3s-server</code> (not <code>k3s-agent</code>) and so could delete the <code>Plan</code> named <code>k3s-agent</code> but, it&rsquo;s predicated on expressions that won&rsquo;t be matched so&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--kustomize<span style="color:#f92672">=</span>github.com/rancher/system-upgrade-controller
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>namespace/system-upgrade created
</span></span><span style="display:flex;"><span>serviceaccount/system-upgrade created
</span></span><span style="display:flex;"><span>role.rbac.authorization.k8s.io/system-upgrade-controller created
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/system-upgrade-controller created
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/system-upgrade-controller-drainer created
</span></span><span style="display:flex;"><span>rolebinding.rbac.authorization.k8s.io/system-upgrade created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/system-upgrade created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/system-upgrade-drainer created
</span></span><span style="display:flex;"><span>configmap/default-controller-env created
</span></span><span style="display:flex;"><span>deployment.apps/system-upgrade-controller created
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--filename<span style="color:#f92672">=</span>https://raw.githubusercontent.com/rancher/system-upgrade-controller/refs/heads/master/examples/k3s-upgrade.yaml
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>plan.upgrade.cattle.io/k3s-server created
</span></span><span style="display:flex;"><span>plan.upgrade.cattle.io/k3s-agent created
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get plans <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--all-namespaces
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>NAMESPACE        NAME         IMAGE                 CHANNEL   VERSION
</span></span><span style="display:flex;"><span>system-upgrade   k3s-agent    rancher/k3s-upgrade             v1.20.11+k3s1
</span></span><span style="display:flex;"><span>system-upgrade   k3s-server   rancher/k3s-upgrade             v1.20.11+k3s1
</span></span></code></pre></div><h2 id="kube-prometheus-stack"><a href="https://github.com/prometheus-operator/kube-prometheus"><code>kube-prometheus</code></a> stack</h2>
<p>You definitely don&rsquo;t just want <a href="https://github.com/prometheus-operator/prometheus-operator">Prometheus Operator</a> but Prometheus itself, Alertmanger, possibly Grafana etc.</p>
<p>The best way to install this is using the Helm chat <a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack"><code>kube-prometheus-stack</code></a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--create-namespace <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>observability
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>level=WARN msg=&#34;unable to find exact version; falling back to closest available version&#34; chart=kube-prometheus-stack requested=&#34;&#34; selected=79.5.0
</span></span><span style="display:flex;"><span>NAME: kube-prometheus-stack
</span></span><span style="display:flex;"><span>LAST DEPLOYED: Wed Nov 19 08:57:47 2025
</span></span><span style="display:flex;"><span>NAMESPACE: default
</span></span><span style="display:flex;"><span>STATUS: deployed
</span></span><span style="display:flex;"><span>REVISION: 1
</span></span><span style="display:flex;"><span>DESCRIPTION: Install complete
</span></span><span style="display:flex;"><span>NOTES:
</span></span><span style="display:flex;"><span>kube-prometheus-stack has been installed. Check its status by running:
</span></span><span style="display:flex;"><span>  kubectl --namespace observability get pods -l &#34;release=kube-prometheus-stack&#34;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>Get Grafana &#39;admin&#39; user password by running:
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>  kubectl --namespace observability get secrets kube-prometheus-stack-grafana -o jsonpath=&#34;{.data.admin-password}&#34; | base64 -d ; echo
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>Access Grafana local instance:
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>  export POD_NAME=$(kubectl --namespace default get pod -l &#34;app.kubernetes.io/name=grafana,app.kubernetes.io/instance=kube-prometheus-stack&#34; -oname)
</span></span><span style="display:flex;"><span>  kubectl --namespace observability port-forward $POD_NAME 3000
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>Get your grafana admin user password by running:
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>  kubectl get secret --namespace observability -l app.kubernetes.io/component=admin-secret -o jsonpath=&#34;{.items[0].data.admin-password}&#34; | base64 --decode ; echo
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>Visit https://github.com/prometheus-operator/kube-prometheus for instructions on how to create &amp; configure Alertmanager and Prometheus instances using the Operator.
</span></span></code></pre></div><h2 id="optional-delete-grafana-and-node-exporter">[Optional] Delete Grafana and Node Exporter</h2>
<p>This is primarily just a resource issue for me but I delete Grafana and Node Exporter:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl delete deployment/kube-prometheus-stack-grafana <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>observability
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl delete daemonset/kube-prometheus-stack-prometheus-node-exporter <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>observability
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl delete service/kube-prometheus-stack-grafana <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>observability
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl delete service/kube-prometheus-stack-prometheus-node-exporter <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>observability
</span></span></code></pre></div><h2 id="tweak-default-scrapeinterval">Tweak default <code>scrapeInterval</code></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get prometheus/kube-prometheus-stack-prometheus <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>observability <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">={</span>.spec.scrapeInterval<span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>30s
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl patch prometheus/kube-prometheus-stack-prometheus <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>observability <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--type<span style="color:#f92672">=</span>merge <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--patch<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{&#34;spec&#34;:{&#34;scrapeInterval&#34;:&#34;120s&#34;}}&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>prometheus.monitoring.coreos.com/kube-prometheus-stack-prometheus patched
</span></span></code></pre></div><h2 id="install-tailscale-operator">Install <a href="https://tailscale.com/kb/1236/kubernetes-operator">Tailscale Operator</a></h2>
<p>If you&rsquo;re using (and you should be) <a href="https://tailscale.com">Tailscale</a>, then the <a href="https://tailscale.com/kb/1236/kubernetes-operator">Tailscale Operator</a> is very useful.</p>
<p>See the <a href="https://tailscale.com/kb/1236/kubernetes-operator">instructions</a> as you&rsquo;ll need to revise your tailnet policy file before installation but then:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>TAILSCALE_OAUTH_CLIENT_ID<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.,,&#34;</span>
</span></span><span style="display:flex;"><span>TAILSCALE_OAUTH_CLIENT_SECRET<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;tskey-client-...&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>helm upgrade <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--install <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>tailscale-operator <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>tailscale/tailscale-operator <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>tailscale <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--create-namespace <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--set-string oauth.clientId<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>TAILSCALE_OAUTH_CLIENT_ID<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--set-string oauth.clientSecret<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>TAILSCALE_OAUTH_CLIENT_SECRET<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--wait
</span></span></code></pre></div><p>Per the documentation, the easiest way to confirm that the Operator is installed correctly is to look for <code>tailscale-operator</code> as one of the machines in the Tailscale admin console (<a href="https://login.tailscale.com/admin/machines%29">https://login.tailscale.com/admin/machines)</a>.</p>
<h2 id="create-prometheus-and-alertmanager-ingresses">Create Prometheus and Alertmanager Ingresses</h2>
<p>You can:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl port-forward service/kube-prometheus-stack-prometheus <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>observability <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>9090:9090
</span></span></code></pre></div><p>And then browse Prometheus Web UI on http://localhost:9090</p>
<p>But, I prefer to create private|internal Ingresses for both:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;prometheus&#34;</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: networking.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Ingress
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: prometheus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  defaultBackend:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: kube-prometheus-stack-prometheus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      port:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        number: 9090
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ingressClassName: tailscale
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tls:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - hosts:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - </span><span style="color:#e6db74">${</span>HOST<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span> | kubectl create <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --filename<span style="color:#f92672">=</span>- <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --namespace<span style="color:#f92672">=</span>observability
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;alertmanager&#34;</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: networking.k8s.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Ingress
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: alertmanager
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  defaultBackend:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    service:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      name: kube-prometheus-stack-alertmanager
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      port:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        number: 9093
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ingressClassName: tailscale
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  tls:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - hosts:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - </span><span style="color:#e6db74">${</span>HOST<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span> | kubectl create <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --filename<span style="color:#f92672">=</span>- <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>    --namespace<span style="color:#f92672">=</span>observability
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> In practice it&rsquo;s much better to create these as files</p>
</blockquote>
<h2 id="patch-prometheus-and-alertmanager-externalurls">Patch Prometheus and Alertmanager <code>externalUrl</code>s</h2>
<p>To ensure that the web UIs correctly reflect the Tailnet names in alerts etc., it&rsquo;s important to patch the <code>Prometheus</code> and <code>Alertmanager</code> resource&rsquo;s <code>externalUrl</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>DOMAIN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;...ts.net` # Your Tailnet
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;prometheus&#34;</span>
</span></span><span style="display:flex;"><span>kubectl patch prometheus/kube-prometheus-stack-prometheus <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>observability <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--type<span style="color:#f92672">=</span>merge <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--patch <span style="color:#e6db74">&#34;{\&#34;spec\&#34;:{\&#34;externalUrl\&#34;:\&#34;https://</span><span style="color:#e6db74">${</span>HOST<span style="color:#e6db74">}</span><span style="color:#e6db74">.</span><span style="color:#e6db74">${</span>DOMAIN<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;}}&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;alertmanager&#34;</span>
</span></span><span style="display:flex;"><span>kubectl patch alertmanager/kube-prometheus-stack-alertmanager <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>observability <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--type<span style="color:#f92672">=</span>merge <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--patch <span style="color:#e6db74">&#34;{\&#34;spec\&#34;:{\&#34;externalUrl\&#34;:\&#34;https://</span><span style="color:#e6db74">${</span>HOST<span style="color:#e6db74">}</span><span style="color:#e6db74">.</span><span style="color:#e6db74">${</span>DOMAIN<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;}}&#34;</span>
</span></span></code></pre></div><h2 id="tweak-prometheus-resource-to-allow-any-servicemonitors">Tweak <code>Prometheus</code> resource to allow <strong>any</strong> <code>serviceMonitor</code>s</h2>
<p>By default the <code>Prometheus</code> resource is restricted to <code>serviceMonitor</code>s labeled with <code>kube-prometheus-stack</code></p>
<p>To allow <code>serviceMonitor</code>s anywhere in the cluster:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get prometheus/kube-prometheus-stack-prometheus <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>observability <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.spec}&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JSON" data-lang="JSON"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;ruleNamespaceSelector&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;matchLabels&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;release&#34;</span>: <span style="color:#e6db74">&#34;kube-prometheus-stack&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;ruleSelector&#34;</span>: {},
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;serviceMonitorNamespaceSelector&#34;</span>: {},
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;serviceMonitorSelector&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;matchLabels&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;release&#34;</span>: <span style="color:#e6db74">&#34;kube-prometheus-stack&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl patch prometheus/kube-prometheus-stack-prometheus <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>observability <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--type<span style="color:#f92672">=</span>json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--patch<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;[{&#34;op&#34;:&#34;replace&#34;,&#34;path&#34;:&#34;/spec/ruleSelector&#34;,&#34;value&#34;:{}}]&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl patch prometheus/kube-prometheus-stack-prometheus <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--namespace<span style="color:#f92672">=</span>observability <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--type<span style="color:#f92672">=</span>json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--patch<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;[{&#34;op&#34;:&#34;replace&#34;,&#34;path&#34;:&#34;/spec/serviceMonitorSelector&#34;,&#34;value&#34;:{}}]&#39;</span>
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> In this case, we must use a JSON Patch in order to replace the object&rsquo;s value with <code>{}</code>.</p>
</blockquote>
<p>That&rsquo;s all for now. This should give you a cluster onto which you can deploy solutions that create <code>ServiceMonitor</code>s and <code>PrometheusRule</code>s resources to be monitored by <code>kube-prometheus</code>.</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/kubernetes/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Kubernetes</a>
   </li>
  
   <li class="list di">
     <a href="/tags/microk8s/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">MicroK8s</a>
   </li>
  
   <li class="list di">
     <a href="/tags/k3s/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">K3s</a>
   </li>
  
   <li class="list di">
     <a href="/tags/kube-prometheus/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Kube-Prometheus</a>
   </li>
  
   <li class="list di">
     <a href="/tags/tailscale-operator/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Tailscale Operator</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/240216/">MicroK8s operability add-on</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210305/">Prometheus VPA Recommendations</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201217/">Kubernetes Device Plugins</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201113/">Akri</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201022/">akri</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/250620/">Tailscale client metrics service discovery to Prometheus</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/240529/">Using Rust to generate Kubernetes CRD</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/240528/">Using Delve to debug Go containers on Kubernetes</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/230215/">Secure (TLS) gRPC services with LKE</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/220603/">Secure (TLS) gRPC services with VKE</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/220602/">Vultr CLI and JSON output</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210222/">Dapr</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210122/">Krustlet on DO Managed Kubernetes</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210108/">Kubernetes cert-manager</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201229/">Kubernetes Webhooks</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-dark-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://pretired.dazwilkin.com/" >
    &copy;  (p)retired 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>