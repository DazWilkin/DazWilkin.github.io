<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Setting up a GCE Instance as an Inlets Exit Node | (p)retired</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Setting up a GCE instance as an Inlets exit node">
    <meta name="generator" content="Hugo 0.148.0-DEV">
    
    
    
    
      <meta name="robots" content="index, follow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.8d048772ae72ab11245a0e296d1f2a36d3e3dd376c6c867394d6cc659c68fc37.css" >




    

    
    
      

    

    

    <script data-goatcounter="https://pretired.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
 
    <meta property="og:url" content="https://pretired.dazwilkin.com/posts/200122/">
  <meta property="og:site_name" content="(p)retired">
  <meta property="og:title" content="Setting up a GCE Instance as an Inlets Exit Node">
  <meta property="og:description" content="Setting up a GCE instance as an Inlets exit node">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-01-22T00:00:00-08:00">
    <meta property="article:modified_time" content="2020-01-22T00:00:00-08:00">
    <meta property="article:tag" content="Inlets">
    <meta property="article:tag" content="Golang">
    <meta property="article:tag" content="GCE">
    <meta property="article:tag" content="GCP">
    <meta property="article:tag" content="Google-Cloud-Platform">
    <meta property="article:tag" content="Compute-Engine">

  <meta itemprop="name" content="Setting up a GCE Instance as an Inlets Exit Node">
  <meta itemprop="description" content="Setting up a GCE instance as an Inlets exit node">
  <meta itemprop="datePublished" content="2020-01-22T00:00:00-08:00">
  <meta itemprop="dateModified" content="2020-01-22T00:00:00-08:00">
  <meta itemprop="wordCount" content="1683">
  <meta itemprop="keywords" content="Inlets,Golang,GCE,GCP,Google-Cloud-Platform,Compute-Engine">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Setting up a GCE Instance as an Inlets Exit Node">
  <meta name="twitter:description" content="Setting up a GCE instance as an Inlets exit node">

      
    
	
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-dark-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        (p)retired
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Setting up a GCE Instance as an Inlets Exit Node</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2020-01-22T00:00:00-08:00">January 22, 2020</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 8 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 1683 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>The prolific <a href="https://blog.alexellis.io/">Alex Ellis</a> has a new project, <a href="https://github.com/inlets/inlets">Inlets</a>.</p>
<p>Here&rsquo;s a quick tutorial using <a href="https://cloud.google.com/">Google Compute Platform&rsquo;s (GCP)</a> <a href="https://cloud.google.com/compute/">Compute Engine (GCE)</a>.</p>
<p><strong>NB</strong> I&rsquo;m using one of Google&rsquo;s <a href="https://cloud.google.com/free/">&ldquo;Always free&rdquo;</a> f1-micro instances <strong>but</strong> you may still pay for network *gress and storage</p>
<h2 id="assumptions">Assumptions</h2>
<p>I&rsquo;m assuming you&rsquo;ve a Google account, have used GCP and have a billing account established, i.e. the following returns at least one billing account:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud beta billing accounts list
</span></span></code></pre></div><p>If you&rsquo;ve only one billing account and it&rsquo;s the one you wish to use, then you can:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>BILLING<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>gcloud beta billing accounts list --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;value(name)&#34;</span><span style="color:#66d9ef">)</span> <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">${</span>BILLING<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>To proceed, you&rsquo;ll need a billing account established and you <strong>may</strong> incur charges even though the <code>f1-micro</code> instance is free.</p>
<h2 id="environment-variables">Environment Variables</h2>
<table>
  <thead>
      <tr>
          <th><code>VARIABLE</code></th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>ACCOUNT</code></td>
          <td>Corresponds to the identity of the service account that owns <code>${INSTANCE}</code></td>
      </tr>
      <tr>
          <td><code>BILLING</code></td>
          <td>A Google Billing Account ID see <code>gcloud beta billing accounts list</code></td>
      </tr>
      <tr>
          <td><code>DIGEST</code></td>
          <td>The SHA-256 hash of an Inlets container image on dockerhub</td>
      </tr>
      <tr>
          <td><code>IP</code></td>
          <td>The Public IP address of <code>${INSTANCE}</code></td>
      </tr>
      <tr>
          <td><code>PORT</code></td>
          <td>The Inlets Exit Node port</td>
      </tr>
      <tr>
          <td><code>PROJECT</code></td>
          <td>A Google Project ID</td>
      </tr>
      <tr>
          <td><code>REMOTE</code></td>
          <td>The Endpoint of the Inlets Exit Node (<code>REMOTE=${IP}:${PORT}</code>)</td>
      </tr>
      <tr>
          <td><code>RULE</code></td>
          <td>A name for the Firewall Rule</td>
      </tr>
      <tr>
          <td><code>TOKEN</code></td>
          <td>A shared secret between the Inlet Exit Node and Host Node(s)</td>
      </tr>
      <tr>
          <td><code>UPSTREAM</code></td>
          <td>The Endpoint of the (local) HTTP server (e.g. <code>localhost:3000</code>)</td>
      </tr>
      <tr>
          <td><code>ZONE</code></td>
          <td>A Compute Engine Zone see <code>gcloud compute zones list --project=${PROJECT}</code></td>
      </tr>
  </tbody>
</table>
<h2 id="create-inlets-exit-node">Create Inlets Exit Node</h2>
<p>Google facilitates creating projects per activity and I encourage you to create a project solely to host the Inlets Exit Node.</p>
<p>The following creates a project (<code>${PROJECT}</code>) and assign it a billing account (<code>${BILLING}</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>PROJECT<span style="color:#f92672">=[[</span>YOUR-PROJECT-ID<span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>BILLING<span style="color:#f92672">=[[</span>YOUR-BILLING-ID<span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gcloud projects create <span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>gcloud beta billing projects link <span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> --billing-account<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>BILLING<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p><strong>NB</strong> See <a href="#environment-variables">Environment Variables</a></p>
<p>For completeness, we&rsquo;ll enable Compute Engine explicitly (though this may be done by default):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud service enable compute.googleapis.com --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>Then we&rsquo;ll create a Compute Engine instance (<code>${INSTANCE}</code>) of type <code>f1-micro</code> in zone (<code>${ZONE}</code>) using Google&rsquo;s Container-Optimized OS which runs Alex&rsquo;s Inlets container (see <a href="https://hub.docker.com/r/inlets/inlets/tags">https://hub.docker.com/r/inlets/inlets/tags</a>)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>INSTANCE<span style="color:#f92672">=[[</span>YOUR-INSTANCE-NAME<span style="color:#f92672">]]</span> <span style="color:#75715e"># Perhaps &#39;exit-node&#39;</span>
</span></span><span style="display:flex;"><span>ZONE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;us-west1-c&#34;</span>               <span style="color:#75715e"># Or you preferred zone</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DIGEST<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sha256:f4e1b7d46c4894930a82cc58ea1d05e987d4d3c9ad1db5b1818cd520c71e8428&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;8090&#34;</span> <span style="color:#75715e"># Or you preferred port</span>
</span></span><span style="display:flex;"><span>TOKEN<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>head --bytes<span style="color:#f92672">=</span><span style="color:#ae81ff">8192</span> /dev/urandom | sha256sum | head --bytes<span style="color:#f92672">=</span>64<span style="color:#66d9ef">)</span> <span style="color:#75715e"># Randomly-generated 64-bit SHA-256 Hash</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gcloud beta compute instances create-with-container <span style="color:#e6db74">${</span>INSTANCE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--zone<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>ZONE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--machine-type<span style="color:#f92672">=</span>f1-micro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--image-family<span style="color:#f92672">=</span>cos-stable <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--image-project<span style="color:#f92672">=</span>cos-cloud <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--boot-disk-size<span style="color:#f92672">=</span>10GB <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--container-image<span style="color:#f92672">=</span>inlets/inlets@<span style="color:#e6db74">${</span>DIGEST<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--container-restart-policy<span style="color:#f92672">=</span>always <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--container-arg<span style="color:#f92672">=</span>server <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--container-arg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--port=</span><span style="color:#e6db74">${</span>PORT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--container-arg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--token=</span><span style="color:#e6db74">${</span>TOKEN<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--labels<span style="color:#f92672">=</span>project<span style="color:#f92672">=</span>inlets,language<span style="color:#f92672">=</span>golang
</span></span></code></pre></div><p><strong>NB</strong> This uses the default GCE service account. It would be even more secure to generate a service account specifically for this instance. In that case, you would need to create the service account and then pass its email address to the above command using <code>--service-account=${ACCOUNT}</code></p>
<p><strong>NB</strong> This container runs the Inlets server using the command <code>server --port=${PORT} --token=${TOKEN}</code></p>
<p>Once this command completes (hopefully successfully), we can grab the instance&rsquo;s Public IP address:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  gcloud compute instances describe <span style="color:#e6db74">${</span>INSTANCE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;value(networkInterfaces[0].accessConfigs[0].natIP)&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --zone<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>ZONE<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span> <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">${</span>IP<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>Then we will create a firewall rule (<code>${RULE}</code>), for this instance (<code>${INSTANCE}</code>) only, for the port that it uses (<code>{$PORT}</code>) and we&rsquo;ll limit this firewall by the instance&rsquo;s identity (<code>${ACCOUNT}</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>RULE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inlets-allow-</span><span style="color:#e6db74">${</span>PORT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;projects/</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span><span style="color:#e6db74">/serviceAccounts/[0-9]{12}-compute@developer.gserviceaccount.com&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ACCOUNT<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  gcloud iam service-accounts list <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --filter<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;name ~\&#34;</span><span style="color:#e6db74">${</span>NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;value(email)&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gcloud compute firewall-rules create <span style="color:#e6db74">${</span>RULE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--direction<span style="color:#f92672">=</span>INGRESS <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--action<span style="color:#f92672">=</span>ALLOW <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--rules<span style="color:#f92672">=</span>tcp:<span style="color:#e6db74">${</span>PORT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--source-ranges<span style="color:#f92672">=</span>0.0.0.0/0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--target-service-accounts<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>ACCOUNT<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p><strong>NB</strong> <code>${ACCOUNT}</code> is determined by filtering the project&rsquo;s (<code>${PROJECT}</code>) service accounts by the Compute Engine default account. If you created a non-default service account for this instance, you must use that account&rsquo;s email address here.</p>
<p>We now have a Compute Engine instance running an Exit Node. This includes the Inlets container running the server. We have created a firewall rule that permits access to it. The next step is to run a local HTTP server and the Inlets client on our Host (local) Node.</p>
<h2 id="create-inlets-host-node">Create Inlets Host Node</h2>
<p>You will need some HTTP server running (preferably) on your local machine.</p>
<p>If you want to test an arbitrary HTTP server, Alex provides <a href="https://github.com/alexellis/hash-browns"><code>hash-browns</code></a></p>
<p>You may clone and run the binary, or use Docker:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get -u github.com/alexellis/hash-browns
</span></span><span style="display:flex;"><span>port<span style="color:#f92672">=</span><span style="color:#ae81ff">3000</span> go run github.com/alexellis/hash-browns
</span></span></code></pre></div><p>Or:</p>
<pre tabindex="0"><code>docker run \
--interactive --tty \
--publish=3000:3000 \
--env=port=3000 \
alexellis2/hashbrowns:1.2.0
</code></pre><p><strong>NB</strong> In both cases, we&rsquo;re running this server on port <code>:3000</code>, you may change as you wish</p>
<p>Now we can run the Inlets client:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>REMOTE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>IP<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">${</span>PORT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>UPSTREAM<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;localhost:3000&#34;</span> <span style="color:#75715e"># Your local HTTP server&#39;s endpoint</span>
</span></span><span style="display:flex;"><span>docker run <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--interactive --tty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--net<span style="color:#f92672">=</span>host <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--env<span style="color:#f92672">=</span>REMOTE<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REMOTE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--env<span style="color:#f92672">=</span>TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>TOKEN<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>inlets/inlets@<span style="color:#e6db74">${</span>DIGEST<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>client <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--remote<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REMOTE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--upstream<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>UPSTREAM<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--token<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>TOKEN<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p><strong>NB</strong> This container runs the Inlets client using the command <code>client --remote=${REMOTE} --upstream=${UPSTREAM} --token=${TOKEN}</code></p>
<h2 id="test">Test</h2>
<pre tabindex="0"><code>TEST=&#34;Hello Freddie!&#34;

curl --data &#34;${TEST}&#34; http://${REMOTE}/hash
1c68dba28d1ee45b27c61fbaf2fa0790b93d7b6050a4fcf532b667fc0654d923

printf ${TEST} \
| sha256sum \
| head --bytes=64
1c68dba28d1ee45b27c61fbaf2fa0790b93d7b6050a4fcf532b667fc0654d923
</code></pre><h2 id="debugging">Debugging</h2>
<p>You may SSH into the instance (<code>${INSTANCE}</code>) using:</p>
<pre tabindex="0"><code>gcloud compute ssh ${INSTANCE} \
--project=${PROJECT} \
--zone=${ZONE}
</code></pre><p>Then you can interact with Docker as you would elsewhere:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker container ls  --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{{.ID}}\t{{.Image}}&#34;</span>
</span></span><span style="display:flex;"><span>CONTAINER ID        IMAGE
</span></span><span style="display:flex;"><span>a308bd0fb870        inlets/inlets
</span></span><span style="display:flex;"><span>a5bbfc4e8306        gcr.io/stackdriver-agents/stackdriver-logging-agent:0.2-1.5.33-1-1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker logs a308
</span></span><span style="display:flex;"><span>2020/01/22 21:55:05 Welcome to inlets.dev! Find out more at https://github.com/inlets/inlets
</span></span><span style="display:flex;"><span>2020/01/22 21:55:05 Starting server - version 2.6.3-14-g8fd1007
</span></span><span style="display:flex;"><span>2020/01/22 21:55:05 Server token: <span style="color:#e6db74">&#34;[[REDACTED]]&#34;</span>
</span></span><span style="display:flex;"><span>2020/01/22 21:55:05 Control Plane Listening on :8090
</span></span><span style="display:flex;"><span>2020/01/22 21:55:05 Data Plane Listening on :8090
</span></span><span style="display:flex;"><span>time<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;2020-01-22T21:55:15Z&#34;</span> level<span style="color:#f92672">=</span>info msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Handling backend connection request [841f86fbaf5848ff85dabed2f67aec69]&#34;</span>
</span></span><span style="display:flex;"><span>2020/01/22 21:56:58 <span style="color:#f92672">[</span>e13ee5823c634a798ca25c120c5581d5<span style="color:#f92672">]</span> proxy 35.230.74.70:8090 POST /hash
</span></span><span style="display:flex;"><span>2020/01/22 21:57:00 <span style="color:#f92672">[</span>97b54d40cbdf4ba2ad1c96be7ab039ba<span style="color:#f92672">]</span> proxy 35.230.74.70:8090 POST /hash
</span></span><span style="display:flex;"><span>2020/01/22 21:57:20 <span style="color:#f92672">[</span>0f6de151cbeb4bdcb0a74b0b397e88cb<span style="color:#f92672">]</span> proxy 35.230.74.70:8090 POST /hash
</span></span><span style="display:flex;"><span>2020/01/22 21:57:43 <span style="color:#f92672">[</span>671174838dfd48e584f25e07f1b771d6<span style="color:#f92672">]</span> proxy 35.230.74.70:8090 POST /hash
</span></span></code></pre></div><p>To list the containers, you can pass the <code>docker container ls</code> command to SSH through gcloud:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud compute ssh <span style="color:#e6db74">${</span>INSTANCE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--command<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;docker container ls  --format=\&#34;{{.ID}}\t{{.Image}}\&#34;&#34;</span>
</span></span><span style="display:flex;"><span>No zone specified. Using zone <span style="color:#f92672">[</span>us-west1-c<span style="color:#f92672">]</span> <span style="color:#66d9ef">for</span> instance: <span style="color:#f92672">[</span>coffee<span style="color:#f92672">]</span>.
</span></span><span style="display:flex;"><span>CONTAINER ID        IMAGE
</span></span><span style="display:flex;"><span>a308bd0fb870        inlets/inlets
</span></span><span style="display:flex;"><span>a5bbfc4e8306        gcr.io/stackdriver-agents/stackdriver-logging-agent:0.2-1.5.33-1-1
</span></span></code></pre></div><p><strong>NB</strong> Container-Optimized OS runs Google&rsquo;s <a href="https://cloud.google.com/stackdriver/">Stackdriver</a> Logging|Monitoring service in the 2nd container</p>
<p>Since Stackdriver&rsquo;s available, we can pull the container&rsquo;s logs directly using gcloud:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud logging read <span style="color:#e6db74">&#34;resource.type=\&#34;gce_instance\&#34; jsonPayload.container_id:\&#34;a308bd0fb870\&#34;&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--order<span style="color:#f92672">=</span>asc <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--format<span style="color:#f92672">=</span>json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| jq -r <span style="color:#e6db74">&#39;.[].jsonPayload.message|rtrimstr(&#34;\n&#34;)&#39;</span>
</span></span><span style="display:flex;"><span>2020/01/22 21:55:05 Welcome to inlets.dev! Find out more at https://github.com/inlets/inlets
</span></span><span style="display:flex;"><span>2020/01/22 21:55:05 Starting server - version 2.6.3-14-g8fd1007
</span></span><span style="display:flex;"><span>2020/01/22 21:55:05 Server token: <span style="color:#e6db74">&#34;[[REDACTED]]&#34;</span>
</span></span><span style="display:flex;"><span>2020/01/22 21:55:05 Control Plane Listening on :8090
</span></span><span style="display:flex;"><span>2020/01/22 21:55:05 Data Plane Listening on :8090
</span></span><span style="display:flex;"><span>time<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;2020-01-22T21:55:15Z&#34;</span> level<span style="color:#f92672">=</span>info msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Handling backend connection request [841f86fbaf5848ff85dabed2f67aec69]&#34;</span>
</span></span><span style="display:flex;"><span>2020/01/22 21:56:58 <span style="color:#f92672">[</span>e13ee5823c634a798ca25c120c5581d5<span style="color:#f92672">]</span> proxy 35.230.74.70:8090 POST /hash
</span></span><span style="display:flex;"><span>2020/01/22 21:57:00 <span style="color:#f92672">[</span>97b54d40cbdf4ba2ad1c96be7ab039ba<span style="color:#f92672">]</span> proxy 35.230.74.70:8090 POST /hash
</span></span><span style="display:flex;"><span>2020/01/22 21:57:20 <span style="color:#f92672">[</span>0f6de151cbeb4bdcb0a74b0b397e88cb<span style="color:#f92672">]</span> proxy 35.230.74.70:8090 POST /hash
</span></span><span style="display:flex;"><span>2020/01/22 21:57:43 <span style="color:#f92672">[</span>671174838dfd48e584f25e07f1b771d6<span style="color:#f92672">]</span> proxy 35.230.74.70:8090 POST /hash
</span></span></code></pre></div><p><strong>NB</strong> The filter&rsquo;s <code>container_id</code> is followed by a colon (<code>:</code>) meaning &ldquo;has&rdquo; (contains) because we only have part of the (short-form) container ID</p>
<p>The logs (for the same period) should match ;-)</p>
<h2 id="tear-down">Tear-down</h2>
<p>If you created a project specifically to test this out, you can delete <strong>everything</strong> (irrecoverably) using:</p>
<pre tabindex="0"><code>gcloud projects delete ${PROJECT} --quiet
</code></pre><p><strong>NB</strong> The above deletes all the resoures contained within the project</p>
<p>Alternatively, you may delete the resources individually:</p>
<pre tabindex="0"><code>gcloud compute firewall-rules delete ${RULE} \
--project=${PROJECT}

gcloud compute instances delete ${INSTANCE} \
--project=${PROJECT} \
--zone=${ZONE}
</code></pre><p>That&rsquo;s all!</p>
<h2 id="appendices">Appendices</h2>
<h3 id="google-secret-manager">Google <a href="https://cloud.google.com/secret-manager/">Secret Manager</a></h3>
<p>Yesterday, Google announced <a href="https://cloud.google.com/secret-manager/">Secret Manager</a> which provides a way to more securely manage secrets. In this tutorial, the Inlets server and client share a secret (`${TOKEN}). We can use Secret Manager to host this secret for us:</p>
<p>Enable the service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud services enable secretmanager.googleapis.com <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>Then persist the token:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SECRET<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;inlets-token&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>printf <span style="color:#e6db74">&#34;%s&#34;</span> <span style="color:#e6db74">${</span>TOKEN<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| gcloud beta secrets create <span style="color:#e6db74">${</span>SECRET<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--data-file<span style="color:#f92672">=</span>- <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--replication-policy<span style="color:#f92672">=</span>automatic
</span></span></code></pre></div><p><strong>NB</strong> Using <code>printf</code> rather than <code>echo</code> avoids appending a newline (<code>\n</code>) to the secret</p>
<p>Then, when it&rsquo;s needed, we may replace getting the value (i.e. <code>${TOKEN}</code>) with <code>$(gcloud beta secrets versions access 1 --secret=${SECRET} --project=${PROJECT})</code>), i.e.:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud beta compute instances create-with-container <span style="color:#e6db74">${</span>INSTANCE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--zone<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>ZONE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--machine-type<span style="color:#f92672">=</span>f1-micro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--image-family<span style="color:#f92672">=</span>cos-stable <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--image-project<span style="color:#f92672">=</span>cos-cloud <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--boot-disk-size<span style="color:#f92672">=</span>10GB <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--container-image<span style="color:#f92672">=</span>inlets/inlets@<span style="color:#e6db74">${</span>DIGEST<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--container-restart-policy<span style="color:#f92672">=</span>always <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--container-arg<span style="color:#f92672">=</span>server <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--container-arg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--port=</span><span style="color:#e6db74">${</span>PORT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--container-arg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--token=</span><span style="color:#66d9ef">$(</span>gcloud beta secrets versions access <span style="color:#ae81ff">1</span> --secret<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>SECRET<span style="color:#e6db74">}</span> --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--labels<span style="color:#f92672">=</span>project<span style="color:#f92672">=</span>inlets,language<span style="color:#f92672">=</span>golang
</span></span></code></pre></div><p>and:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>REMOTE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>IP<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">${</span>PORT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>UPSTREAM<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;localhost:3000&#34;</span> <span style="color:#75715e"># Your local HTTP server&#39;s endpoint</span>
</span></span><span style="display:flex;"><span>docker run <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--interactive --tty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--net<span style="color:#f92672">=</span>host <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--env<span style="color:#f92672">=</span>REMOTE<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REMOTE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--env<span style="color:#f92672">=</span>TOKEN<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>gcloud beta secrets versions access <span style="color:#ae81ff">1</span> --secret<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>SECRET<span style="color:#e6db74">}</span> --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>inlets/inlets@<span style="color:#e6db74">${</span>DIGEST<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>client <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--remote<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REMOTE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--upstream<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>UPSTREAM<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--token<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>TOKEN<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>What benefits does this provide? Access to the secret is controlled by IAM and passing the secret is done implicitly.</p>
<h3 id="google-cloud-run">Google <a href="https://cloud.google.com/run/">Cloud Run</a></h3>
<p>I was curious to deploy the Inlets server to [Cloud Run] and use this as the Exit Node <span style="color:red"><strong>but</strong> it is <strong>not</strong> possible because Cloud Run does <a href="https://cloud.google.com/run/docs/issues#grpc_websocket">not permit HTTP streaming</a> and this is required by the WebSocket protocol.</span></p>
<p><strong>NB</strong> The following does not currently work!</p>
<p>Enable <a href="https://cloud.google.com/run/">Cloud Run</a> and <a href="https://cloud.google.com/container-registry/">Container Registry (GCR)</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> SERVICE in <span style="color:#e6db74">&#34;run&#34;</span> <span style="color:#e6db74">&#34;containerregistry&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  gcloud services enable <span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span>.googleapis.com <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p><strong>NB</strong> You can run <code>gcloud services enable ...   --async ...</code> but you&rsquo;ll need to await completion</p>
<p>Pull the Inlet&rsquo;s container image, retag it and push it to GCR:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker pull docker.io/inlets/inlets@<span style="color:#e6db74">${</span>DIGEST<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>docker tag docker.io/inlets/inlets@<span style="color:#e6db74">${</span>DIGEST<span style="color:#e6db74">}</span> gcr.io/<span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>/inlets <span style="color:#75715e"># NB this will be untagged</span>
</span></span><span style="display:flex;"><span>docker push gcr.io/<span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>/inlets                                  <span style="color:#75715e"># NB this will be tagged `latest` but we&#39;ll reference it by SHA256</span>
</span></span></code></pre></div><p><strong>NB</strong> The above is a little messy because we&rsquo;re trying to use digests instead of tags; there may be a better way to do this?</p>
<p>Then deploy (remember this will succeed but you&rsquo;ll be unable to use it with WebSocket):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SERVICE<span style="color:#f92672">=</span>inlets
</span></span><span style="display:flex;"><span>gcloud beta run deploy <span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--image<span style="color:#f92672">=</span>gcr.io/<span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>/inlets@<span style="color:#e6db74">${</span>DIGEST<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--args<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;server&#34;</span>,<span style="color:#e6db74">&#34;--port=</span><span style="color:#e6db74">${</span>PORT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">&#34;--token=</span><span style="color:#e6db74">${</span>TOKEN<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--allow-unauthenticated
</span></span></code></pre></div><p><strong>NB</strong> Be careful and use <code>gcloud beta run ...</code>, I discovered that <code>gcloud run ...</code> requires the addition of <code>--command=&quot;/usr/bin/inlets&quot;</code> even though this should not be required because the entrypoint is correctly defined by the container.</p>
<p>Then:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud logging read <span style="color:#e6db74">&#34;resource.type=\&#34;cloud_run_revision\&#34; resource.labels.service_name=\&#34;</span><span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--order<span style="color:#f92672">=</span>asc <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--format<span style="color:#f92672">=</span>json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| jq -r .<span style="color:#f92672">[]</span>.textPayload
</span></span><span style="display:flex;"><span>2020/01/23 18:42:32 Welcome to inlets.dev! Find out more at https://github.com/inlets/inlets
</span></span><span style="display:flex;"><span>2020/01/23 18:42:32 Starting server - version 2.6.3-14-g8fd1007
</span></span><span style="display:flex;"><span>2020/01/23 18:42:32 Server token: <span style="color:#e6db74">&#34;[[REDACTED]]&#34;</span>
</span></span><span style="display:flex;"><span>2020/01/23 18:42:32 Control Plane Listening on :8080
</span></span><span style="display:flex;"><span>2020/01/23 18:42:32 Data Plane Listening on :8080
</span></span></code></pre></div><p>And, if this were working (which it does not!), you could grab the endpoint using either:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud beta run services describe <span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;value(status.address.url)&#34;</span>
</span></span></code></pre></div><p>Or:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud beta run services describe <span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| jq -r .status.address.url
</span></span></code></pre></div><p>You could then plug this (TLS!) endpoint and the port (<code>${PORT}</code>) in as before.</p>
<p>When you&rsquo;re done, you may delete the Cloud Run service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud beta run services delete <span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--quiet
</span></span></code></pre></div><p>Or delete the project entirely as before.</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/inlets/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Inlets</a>
   </li>
  
   <li class="list di">
     <a href="/tags/golang/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Golang</a>
   </li>
  
   <li class="list di">
     <a href="/tags/gce/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">GCE</a>
   </li>
  
   <li class="list di">
     <a href="/tags/gcp/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">GCP</a>
   </li>
  
   <li class="list di">
     <a href="/tags/google-cloud-platform/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Google-Cloud-Platform</a>
   </li>
  
   <li class="list di">
     <a href="/tags/compute-engine/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Compute-Engine</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/191220/">Google Cloud Platform (GCP) Exporter</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200110/">Google Fit</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200107/">Google Home Exporter</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/191218/">Linode Prometheus Exporter</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190926/">PyPi Transparency</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190924/">Kubernetes Engine and Free Tier</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190918/">Cloud Functions Simple(st) HTTP Multi-host Proxy</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190917/">Cloud Functions Simple(st) HTTP Proxy</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190907/">pypi-transparency</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-dark-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://pretired.dazwilkin.com/" >
    &copy;  (p)retired 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>