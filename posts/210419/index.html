<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  
  <title>Prometheus Service Discovery w/ Consul for Cloud Run | (p)retired</title>
  <meta name="viewport" content="width=device-width,minimum-scale=1">
  <meta name="description"
    content="Configuring Prometheus to use service discovery with Consul to find Cloud Run services">
  <meta name="generator" content="Hugo 0.89.2" />
  
  
  <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
  

  
<link rel="stylesheet" href="/ananke/css/main.min.abe0b1c07d5e33565b0f9b998a7b1b5228b709f36af363e2766bc8035f2237b7.css" >




  
  

  

  

  <link href="https://us-central1-webmention.cloudfunctions.net/webmention" rel="webmention" />

  <meta property="og:title" content="Prometheus Service Discovery w/ Consul for Cloud Run" />
<meta property="og:description" content="Configuring Prometheus to use service discovery with Consul to find Cloud Run services" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pretired.dazwilkin.com/posts/210419/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-19T00:00:09-07:00" />
<meta property="article:modified_time" content="2021-04-19T00:00:09-07:00" />

<meta itemprop="name" content="Prometheus Service Discovery w/ Consul for Cloud Run">
<meta itemprop="description" content="Configuring Prometheus to use service discovery with Consul to find Cloud Run services"><meta itemprop="datePublished" content="2021-04-19T00:00:09-07:00" />
<meta itemprop="dateModified" content="2021-04-19T00:00:09-07:00" />
<meta itemprop="wordCount" content="1340">
<meta itemprop="keywords" content="prometheus,consul,coredns,service-discovery,cloud-run," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Prometheus Service Discovery w/ Consul for Cloud Run"/>
<meta name="twitter:description" content="Configuring Prometheus to use service discovery with Consul to find Cloud Run services"/>

  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-67DZX7M0D1"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-67DZX7M0D1', { 'anonymize_ip': false });
}
</script>

  
  
</head>

<body class="ma0 avenir bg-near-white production">

  
   
  

  <header>
    <div class="bg-dark-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        (p)retired
      
    </a>
    <div class="flex-l items-center">
      

      
      


<a href="https://stackoverflow.com/users/609290/dazwilkin" target="_blank" class="link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Stack Overflow link" rel="noopener" aria-label="follow on Stack Overflow——Opens in a new window">
  <svg height="32px" 
    style="enable-background:new 0 0 67 67;"
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 24 24"
    width="32px"
>
    <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm.869 5.903l3.114 4.567-.975.665-3.115-4.567.976-.665zm-2.812 2.585l4.84 2.838-.6 1.017-4.842-2.838.602-1.017zm-1.276 2.724l5.413 1.521-.291 1.077-5.428-1.458.306-1.14zm-.588 2.461l5.687.569-.103 1.12-5.691-.513.107-1.176zm-.169 2.16h5.835v1.167h-5.835v-1.167zm7.976 3.167h-10v-6h1v5h8v-5h1v6zm.195-8.602l-.945-5.446 1.162-.202.947 5.446-1.164.202z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>






<a href="https://www.linkedin.com/in/dazwilkin/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://github.com/DazWilkin" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>




<a href="https://medium.com/@DazWilkin" target="_blank" class="link-transition medium link dib z-999 pt3 pt0-l mr1" title="Medium link" rel="noopener" aria-label="follow on Medium——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 170 170;" version="1.1" viewBox="0 0 170 170" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M46.5340803,65.2157554 C46.6968378,63.6076572 46.0836,62.018231 44.8828198,60.93592 L32.6512605,46.2010582 L32.6512605,44 L70.6302521,44 L99.9859944,108.380952 L125.794585,44 L162,44 L162,46.2010582 L151.542017,56.2281011 C150.640424,56.9153477 150.193188,58.0448862 150.380019,59.1628454 L150.380019,132.837155 C150.193188,133.955114 150.640424,135.084652 151.542017,135.771899 L161.755369,145.798942 L161.755369,148 L110.38282,148 L110.38282,145.798942 L120.963119,135.527337 C122.002801,134.487948 122.002801,134.182246 122.002801,132.592593 L122.002801,73.0417402 L92.585901,147.755438 L88.6106443,147.755438 L54.3622782,73.0417402 L54.3622782,123.115814 C54.0767278,125.221069 54.7759199,127.3406 56.2581699,128.863022 L70.0186741,145.55438 L70.0186741,147.755438 L31,147.755438 L31,145.55438 L44.7605042,128.863022 C46.2319621,127.338076 46.8903838,125.204485 46.5340803,123.115814 L46.5340803,65.2157554 Z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>





    </div>
  </div>
</nav>

    </div>
  </header>



  <main class="pb7" role="main">
    
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://pretired.dazwilkin.com/posts/210419/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://pretired.dazwilkin.com/posts/210419/&amp;text=Prometheus%20Service%20Discovery%20w/%20Consul%20for%20Cloud%20Run" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://pretired.dazwilkin.com/posts/210419/&amp;title=Prometheus%20Service%20Discovery%20w/%20Consul%20for%20Cloud%20Run" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">Prometheus Service Discovery w/ Consul for Cloud Run</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2021-04-19T00:00:09-07:00">April 19, 2021</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 7 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 1340 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>I&rsquo;m working on a project that will programmatically create Google <a href="https://cloud.google.com/run">Cloud Run</a> services and I want to be able to dynamically discover these services using Prometheus.</p>
<p>This is one solution.</p>
<blockquote>
<p><strong>NOTE</strong> Google Cloud Run is the service I&rsquo;m using, but the principle described herein applies to any runtime service that you&rsquo;d wish to use.</p>
</blockquote>
<p>Why is this challenging? IIUC, it&rsquo;s primarily because Prometheus has a limited set of plugins for service discovery, see the sections that include <code>_sd_</code> in Prometheus <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">Configuration</a> documentation. Unfortunately, Cloud Run is not explicitly supported. The alternative appears to be to use file-based discovery but this seems &lsquo;challenging&rsquo;; it requires, for example, reloading Prometheus on file changes.</p>
<p>After contemplating the alternatives, I started by using <a href="https://coredns.io">CoreDNS</a> and <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#dns_sd_config"><code>dns_sd_config</code></a> but, after struggling with <code>resolv.conf</code> and using the 3rd-part <code>records</code> plugin, I gave up.</p>
<p>I&rsquo;ve not used <a href="https://www.consul.io/">Consul</a> extensively but, like many, have a high opinion of <a href="https://www.hashicorp.com/">HashiCorp</a> and was not surprised to find Consul very easy to use.</p>
<p>There are a few steps to test this all using Docker Compose. Fan as I am of Kubernetes, I admit that I prefer the ease of <code>docker-compose.yml</code> for prototyping:</p>
<ol>
<li>Create a <code>docker-compose.yml</code> file</li>
<li>Create a <code>prometheus.yml</code> file</li>
<li>Create Prometheus Graphs</li>
</ol>
<p>Here&rsquo;s my <code>docker-compose.yml</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3&#34;</span>

<span style="color:#f92672">services</span>:
  <span style="color:#f92672">cadvisor</span>:
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gcr.io/google-containers/cadvisor:v0.36.0</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#e6db74">&#34;/:/rootfs:ro&#34;</span>
      - <span style="color:#e6db74">&#34;/var/run:/var/run:rw&#34;</span>
      - <span style="color:#e6db74">&#34;/sys:/sys:ro&#34;</span>
      <span style="color:#75715e"># Default location</span>
      <span style="color:#75715e"># - &#34;/var/lib/docker/:/var/lib/docker:ro&#34;</span>
      <span style="color:#75715e"># Snap location</span>
      <span style="color:#75715e"># - &#34;/var/snap/docker/current:/var/lib/docker:ro&#34;</span>
    <span style="color:#f92672">expose</span>:
      - <span style="color:#e6db74">&#34;8080&#34;</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#ae81ff">8089</span>:<span style="color:#ae81ff">8080</span>

  <span style="color:#f92672">consul</span>:
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">consul:1.10.0-beta</span>
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">consul</span>
    <span style="color:#f92672">expose</span>:
    - <span style="color:#e6db74">&#34;8500&#34;</span> <span style="color:#75715e"># HTTP API|UI</span>
    <span style="color:#f92672">ports</span>:
    <span style="color:#75715e"># - 8400:8400</span>
    - <span style="color:#ae81ff">8500</span>:<span style="color:#ae81ff">8500</span><span style="color:#ae81ff">/tcp</span>
    - <span style="color:#ae81ff">8600</span>:<span style="color:#ae81ff">8600</span><span style="color:#ae81ff">/udp</span>

  <span style="color:#f92672">prometheus</span>:
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
    <span style="color:#f92672">depends_on</span>:
      - <span style="color:#ae81ff">consul</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">prom/prometheus:v2.26.0</span>
    <span style="color:#f92672">command</span>:
      - --<span style="color:#ae81ff">config.file=/etc/prometheus/prometheus.yml</span>
      - --<span style="color:#ae81ff">web.enable-lifecycle</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#ae81ff">${PWD}/prometheus.yml:/etc/prometheus/prometheus.yml</span>
    <span style="color:#f92672">expose</span>:
      - <span style="color:#e6db74">&#34;9090&#34;</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#ae81ff">9099</span>:<span style="color:#ae81ff">9090</span>

  <span style="color:#f92672">node-exporter-01</span>:
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">prom/node-exporter:v1.1.2</span>
    <span style="color:#f92672">ports</span>:
    - <span style="color:#ae81ff">9101</span>:<span style="color:#ae81ff">9100</span><span style="color:#ae81ff">/tcp</span> <span style="color:#75715e"># Prometheus Metrics (/metrics)</span>

  <span style="color:#f92672">node-exporter-02</span>:
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">prom/node-exporter:v1.1.2</span>
    <span style="color:#f92672">ports</span>:
    - <span style="color:#ae81ff">9102</span>:<span style="color:#ae81ff">9100</span><span style="color:#ae81ff">/tcp</span> <span style="color:#75715e"># Prometheus Metrics (/metrics)</span>

  <span style="color:#f92672">busybox</span>:
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">radial/busyboxplus:curl</span>
    <span style="color:#f92672">command</span>:
    - <span style="color:#ae81ff">ash</span>
    - -<span style="color:#ae81ff">c</span>
    - |<span style="color:#e6db74">
</span><span style="color:#e6db74">      while true
</span><span style="color:#e6db74">      do
</span><span style="color:#e6db74">        sleep 15
</span><span style="color:#e6db74">      done</span>      
</code></pre></div><blockquote>
<p><strong>NOTES</strong><!-- raw HTML omitted -->If you include <code>cadvisor</code>, choose the correct (either <code>default</code> or <code>snap</code>) configuration for your Docker installation; I use the Docker Snap.<!-- raw HTML omitted -->The <code>consul</code> service only needs the DNS (UDP) ports exposed to the host (<code>8600:8600/udp</code>) for testing.<!-- raw HTML omitted -->There are two (of the same) <code>node-exporter-xx</code> services running.</p>
</blockquote>
<p>The <code>prometheus</code> service requires <code>prometheus.yml</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML"><span style="color:#f92672">global</span>:
  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">1m</span>
  <span style="color:#f92672">evaluation_interval</span>: <span style="color:#ae81ff">1m</span>

<span style="color:#f92672">scrape_configs</span>:
  <span style="color:#75715e"># Consul</span>
  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">consul</span>
    <span style="color:#f92672">consul_sd_configs</span>:
      - <span style="color:#f92672">server</span>: <span style="color:#ae81ff">consul:8500</span>
        <span style="color:#f92672">datacenter</span>: <span style="color:#ae81ff">dc1</span>
        <span style="color:#f92672">tags</span>:
        - <span style="color:#ae81ff">foo</span>

  <span style="color:#75715e"># Self</span>
  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;prometheus-server&#34;</span>
    <span style="color:#f92672">static_configs</span>:
      - <span style="color:#f92672">targets</span>:
          - <span style="color:#e6db74">&#34;localhost:9090&#34;</span>

  <span style="color:#75715e"># cAdvisor exports metrics for *all* containers running on this host</span>
  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">cadvisor</span>
    <span style="color:#f92672">static_configs</span>:
      - <span style="color:#f92672">targets</span>:
          - <span style="color:#e6db74">&#34;cadvisor:8080&#34;</span>
</code></pre></div><blockquote>
<p><strong>NOTES</strong> The only <code>job_name</code> that&rsquo;s required here is <code>consul</code>. In the following, sections, I&rsquo;ve excluded the other two jobs for clarity.<!-- raw HTML omitted -->The <code>server</code> entry <code>consul:8500</code> refers to the <code>docker-compose</code> service called <code>consul</code> that exposes port <code>8500</code>.</p>
</blockquote>
<p>After running <code>docker-compose up</code>, let&rsquo;s immediately browse to Prometheus' Service Discovery page:</p>
<p><code>http://localhost:9099/service-discovery</code></p>
<p><img src="/images/210419.prometheus.sd.empty.png" alt="Prometheus Service Discovery: Empty"></p>
<p>It&rsquo;s empty :-(</p>
<p>This is because (hopefully!), there are no services called <code>node-exporter-XX</code> in Consul. Let&rsquo;s confirm that and then define them:</p>
<p>Consul includes a clear UI: http://localhost:8500/ui</p>
<p><img src="/images/210419.consul.services.empty.png" alt="Consul: Services: Empty"></p>
<p>As you can see, with the exception of the default <code>consul</code> service, there are (as expected) no <code>node-exporter-xx</code> services. Let&rsquo;s add these using Consul&rsquo;s HTTP API:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">REGISTER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://127.0.0.1:8500/v1/agent/service/register&#34;</span>

<span style="color:#66d9ef">for</span> XX in <span style="color:#f92672">{</span>01..03<span style="color:#f92672">}</span>
<span style="color:#66d9ef">do</span>
  curl <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --request PUT <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">${</span>REGISTER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --data <span style="color:#e6db74">&#34;{
</span><span style="color:#e6db74">    \&#34;name\&#34;: \&#34;node-exporter-</span><span style="color:#e6db74">${</span>XX<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;,
</span><span style="color:#e6db74">    \&#34;port\&#34;:9100,
</span><span style="color:#e6db74">    \&#34;tags\&#34;:[\&#34;foo\&#34;, \&#34;bar\&#34;],
</span><span style="color:#e6db74">    \&#34;address\&#34;: \&#34;node-exporter-</span><span style="color:#e6db74">${</span>XX<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;
</span><span style="color:#e6db74">  }&#34;</span>
<span style="color:#66d9ef">done</span>
</code></pre></div><blockquote>
<p><strong>NOTE</strong> The service <code>name</code> changes e.g. <code>node-exporter-02</code> but the <code>port</code> and <code>address</code> point to the docker-compose service called <code>node-exporter</code> that exposes metrics on port <code>9100</code>. Both services are tagged with 2 labels <code>foo</code> and <code>bar</code>.</p>
</blockquote>
<p>If we now return to the Consul UI:</p>
<p><img src="/images/210419.consul.services.node-exporter-xx.png" alt="Consul: Services: Node Exporters"></p>
<p>And, back to Prometheus' Service Discovery:</p>
<p><img src="/images/210419.prometheus.sd.node-exporter-xx.png" alt="Prometheus: Service Discovery: Node Exporters"></p>
<p>If we switch to Prometheus' Targets, we can confirm this:</p>
<p><img src="/images/210419.prometheus.targets.node-exporter-xx.png" alt="Prometheus: Targets: Node Exporters"></p>
<p>And, of course, we&rsquo;re doing this primarily to observe metrics. So, let&rsquo;s switch to Prometheus' Graph UI and visualize some metrics from the Node Exporters:</p>
<p><img src="/images/210419.prometheus.graph.hwmon.png" alt="Prometheus: Graph: hwmon"></p>
<p>I mentioned that I&rsquo;d like to use this approach to gather metrics from Cloud Run but I&rsquo;ve been demonstrating how to do this using Node Exporter running locally. Let&rsquo;s deploy Node Exporter to Cloud Run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PROJECT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;...&#34;</span>
BILLING<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;...&#34;</span>

gcloud projects create
gcloud billing

gcloud services enable run.googleapis.com --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>

<span style="color:#75715e"># Node Exporters</span>
<span style="color:#66d9ef">for</span> XX in <span style="color:#f92672">{</span>01..02<span style="color:#f92672">}</span>
<span style="color:#66d9ef">do</span>
  gcloud run deploy node-exporter-01 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --max-instances<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --image<span style="color:#f92672">=</span>us.gcr.io/<span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>/node-exporter:v1.1.2 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --ingress<span style="color:#f92672">=</span>all <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --port<span style="color:#f92672">=</span><span style="color:#ae81ff">9100</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --allow-unauthenticated <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
<span style="color:#66d9ef">done</span>
</code></pre></div><p>Then, we can enumerate the services with the name and location:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">SERVICES<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>gcloud run services list <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;csv(name,status.address.url)&#39;</span><span style="color:#66d9ef">)</span> <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">${</span>SERVICES<span style="color:#e6db74">}</span>
</code></pre></div><p>Yielding:</p>
<pre tabindex="0"><code class="language-csv" data-lang="csv">node-exporter-01,https://node-exporter-01-mvgi2eemha-uw.a.run.app
node-exporter-02,https://node-exporter-02-mvgi2eemha-uw.a.run.app
</code></pre><p>And then register these services with Consul:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#66d9ef">for</span> SERVICE in <span style="color:#e6db74">${</span>SERVICES<span style="color:#e6db74">}</span>
<span style="color:#66d9ef">do</span>
  IFS<span style="color:#f92672">=</span>, read NAME ENDPOINT <span style="color:#f92672">&lt;&lt;&lt;</span> <span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span>
  curl <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --request PUT <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  <span style="color:#e6db74">${</span>REGISTER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --data <span style="color:#e6db74">&#34;{
</span><span style="color:#e6db74">    \&#34;name\&#34;: \&#34;</span><span style="color:#e6db74">${</span>NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;,
</span><span style="color:#e6db74">    \&#34;port\&#34;:443,
</span><span style="color:#e6db74">    \&#34;tags\&#34;:[\&#34;foo\&#34;, \&#34;bar\&#34;],
</span><span style="color:#e6db74">    \&#34;address\&#34;: \&#34;</span><span style="color:#e6db74">${</span>ENDPOINT#https://<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;
</span><span style="color:#e6db74">  }&#34;</span>
<span style="color:#66d9ef">done</span>
</code></pre></div><blockquote>
<p><strong>NOTE</strong> We need to remove the prefixing <code>https://</code> from the endpoint values using <code>${ENDPOINT#https://}</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Check Consul</span>
curl <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>--request GET <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>http://localhost:8500/v1/agent/services
</code></pre></div><p>Yielding:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JSON" data-lang="JSON">{
    <span style="color:#f92672">&#34;cloud-run-01&#34;</span>: {
        <span style="color:#f92672">&#34;ID&#34;</span>: <span style="color:#e6db74">&#34;cloud-run-01&#34;</span>,
        <span style="color:#f92672">&#34;Service&#34;</span>: <span style="color:#e6db74">&#34;cloud-run-01&#34;</span>,
        <span style="color:#f92672">&#34;Tags&#34;</span>: [
            <span style="color:#e6db74">&#34;foo&#34;</span>,
            <span style="color:#e6db74">&#34;bar&#34;</span>
        ],
        <span style="color:#f92672">&#34;Meta&#34;</span>: {},
        <span style="color:#f92672">&#34;Port&#34;</span>: <span style="color:#ae81ff">443</span>,
        <span style="color:#f92672">&#34;Address&#34;</span>: <span style="color:#e6db74">&#34;node-exporter-01-mvgi2eemha-uw.a.run.app&#34;</span>,
        <span style="color:#f92672">&#34;Weights&#34;</span>: {
            <span style="color:#f92672">&#34;Passing&#34;</span>: <span style="color:#ae81ff">1</span>,
            <span style="color:#f92672">&#34;Warning&#34;</span>: <span style="color:#ae81ff">1</span>
        },
        <span style="color:#f92672">&#34;EnableTagOverride&#34;</span>: <span style="color:#66d9ef">false</span>,
        <span style="color:#f92672">&#34;Datacenter&#34;</span>: <span style="color:#e6db74">&#34;dc1&#34;</span>
    },
    <span style="color:#f92672">&#34;cloud-run-02&#34;</span>: {
        <span style="color:#f92672">&#34;ID&#34;</span>: <span style="color:#e6db74">&#34;cloud-run-02&#34;</span>,
        <span style="color:#f92672">&#34;Service&#34;</span>: <span style="color:#e6db74">&#34;cloud-run-02&#34;</span>,
        <span style="color:#f92672">&#34;Tags&#34;</span>: [
            <span style="color:#e6db74">&#34;foo&#34;</span>,
            <span style="color:#e6db74">&#34;bar&#34;</span>
        ],
        <span style="color:#f92672">&#34;Meta&#34;</span>: {},
        <span style="color:#f92672">&#34;Port&#34;</span>: <span style="color:#ae81ff">443</span>,
        <span style="color:#f92672">&#34;Address&#34;</span>: <span style="color:#e6db74">&#34;node-exporter-02-mvgi2eemha-uw.a.run.app&#34;</span>,
        <span style="color:#f92672">&#34;Weights&#34;</span>: {
            <span style="color:#f92672">&#34;Passing&#34;</span>: <span style="color:#ae81ff">1</span>,
            <span style="color:#f92672">&#34;Warning&#34;</span>: <span style="color:#ae81ff">1</span>
        },
        <span style="color:#f92672">&#34;EnableTagOverride&#34;</span>: <span style="color:#66d9ef">false</span>,
        <span style="color:#f92672">&#34;Datacenter&#34;</span>: <span style="color:#e6db74">&#34;dc1&#34;</span>
    }
}
</code></pre></div><p>And, we now have:</p>
<p><img src="/images/210419.consul.services.cloud-run-xx.png" alt="Consul: Services: cloud-run-xx"></p>
<p>We need to revise the Prometheus config of Consul because Cloud Run endpoints use TLS. Thanks to <a href="https://stackoverflow.com/a/63356229/609290">this</a> answer on Stackoverflow my initial, faltering attempts at understanding how to configure service discovery, became:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML"><span style="color:#f92672">global</span>:
  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">1m</span>
  <span style="color:#f92672">evaluation_interval</span>: <span style="color:#ae81ff">1m</span>

  <span style="color:#75715e"># Consul: Cloud Run</span>
  <span style="color:#75715e"># TLS: https://stackoverflow.com/a/63356229/609290</span>
  - <span style="color:#f92672">job_name</span>: <span style="color:#ae81ff">cloud-run</span>
    <span style="color:#75715e">#metrics_path: /metrics</span>
    <span style="color:#f92672">tls_config</span>:
      <span style="color:#f92672">insecure_skip_verify</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#f92672">consul_sd_configs</span>:
      - <span style="color:#f92672">server</span>: <span style="color:#ae81ff">consul:8500</span>
        <span style="color:#f92672">datacenter</span>: <span style="color:#ae81ff">dc1</span>
        <span style="color:#75715e"># services:</span>
        <span style="color:#75715e">#   - &#34;cloud-run-01&#34;</span>
        <span style="color:#75715e">#   - &#34;cloud-run-02&#34;</span>
        <span style="color:#f92672">tags</span>:
        - <span style="color:#ae81ff">foo</span>
        - <span style="color:#ae81ff">bar</span>
    <span style="color:#f92672">relabel_configs</span>:
      - <span style="color:#f92672">source_labels</span>:
          - <span style="color:#ae81ff">__scheme__</span>
        <span style="color:#f92672">target_label</span>: <span style="color:#ae81ff">__scheme__</span>
        <span style="color:#f92672">replacement</span>: <span style="color:#ae81ff">https</span>
</code></pre></div><blockquote>
<p><strong>NOTES</strong> The <code>metrics_path</code> defaults to <code>/metrics</code> but is included here to better document what&rsquo;s going on<!-- raw HTML omitted -->The <code>tls_config</code> sets <code>insecure_skip_verify</code> to <code>false</code>. This verifies (!) that the certs returned by Cloud Run are verified. It&rsquo;s possible to enumerate a list of <code>services</code> but it&rsquo;s more elegant (and dynamic) to select those services with specific <code>tags</code>. As shown above, when creating the services, <code>tags</code> of <code>foo</code> and <code>bar</code> were set and so these are used to filter the services discovered from Consule.<!-- raw HTML omitted -->The <code>relabel_configs</code> finds the occurrences of <code>__scheme = &quot;http&quot;</code> in the labels discovered by Prometheus and rewrites these to be <code>__scheme = &quot;https&quot;</code>, interestingly (!) this causes the protocol switch to TLS.</p>
</blockquote>
<p><img src="/images/210419.prometheus.sd.cloud-run.png" alt="Prometheus: Service Discovery: Cloud Run"></p>
<p>And:</p>
<p><img src="/images/210419.prometheus.targets.cloud-run.png" alt="Prometheus: Targets: Cloud Run"></p>
<p>And, although Cloud Run does not furnish Node Exporter with much data, we can (for sake of a random graph), view <code>node_scrape_collector_duration_seconds{collector=&quot;hwmon&quot;}</code>:</p>
<p><img src="/images/210419.prometheus.graph.png" alt="Prometheus: Graph"></p>
<h2 id="dig"><code>dig</code></h2>
<p>Consul is also able to respond as a DNS daemon. By reconfiguring <code>docker-compose.yml</code> to expose the default DNS port (<code>8600</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML">  <span style="color:#f92672">consul</span>:
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">consul:1.10.0-beta</span>
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">consul</span>
    <span style="color:#f92672">expose</span>:
    - <span style="color:#e6db74">&#34;8500&#34;</span> <span style="color:#75715e"># HTTP API|UI</span>
    - <span style="color:#e6db74">&#34;8600&#34;</span> <span style="color:#75715e"># DNS</span>
    <span style="color:#f92672">ports</span>:
    - <span style="color:#ae81ff">8500</span>:<span style="color:#ae81ff">8500</span><span style="color:#ae81ff">/tcp</span>
    - <span style="color:#ae81ff">8600</span>:<span style="color:#ae81ff">8600</span><span style="color:#ae81ff">/udp</span>
</code></pre></div><p>We can, use <code>dig</code> to query our services:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dig @localhost -p8600 cloud-run-01.service.dc1.consul.
</code></pre></div><p>Yields:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">dig @127.0.0.1 -p 8600 cloud-run-01.service.dc1.consul.
<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 cloud-run-01.service.dc1.consul.
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 58382
;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
;; WARNING: recursion requested but not available
<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;cloud-run-01.service.dc1.consul. IN	A
<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>;; ANSWER SECTION:
cloud-run-01.service.dc1.consul. 0 IN	CNAME	node-exporter-01-mvgi2eemha-uw.a.run.app.
<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>;; Query time: 4 msec
;; SERVER: 127.0.0.1#8600(127.0.0.1)
;; WHEN: Tue Apr 20 10:18:50 PDT 2021
;; MSG SIZE  rcvd: 114
</code></pre></div><p>Or by <code>SRV</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dig @127.0.0.1 -p <span style="color:#ae81ff">8600</span> cloud-run-01.service.dc1.consul. SRV
</code></pre></div><p>Yields:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">; &lt;&lt;&gt;&gt; DiG 9.16.1-Ubuntu &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 cloud-run-01.service.dc1.consul. SRV
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 11114
;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 2
;; WARNING: recursion requested but not available
<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;cloud-run-01.service.dc1.consul. IN	SRV
<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>;; ANSWER SECTION:
cloud-run-01.service.dc1.consul. 0 IN	SRV	1 1 443 node-exporter-01-mvgi2eemha-uw.a.run.app.
<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>;; ADDITIONAL SECTION:
9fd04d771d42.node.dc1.consul. 0	IN	TXT	&#34;consul-network-segment=&#34;
<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>;; Query time: 0 msec
;; SERVER: 127.0.0.1#8600(127.0.0.1)
;; WHEN: Tue Apr 20 10:24:02 PDT 2021
;; MSG SIZE  rcvd: 174
</code></pre></div><ul class="pa0">
  
   <li class="list">
     <a href="/tags/prometheus" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">prometheus</a>
   </li>
  
   <li class="list">
     <a href="/tags/consul" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">consul</a>
   </li>
  
   <li class="list">
     <a href="/tags/coredns" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">coredns</a>
   </li>
  
   <li class="list">
     <a href="/tags/service-discovery" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">service-discovery</a>
   </li>
  
   <li class="list">
     <a href="/tags/cloud-run" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">cloud-run</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>
    
    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/210316/">Programmatically deploying Cloud Run services (Golang|Python)</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210305/">Prometheus VPA Recommendations</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201008/">Deploying a Rust HTTP server to DigitalOcean App Platform</a>
        </li>
	    
    </ul>
</div>

<br/>
      <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js"
        data-name="bmc-button" data-slug="dazwilkin" data-color="#ffdd00" data-emoji="" data-font="Cookie"
        data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#000000"
        data-coffee-color="#ffffff"></script>
    </aside>

  </article>

  </main>
  <footer class="bg-dark-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://pretired.dazwilkin.com/" >
    &copy;  (p)retired 2021 
  </a>
    <div>


<a href="https://stackoverflow.com/users/609290/dazwilkin" target="_blank" class="link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Stack Overflow link" rel="noopener" aria-label="follow on Stack Overflow——Opens in a new window">
  <svg height="32px" 
    style="enable-background:new 0 0 67 67;"
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 24 24"
    width="32px"
>
    <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm.869 5.903l3.114 4.567-.975.665-3.115-4.567.976-.665zm-2.812 2.585l4.84 2.838-.6 1.017-4.842-2.838.602-1.017zm-1.276 2.724l5.413 1.521-.291 1.077-5.428-1.458.306-1.14zm-.588 2.461l5.687.569-.103 1.12-5.691-.513.107-1.176zm-.169 2.16h5.835v1.167h-5.835v-1.167zm7.976 3.167h-10v-6h1v5h8v-5h1v6zm.195-8.602l-.945-5.446 1.162-.202.947 5.446-1.164.202z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>






<a href="https://www.linkedin.com/in/dazwilkin/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://github.com/DazWilkin" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>




<a href="https://medium.com/@DazWilkin" target="_blank" class="link-transition medium link dib z-999 pt3 pt0-l mr1" title="Medium link" rel="noopener" aria-label="follow on Medium——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 170 170;" version="1.1" viewBox="0 0 170 170" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M46.5340803,65.2157554 C46.6968378,63.6076572 46.0836,62.018231 44.8828198,60.93592 L32.6512605,46.2010582 L32.6512605,44 L70.6302521,44 L99.9859944,108.380952 L125.794585,44 L162,44 L162,46.2010582 L151.542017,56.2281011 C150.640424,56.9153477 150.193188,58.0448862 150.380019,59.1628454 L150.380019,132.837155 C150.193188,133.955114 150.640424,135.084652 151.542017,135.771899 L161.755369,145.798942 L161.755369,148 L110.38282,148 L110.38282,145.798942 L120.963119,135.527337 C122.002801,134.487948 122.002801,134.182246 122.002801,132.592593 L122.002801,73.0417402 L92.585901,147.755438 L88.6106443,147.755438 L54.3622782,73.0417402 L54.3622782,123.115814 C54.0767278,125.221069 54.7759199,127.3406 56.2581699,128.863022 L70.0186741,145.55438 L70.0186741,147.755438 L31,147.755438 L31,145.55438 L44.7605042,128.863022 C46.2319621,127.338076 46.8903838,125.204485 46.5340803,123.115814 L46.5340803,65.2157554 Z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>




</div>
  </div>
</footer>

</body>

</html>
