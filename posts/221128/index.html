<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Maintaining Container Images | (p)retired</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Maintaining container images">
    <meta name="generator" content="Hugo 0.150.0-DEV">
    
    
    
    
      <meta name="robots" content="index, follow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.b89013985a078d0be77ff0f1ae39ec6d9f2c3c36e0f1aa8195900276fa8a5ad6.css" >



  


    

    
    
      

    

    

    <script data-goatcounter="https://pretired.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
 
    <meta property="og:url" content="https://pretired.dazwilkin.com/posts/221128/">
  <meta property="og:site_name" content="(p)retired">
  <meta property="og:title" content="Maintaining Container Images">
  <meta property="og:description" content="Maintaining container images">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-11-28T00:00:00-08:00">
    <meta property="article:modified_time" content="2022-11-28T00:00:00-08:00">
    <meta property="article:tag" content="Golang">
    <meta property="article:tag" content="Google">
    <meta property="article:tag" content="Docker">
    <meta property="article:tag" content="Podman">
    <meta property="article:tag" content="Container">

  <meta itemprop="name" content="Maintaining Container Images">
  <meta itemprop="description" content="Maintaining container images">
  <meta itemprop="datePublished" content="2022-11-28T00:00:00-08:00">
  <meta itemprop="dateModified" content="2022-11-28T00:00:00-08:00">
  <meta itemprop="wordCount" content="1111">
  <meta itemprop="keywords" content="Golang,Google,Docker,Podman,Container">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Maintaining Container Images">
  <meta name="twitter:description" content="Maintaining container images">

      
    
	
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-dark-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        (p)retired
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Maintaining Container Images</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2022-11-28T00:00:00-08:00">November 28, 2022</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 6 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 1111 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>As I contemplate moving my &ldquo;thing&rdquo; into production, I&rsquo;m anticipating aspects of the application that need maintenance and how this can be automated.</p>
<p>I&rsquo;d been negligent in the maintenance of some of my container images.</p>
<p>I&rsquo;m using mostly Go and some Rust as the basis of static(ally-compiled) binaries that run in these containers <strong>but</strong> not every container has a base image of <a href="https://hub.docker.com/_/scratch"><code>scratch</code></a>. <code>scratch</code> is the <strong>only</strong> base image that doesn&rsquo;t change and thus the only base image that doesn&rsquo;t require that container images buit <code>FROM</code> it, be maintained.</p>
<p>I suspect other people are making this mistake too. If your binary hasn&rsquo;t changed, you don&rsquo;t need to rebuild the container. But, I had a container I&rsquo;d not rebuilt in 11 months and it had a bunch of vulnerabilities <strong>because</strong> it was built on the then (!) current version of Debian 10.</p>
<p>Initially, I considered scripting a tool to parse my container images using <code>podman history</code> and, based on the base image, determining whether to rebuild the container. But, this is both too simplistic and too tedious.</p>
<p>I wondered whether GitHub includes a mechanism to monitor for container images updates using <a href="https://docs.github.com/en/code-security/dependabot">Dependabot</a>. I find Dependabot to be useful but complicated. I&rsquo;m still unclear why some functionality is configurable through GitHub and some requires use of <code>dependabot.yml</code>. It&rsquo;s also difficult for me to understand its scope. I Googled around but didn&rsquo;t find anything immediately applicable.</p>
<p>I&rsquo;m using <a href="https://cloud.google.com">Google Cloud</a> as a deployment target for my app. Services such as <a href="https://cloud.google.com/run">Cloud Run</a> require that container images be hosted by <a href="https://cloud.google.com/container-registry">Google Container Registry</a> or its replacement <a href="https://cloud.google.com/artifact-registry">Artifact Registry</a>. A companion service for both these registry implementations is <a href="https://cloud.google.com/container-analysis/docs/container-analysis">Container Analysis</a> and this includes vulnerability scanning of container images.</p>
<blockquote>
<p><strong>NOTE</strong> Be aware that Container Analysis vulnerability scanning is <strong>expensive</strong> (see <a href="https://cloud.google.com/container-analysis/pricing">Container Analysis pricing</a>). Yesterday, I spent $5.98 to scan 23 images (including updates) at $0.26/image. I&rsquo;d initially planned to run this service every day on each deployment of the service but I won&rsquo;t be doing that because the deployment creates a new Artifact Registry each day and scans the images each day on push.</p></blockquote>
<p>Here&rsquo;s an example of one of my container images with an outdated (CVE-full) base image:</p>
<p><img src="/images/221128.distroless-debian10.png" alt="Vulnerabilities"></p>
<p>I began trying to parse the vulnerabilities using <code>gcloud</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud artifacts docker images describe <span style="color:#e6db74">${</span>IMAGE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--show-package-vulnerability <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--format<span style="color:#f92672">=</span>json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| jq -r <span style="color:#e6db74">&#34;.package_vulnerability_summary.vulnerabilities.HIGH[]?.vulnerability.shortDescription&#34;</span>
</span></span></code></pre></div><p>Yields:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>CVE-2022-23218
</span></span><span style="display:flex;"><span>CVE-2019-25013
</span></span><span style="display:flex;"><span>CVE-2021-33574
</span></span><span style="display:flex;"><span>CVE-2021-3999
</span></span><span style="display:flex;"><span>CVE-2022-23219
</span></span></code></pre></div><p>Each of these may be looked up e.g. <a href="https://nvd.nist.gov/vuln/detail/CVE-2022-23218">NIST: CVE-2022-23218</a> although the Google API includes a <code>shortDescription</code> that references <a href="https://security-tracker.debian.org/tracker/CVE-2022-23219">Debian&rsquo;s Security Bug tracker</a>.</p>
<p>What I really wanted was: for every container image version (or manifest), to grab the CVEs and then invert the results by CVE. For each CVE, I want to know which of my repo&rsquo;s container images are affected.</p>
<p>Scripting the solution in Bash felt problematic (associative arrays comprising arrays) and so I decided to write a solution in Go.</p>
<p>Using Google&rsquo;s <a href="https://pkg.go.dev/google.golang.org/api@v0.103.0/artifactregistry/v1">Artifact Registry (API) Client Library</a>, the following code builds a slice of image URIs. These are of the form <code>{region}-docker.pkg.dev/{project}/{repo}/{image}@sha256:{hash}</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">artifactregistryService</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">artifactregistry</span>.<span style="color:#a6e22e">NewService</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">parent</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;projects/%s/locations/%s/repositories/%s&#34;</span>, <span style="color:#a6e22e">project</span>, <span style="color:#a6e22e">location</span>, <span style="color:#a6e22e">repository</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Define the request for the first page</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rqst</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">artifactregistryService</span>.<span style="color:#a6e22e">Projects</span>.<span style="color:#a6e22e">Locations</span>.<span style="color:#a6e22e">Repositories</span>.<span style="color:#a6e22e">DockerImages</span>.<span style="color:#a6e22e">List</span>(<span style="color:#a6e22e">parent</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">imageURIs</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Invoke it</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rqst</span>.<span style="color:#a6e22e">Do</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Append the image&#39;s URI</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">image</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">DockerImages</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">imageURIs</span> = append(<span style="color:#a6e22e">imageURIs</span>, <span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">Uri</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Break if no more pages</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pageToken</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">NextPageToken</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pageToken</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Otherwise revise the request to get the next page</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">rqst</span> = <span style="color:#a6e22e">rqst</span>.<span style="color:#a6e22e">PageToken</span>(<span style="color:#a6e22e">pageToken</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now we need to use Google&rsquo;s beta (!) <a href="https://pkg.go.dev/cloud.google.com/go/containeranalysis/apiv1">Container Analysis (Cloud) Client Library</a> to retrieve so-called <a href="https://cloud.google.com/container-analysis/docs/reference/rest/v1/projects.occurrences#Occurrence">Occurrence</a>&rsquo;s of CVEs detected by the vulnerability scanner.</p>
<p>The code uses the <a href="https://cloud.google.com/container-analysis/docs/reference/rest/v1/projects.occurrences/list"><code>projects.ocurrences.list</code></a> method</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">containeranalysis</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">parent</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;projects/%s&#34;</span>, <span style="color:#a6e22e">project</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Maps CVE name to an array of images that contain the CVE</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">imagesByCVE</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>][]<span style="color:#66d9ef">string</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">imageName</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">imageURIs</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Must be prefixed with https://</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">resourceURL</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;https://%s&#34;</span>, <span style="color:#a6e22e">imageName</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Both values must be quoted</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">filter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;resourceUrl=%q kind=%q&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">resourceURL</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;VULNERABILITY&#34;</span>,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">rqst</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">grafeaspb</span>.<span style="color:#a6e22e">ListOccurrencesRequest</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Parent</span>: <span style="color:#a6e22e">parent</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Filter</span>: <span style="color:#a6e22e">filter</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">occurrences</span> <span style="color:#f92672">:=</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">grafeaspb</span>.<span style="color:#a6e22e">Occurrence</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Uses Google&#39;s iterator provided with Cloud Client libraries</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">it</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">GetGrafeasClient</span>().<span style="color:#a6e22e">ListOccurrences</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">rqst</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">occurrence</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">it</span>.<span style="color:#a6e22e">Next</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">iterator</span>.<span style="color:#a6e22e">Done</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Additional filtering of the results:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Everything other than low severity</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Everything that&#39;s fixable</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">vulnerability</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">occurrence</span>.<span style="color:#a6e22e">GetVulnerability</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">vulnerability</span>.<span style="color:#a6e22e">GetSeverity</span>() <span style="color:#f92672">!=</span> <span style="color:#a6e22e">grafeaspb</span>.<span style="color:#a6e22e">Severity_LOW</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">vulnerability</span>.<span style="color:#a6e22e">FixAvailable</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">occurrences</span> = append(<span style="color:#a6e22e">occurrences</span>, <span style="color:#a6e22e">occurrence</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Retain the `shortDescription` which is the full CVE name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Can be subsequently combined with CVE site prefix</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">occurrence</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">occurrences</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">shortDescription</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">occurrence</span>.<span style="color:#a6e22e">GetVulnerability</span>().<span style="color:#a6e22e">GetShortDescription</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">imagesByCVE</span>[<span style="color:#a6e22e">shortDescription</span>]; !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">imagesByCVE</span>[<span style="color:#a6e22e">shortDescription</span>] = []<span style="color:#66d9ef">string</span>{}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">imagesByCVE</span>[<span style="color:#a6e22e">shortDescription</span>] = append(<span style="color:#a6e22e">imagesByCVE</span>[<span style="color:#a6e22e">shortDescription</span>], <span style="color:#a6e22e">imageName</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Lastly, we want to output the results:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#a6e22e">tracker</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;https://security-tracker.debian.org/tracker&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">total</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">cve</span>, <span style="color:#a6e22e">images</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">imagesByCVE</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">total</span> <span style="color:#f92672">+=</span> len(<span style="color:#a6e22e">images</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;CVE: %s/%s (%d)\n%s\n&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">tracker</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cve</span>,
</span></span><span style="display:flex;"><span>        len(<span style="color:#a6e22e">images</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">images</span>, <span style="color:#e6db74">&#34;\n&#34;</span>),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Total: %d\n&#34;</span>, <span style="color:#a6e22e">total</span>)
</span></span></code></pre></div><p>Or, by number of occurrences of the CVE. This approach allows us to focus on the CVE that occurs in the most images first:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#a6e22e">tracker</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;https://security-tracker.debian.org/tracker&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">total</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cves</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">string</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">imagesByCVE</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">cve</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">imagesByCVE</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cves</span> = append(<span style="color:#a6e22e">cves</span>, <span style="color:#a6e22e">cve</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sort</span>.<span style="color:#a6e22e">SliceStable</span>(<span style="color:#a6e22e">cves</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> len(<span style="color:#a6e22e">imagesByCVE</span>[<span style="color:#a6e22e">cves</span>[<span style="color:#a6e22e">i</span>]]) &gt; len(<span style="color:#a6e22e">imagesByCVE</span>[<span style="color:#a6e22e">cves</span>[<span style="color:#a6e22e">j</span>]])
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">cve</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">cves</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">total</span> <span style="color:#f92672">+=</span> len(<span style="color:#a6e22e">imagesByCVE</span>[<span style="color:#a6e22e">cve</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;\nCVE: %s/%s (%d)\n%s\n&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">tracker</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">cve</span>,
</span></span><span style="display:flex;"><span>        len(<span style="color:#a6e22e">imagesByCVE</span>[<span style="color:#a6e22e">cve</span>]),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">imagesByCVE</span>[<span style="color:#a6e22e">cve</span>], <span style="color:#e6db74">&#34;\n&#34;</span>),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Total: %d\n&#34;</span>, <span style="color:#a6e22e">total</span>)
</span></span></code></pre></div><p>Running the code with the single image shown above with the vulnerabilities returns:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>Images: 1
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>CVE: https://security-tracker.debian.org/tracker/CVE-2022-23218 (1)
</span></span><span style="display:flex;"><span>{region}-docker.pkg.dev/{project}/{repo}/example@sha256:{hash}
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>CVE: https://security-tracker.debian.org/tracker/CVE-2021-33574 (1)
</span></span><span style="display:flex;"><span>{region}-docker.pkg.dev/{project}/{repo}/example@sha256:{hash}
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>CVE: https://security-tracker.debian.org/tracker/CVE-2022-23219 (1)
</span></span><span style="display:flex;"><span>{region}-docker.pkg.dev/{project}/{repo}/example@sha256:{hash}
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>CVE: https://security-tracker.debian.org/tracker/CVE-2021-3326 (1)
</span></span><span style="display:flex;"><span>{region}-docker.pkg.dev/{project}/{repo}/example@sha256:{hash}
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>CVE: https://security-tracker.debian.org/tracker/CVE-2020-6096 (1)
</span></span><span style="display:flex;"><span>{region}-docker.pkg.dev/{project}/{repo}/example@sha256:{hash}
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>CVE: https://security-tracker.debian.org/tracker/CVE-2021-35942 (1)
</span></span><span style="display:flex;"><span>{region}-docker.pkg.dev/{project}/{repo}/example@sha256:{hash}
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>CVE: https://security-tracker.debian.org/tracker/CVE-2019-25013 (1)
</span></span><span style="display:flex;"><span>{region}-docker.pkg.dev/{project}/{repo}/example@sha256:{hash}
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>CVE: https://security-tracker.debian.org/tracker/CVE-2021-3999 (1)
</span></span><span style="display:flex;"><span>{region}-docker.pkg.dev/{project}/{repo}/example@sha256:{hash}
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>CVE: https://security-tracker.debian.org/tracker/CVE-2016-10228 (1)
</span></span><span style="display:flex;"><span>{region}-docker.pkg.dev/{project}/{repo}/example@sha256:{hash}
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>Total: 9
</span></span></code></pre></div><p>In my case, I had almost 20 images in the repo and so there were many more results than is shown here. I was able to start with the CVEs that occurred in multiple images.</p>
<p>The known solution in this case is to bump the base image from Debian 10 (&ldquo;buster&rdquo;) to 11 (&ldquo;bullseye&rdquo;).</p>
<p>I&rsquo;m going to push the updated image and deleted the current one (to reset the vulnerabilities):</p>
<p><img src="/images/221128.distroless-debian11.png" alt="Vulnerabilities"></p>
<p>And:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># High</span>
</span></span><span style="display:flex;"><span>gcloud artifacts docker images describe <span style="color:#e6db74">${</span>IMAGE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--show-package-vulnerability <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--format<span style="color:#f92672">=</span>json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| jq -r <span style="color:#e6db74">&#34;.package_vulnerability_summary.vulnerabilities.HIGH[]?.vulnerability.shortDescription&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># No results</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Medium</span>
</span></span><span style="display:flex;"><span>gcloud artifacts docker images describe <span style="color:#e6db74">${</span>IMAGE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--show-package-vulnerability <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--format<span style="color:#f92672">=</span>json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| jq -r <span style="color:#e6db74">&#34;.package_vulnerability_summary.vulnerabilities.MEDIUM[]?.vulnerability.shortDescription&#34;</span>
</span></span><span style="display:flex;"><span>CVE-2022-2097
</span></span></code></pre></div><p>The Go code produces zero results because, even though there&rsquo;s a <code>MEDIUM</code> severity issue, the issue doesn&rsquo;t have a fix available (<code>FixAvailable</code> is <code>false</code>).</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/golang/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Golang</a>
   </li>
  
   <li class="list di">
     <a href="/tags/google/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Google</a>
   </li>
  
   <li class="list di">
     <a href="/tags/docker/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Docker</a>
   </li>
  
   <li class="list di">
     <a href="/tags/podman/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Podman</a>
   </li>
  
   <li class="list di">
     <a href="/tags/container/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Container</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/221117/">Delegate domain-wide authority using Golang</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/221106/">Basic programmatic access to GitHub Issues</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/220422/">Playing with GitHub Container Registry REST API</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/220421/">Using Google&#39;s Public Certificate Authority with Golang autocert</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/211130/">Automatic Certs w/ Golang gRPC service on Compute Engine</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/211018/">Golang Structured Logging w/ Google Cloud Logging (2)</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/211006/">Podman</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210928/">Golang Structured Logging w/ Google Cloud Logging</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210924/">GitHub help with dependency management</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210724/">gRPC Interceptors and in-memory gRPC connections</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210716/">Stripe</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210527/">Struggling with Golang structs</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210506/">Firestore Golang Timestamps &amp; Merging</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210413/">Cloud Firestore Triggers in Golang</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210317/">Using Golang with the Firestore Emulator</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-dark-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://pretired.dazwilkin.com/" >
    &copy;  (p)retired 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>