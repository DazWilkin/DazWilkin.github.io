<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Trendnet TEW-812DRU and DD-WRT | (p)retired</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Trendent TEW-812DRU and DD-WRT">
    <meta name="generator" content="Hugo 0.151.0-DEV">
    
    
    
    
      <meta name="robots" content="index, follow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.b89013985a078d0be77ff0f1ae39ec6d9f2c3c36e0f1aa8195900276fa8a5ad6.css" >



  


    

    
    
      

    

    

    <script data-goatcounter="https://pretired.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
 
    <meta property="og:url" content="https://pretired.dazwilkin.com/posts/200113/">
  <meta property="og:site_name" content="(p)retired">
  <meta property="og:title" content="Trendnet TEW-812DRU and DD-WRT">
  <meta property="og:description" content="Trendent TEW-812DRU and DD-WRT">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-01-13T00:00:00-08:00">
    <meta property="article:modified_time" content="2020-01-13T00:00:00-08:00">
    <meta property="article:tag" content="Trendnet">
    <meta property="article:tag" content="TEW-812DRU">
    <meta property="article:tag" content="DD-WRT">

  <meta itemprop="name" content="Trendnet TEW-812DRU and DD-WRT">
  <meta itemprop="description" content="Trendent TEW-812DRU and DD-WRT">
  <meta itemprop="datePublished" content="2020-01-13T00:00:00-08:00">
  <meta itemprop="dateModified" content="2020-01-13T00:00:00-08:00">
  <meta itemprop="wordCount" content="727">
  <meta itemprop="keywords" content="Trendnet,TEW-812DRU,DD-WRT">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Trendnet TEW-812DRU and DD-WRT">
  <meta name="twitter:description" content="Trendent TEW-812DRU and DD-WRT">

      
    
	
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-dark-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        (p)retired
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Trendnet TEW-812DRU and DD-WRT</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2020-01-13T00:00:00-08:00">January 13, 2020</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 4 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 727 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>The FBI Portland published an interesting <a href="https://www.fbi.gov/contact-us/field-offices/portland/news/press-releases/tech-tuesday-internet-of-things-iot">advisory</a> with several, sensible recommendations including firewalling IoT devices from other devices on a home network. I decided to deploy a redundant <a href="https://www.trendnet.com/products/wifi/AC-routers/AC1750/TEW-812DRU">Trendnet TEW-812DRU version 2.0</a> for this purpose.</p>
<p>Caveat Developer: Before I go further, I don&rsquo;t recommend installing DD-WRT on a Trendnet TEW-812DRU unless you&rsquo;re willing to brick the device irrecoverably.</p>
<p>I read the DD-WRT instructions several times (<a href="https://forum.dd-wrt.com/phpBB2/viewtopic.php?t=51486">&ldquo;peacock thread&rdquo;</a>,<a href="https://dd-wrt.com/support/router-database/?model=TEW-812DRU_v2">router database</a> &ndash; do not use v3.0 beta builds!), thought I&rsquo;d followed them and still (temporarily) bricked my router using the firmware downloaded from the DD-WRT router database. It is thanks to Justin&rsquo;s help and his <a href="https://blog.swwomm.com/2018/07/dd-wrt-firmware-for-trendnet-tew-812dru.html">post</a> that I was encouraged to try restoring my device to the Trendent firmware and then retring the DD-WRT installation with an older firmware version.</p>
<p>So, assuming you have a Trendnet TEW-812DRU that you&rsquo;re willing to irrecoverably brick&hellip;</p>
<p>This DD-WRT version worked for me: <a href="https://download1.dd-wrt.com/dd-wrtv2/downloads/betas/2019/04-25-2019-r39654/trendnet-812DRUv2/">https://download1.dd-wrt.com/dd-wrtv2/downloads/betas/2019/04-25-2019-r39654/trendnet-812DRUv2/</a></p>
<p>Daniele has a useful post describing monitoring an ASUS device running DD-WRT w/ Promethues (<a href="https://daenney.github.io/2017/04/22/monitoring-wifi-with-prometheus">link</a>). After getting DD-WRT running on the TEW-812DRU, I looked around and learned:</p>
<ul>
<li>DD-WRT runs BusyBox</li>
<li>The TEW-812DRU has an ARMv7 Processor</li>
<li>Various tools are employed by DD-WRT: <a href="https://en.wikipedia.org/wiki/Dropbear_%28software%29">dropbear</a>, wland, <a href="https://en.wikipedia.org/wiki/Dnsmasq">dnsmasq</a>, nas</li>
<li>Using <code>sshd</code> the username continues to be <code>root</code> even if changed in the GUI</li>
<li>The nas processes(es) show how the GUI Wifi configuration maps to <code>nas</code> processes</li>
<li><a href="https://forum.dd-wrt.com/wiki/index.php/Hardware"><code>nvram</code></a> (non-volatile RAM) holds configuration data e.g. whether sshd is enabled</li>
</ul>
<h2 id="prometheus--node-exporter">Prometheus | Node Exporter</h2>
<p>Daniele described using SNMP and a <a href="https://github.com/jschornick/openwrt_exporter">Lua script</a> that generates (&ldquo;exports&rdquo;) Prometheus metrics. I was unable to find SNMP running on my device (neither in the GUI nor as a running process) and assume that this is an optional extra that&rsquo;s included in builds for devices with more accessible RAM. My device did not have lua installed either.</p>
<p>I decided to try <a href="https://github.com/prometheus/node_exporter">Node Exporter</a>. The learning here and a tweak is that &ndash; IIUC &ndash; the ARM processor on the TEW-812DRU (or the build I&rsquo;m using) does not support floating-point math. After compiling Node Exporter for <code>GOARM=7</code> (per the output from <code>/proc/cpuinfo</code>), I received errors. I learned that ARMv5 contains a software implementation for floating-point math. Building Node Export with <code>GOARM=5</code> works. I built Node Exporter on my workstation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>CGO_ENABLED<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>GOOS<span style="color:#f92672">=</span>linux <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>GOARCH<span style="color:#f92672">=</span>arm GOARM<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>go build -a -tags netgo -ldflags <span style="color:#e6db74">&#39;-w -extldflags &#34;-static&#34;&#39;</span> *.go
</span></span></code></pre></div><p>And then SCP&rsquo;d it to the router:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>scp -i ~/.ssh/my_private_key root@192.168.1.1
</span></span></code></pre></div><p><strong>NB</strong> Node Exporter is <strong>not</strong> persisted across router reboots</p>
<p>And then, from the router:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ssh -i ~/.ssh/my_private_key root@192.168.1.1
</span></span></code></pre></div><p>And</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./node_exporter <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--no-collector.infiniband <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--no-collector.mdadm <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--no-collector.meminfo <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--no-collector.netstat <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--no-collector.powersupplyclass <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--no-collector.schedstat <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--no-collector.softnet
</span></span></code></pre></div><p><strong>NB</strong> I&rsquo;m excluding various collectors with metrics that appear (!?) unavailable|inaccessible on the router</p>
<p>The exporter uses the default port (<code>:9100</code>) specified (implicitly in my case) by <code>--web.listen-address=&quot;:9100&quot;</code></p>
<p>Back on my workstation, I can then reference the DD-WRT device (and the Prometheus server itself) from prometheus.yml:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">evaluation_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Self</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;prometheus-server&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#e6db74">&#34;localhost:9090&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># DD-WRT</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;dd-wrt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">1m</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">targets</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#e6db74">&#34;192.168.1.1:9100&#34;</span>
</span></span></code></pre></div><p>And then run the server:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--interactive --tty --rm <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--publish<span style="color:#f92672">=</span>9090:9090 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--volume<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PWD<span style="color:#e6db74">}</span>/prometheus.yml:/etc/prometheus/prometheus.yml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>prom/prometheus@sha256:35c52c0c2b76433bbfc44a5a7abc294c2f032ed80250be02b441db5dd91b203a
</span></span></code></pre></div><p><strong>NB</strong> <a href="https://hub.docker.com/layers/prom/prometheus/v2.15.2/images/sha256-35c52c0c2b76433bbfc44a5a7abc294c2f032ed80250be02b441db5dd91b203a">prom/promtheus:v2.15.2</a></p>
<p>Here showing the targets (responding correctly) on <code>http://localhost:9090/targets</code>:</p>
<p><img src="/images/200113.targets.png" alt="Prometheus Targets: DD-WRT|Self"></p>
<p>I&rsquo;ve 2 wireless devices (<code>eth0</code> and <code>eth1</code>) and so can select only these using <code>{device=~&quot;eth0|eth1&quot;}</code></p>
<p><strong>NB</strong> The <code>=~</code> for specify a regex and then <code>eth0|eth1</code> which is equivalent to <code>eth[0|1]</code></p>
<p>There are many metrics available but <code>node_network_transmit_packets_total</code> and <code>node_network_receive_packets_total</code> look useful:</p>
<p>Because these are both counters:</p>
<pre tabindex="0"><code># HELP node_network_transmit_bytes_total Network device statistic transmit_bytes.
# TYPE node_network_transmit_bytes_total counter
</code></pre><p>Let&rsquo;s use PromQL to convert them into (per-second!) rates over 5-minutes: rate(${METRIC}[5m])</p>
<p>i.e.</p>
<pre tabindex="0"><code>rate(node_network_transmit_packets_total{device=~&#34;eth0|eth1&#34;}[5m])
rate(node_network_receive_packets_total{device=~&#34;eth0|eth1&#34;}[5m])
</code></pre><p>Yields:</p>
<p><img src="/images/200113.graphs.png" alt="Prometheus Metrics Graph"></p>
<h2 id="nvram"><code>nvram</code></h2>
<p>See: <a href="https://forum.dd-wrt.com/wiki/index.php/Hardware">https://forum.dd-wrt.com/wiki/index.php/Hardware</a></p>
<p>Using Omega Onions, I was acquainted with <code>uci</code> and tried this on DD-WRT without success. The functional equivalent appears to be using <code>nvram</code> to read|write configuration data. After disabling <code>traff</code>, there&rsquo;s a recommendation to delete data it may have captured too, using:</p>
<pre tabindex="0"><code>for i in `nvram show | grep traff- | cut -f1 -d=&#34;&#34;`
do
  echo ${i}
  nvram unset ${i}
done
</code></pre><p>Noodling around, I found:</p>
<pre tabindex="0"><code>nvram show | grep snmp
block_snmp=1
</code></pre><p>I assume this means that <code>SNMP</code> is blocked</p>
<pre tabindex="0"><code class="language-nvram" data-lang="nvram">telnet_wanport=23
telnetd_enable=0
remote_mgt_telnet=0
limit_telnet=0
</code></pre><p>I&rsquo;ve disabled <code>telnetd</code> (I&rsquo;m using ssh &ndash; see below)</p>
<pre tabindex="0"><code class="language-nvram" data-lang="nvram">sshd_forwarding=0
sshd_port=22
sshd_passwd_auth=1
sshd_enable=1
sshd_rsa_host_key=-----BEGIN RSA PRIVATE KEY-----
sshd_wanport=22
sshd_authorized_keys=ssh-rsa [[REDACTED]]]]
</code></pre><p>I&rsquo;ve enabled <code>sshd</code> on (default) port <code>:22</code>; <code>sshd_wantport=22</code> is shown too but I&rsquo;m (slightly) confident, this isn&rsquo;t available remotely.</p>
<p>That&rsquo;s all!</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/trendnet/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Trendnet</a>
   </li>
  
   <li class="list di">
     <a href="/tags/tew-812dru/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">TEW-812DRU</a>
   </li>
  
   <li class="list di">
     <a href="/tags/dd-wrt/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">DD-WRT</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-dark-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://pretired.dazwilkin.com/" >
    &copy;  (p)retired 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>