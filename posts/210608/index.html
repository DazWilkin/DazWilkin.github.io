<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Cloud Endpoints combine OpenAPI and gRPC... or not! | (p)retired</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Is it possible to combine OpenAPI and gRPC services with Cloud Endpoints?">
    <meta name="generator" content="Hugo 0.153.0-DEV">
    
    
    
    
      <meta name="robots" content="index, follow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.cf4aecb341f2e16e80e407465df095cee730d71e19c4574f8e9b28d163dc4225.css" >



  


    

    
    
      

    

    

    <script data-goatcounter="https://pretired.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
 
    <meta property="og:url" content="https://pretired.dazwilkin.com/posts/210608/">
  <meta property="og:site_name" content="(p)retired">
  <meta property="og:title" content="Cloud Endpoints combine OpenAPI and gRPC... or not!">
  <meta property="og:description" content="Is it possible to combine OpenAPI and gRPC services with Cloud Endpoints?">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-06-08T00:00:00-07:00">
    <meta property="article:modified_time" content="2021-06-08T00:00:00-07:00">
    <meta property="article:tag" content="Cloud-Endpoints">
    <meta property="article:tag" content="Cloud Run">
    <meta property="article:tag" content="GRPC">
    <meta property="article:tag" content="Openapi">

  <meta itemprop="name" content="Cloud Endpoints combine OpenAPI and gRPC... or not!">
  <meta itemprop="description" content="Is it possible to combine OpenAPI and gRPC services with Cloud Endpoints?">
  <meta itemprop="datePublished" content="2021-06-08T00:00:00-07:00">
  <meta itemprop="dateModified" content="2021-06-08T00:00:00-07:00">
  <meta itemprop="wordCount" content="1005">
  <meta itemprop="keywords" content="Cloud-Endpoints,Cloud Run,GRPC,Openapi">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Cloud Endpoints combine OpenAPI and gRPC... or not!">
  <meta name="twitter:description" content="Is it possible to combine OpenAPI and gRPC services with Cloud Endpoints?">

      
    
	
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-dark-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        (p)retired
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Cloud Endpoints combine OpenAPI and gRPC... or not!</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2021-06-08T00:00:00-07:00">June 8, 2021</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 5 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 1005 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>See:</p>
<ul>
<li><a href="/posts/210519/">Multiplexing gRPC and HTTP endpoints with Cloud Run</a></li>
<li><a href="/posts/200325/">gRPC, Cloud Run &amp; Endpoints</a></li>
<li><a href="https://github.com/GoogleCloudPlatform/esp-v2/issues/523">ESPv2: Configure Cloud Endpoints to proxy traffic to a Cloud Run multiplexed (gRPC|HTTP) service</a></li>
</ul>
<p>Challenges:</p>
<ul>
<li>Cloud Run permits single port</li>
<li>Cloud Run services publishing e.g. gRPC and Prometheus, must multiplex transports</li>
<li>Cloud Run services publishing multiplexed transports are <em>challenging</em> to expose using Cloud Endpoints</li>
</ul>
<h2 id="hypothesis-1-multiplexed-transports-work-with-cloud-run">Hypothesis #1: Multiplexed transports work with Cloud Run</h2>
<p>See: <a href="/posts/210519/">Multiplexing gRPC and HTTP endpoints with Cloud Run</a></p>
<p>Resuming from that post, there&rsquo;s a Cloud Run service (<code>SRV_HOST</code>) deployed that uses <a href="https://github.com/soheilhy/cmux">cmux</a> to multiple transports&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SRV_HOST<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>gcloud run services descripbe <span style="color:#e6db74">${</span>SRV_NAME<span style="color:#e6db74">}</span> ...<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>TOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>gcloud auth print-identity-token<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><h3 id="grpc">gRPC</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>grpcurl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Authorization: Bearer </span><span style="color:#e6db74">${</span>TOKEN<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#34;{\&#34;customer_id\&#34;: \&#34;</span><span style="color:#e6db74">${</span>ID<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;}&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-proto something.proto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">${</span>SRV_HOST<span style="color:#e6db74">}</span>:443 v1alpha1.Something/CustomerGet
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;customer&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Daz Wilkin&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;domainName&#34;</span>: <span style="color:#e6db74">&#34;dazwilkin.com&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="prometheus-http1">Prometheus (HTTP/1)</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--silent <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--request GET <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Authorization: Bearer </span><span style="color:#e6db74">${</span>TOKEN<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--output /dev/null  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--write-out <span style="color:#e6db74">&#39;%{response_code}\n&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>https://<span style="color:#e6db74">${</span>SRV_HOST<span style="color:#e6db74">}</span>/metrics
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">200</span>
</span></span></code></pre></div><h2 id="hypothesis-2-either-grpc-xor-http-prometheus-work-with-cloud-endpoints">Hypothesis #2: Either gRPC <strong>xor</strong> HTTP (Prometheus) work with Cloud Endpoints</h2>
<p>See: <a href="/posts/200325/">gRPC, Cloud Run &amp; Endpoints</a></p>
<p>With minor changes (ESPv2 <code>cloud_build_image</code> now generates an image that includes a version number in its tag), this process continues to work.</p>
<h3 id="grpc-1">gRPC</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">google.api.Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">config_version</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">ESP_HOST</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">title</span>: <span style="color:#ae81ff">Some Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apis</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">v1alpha1.SomeService</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">usage</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">selector</span>: <span style="color:#e6db74">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">allow_unregistered_calls</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">selector</span>: <span style="color:#e6db74">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">address</span>: <span style="color:#ae81ff">grpcs://SRV_HOST:443</span>
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> This uses <a href="https://cloud.google.com/endpoints/docs/grpc/about-grpc">Cloud Endpoints for gRPC</a>. There are three ways to configure Cloud Endpoints, using <a href="https://en.wikipedia.org/wiki/OpenAPI_Specification">OpenAPI n√©e Swagger</a> see below, using gRPC as here and using <a href="https://cloud.google.com/endpoints/docs/frameworks/about-cloud-endpoints-frameworks">Cloud Endpoints for Frameworks</a> not discussed further.</p>
</blockquote>
<p>And:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud endpoints services deploy something.pb something.yaml
</span></span><span style="display:flex;"><span>gcloud_build_image ...
</span></span><span style="display:flex;"><span>gcloud run deploy <span style="color:#e6db74">${</span>ESP_NAME<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ESP_HOST<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>gcloud run describe ...<span style="color:#66d9ef">)</span>
</span></span></code></pre></div><p>Then, I can now <code>gRPCurl</code> the ESPv2 proxy&rsquo;s endpoint to access the backend&rsquo;s gRPC service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>grpcurl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-H <span style="color:#e6db74">&#34;Authorization: Bearer </span><span style="color:#e6db74">${</span>TOKEN<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#34;{\&#34;customer_id\&#34;: \&#34;</span><span style="color:#e6db74">${</span>ID<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;}&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-proto something.proto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">${</span>ESP_HOST<span style="color:#e6db74">}</span>:443 v1alpha1.Something/CustomerGet
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;customer&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Daz Wilkin&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;domainName&#34;</span>: <span style="color:#e6db74">&#34;dazwilkin.com&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> <code>ESP_HOST</code> not <code>SRV_HOST</code></p>
</blockquote>
<h3 id="prometheus-http1-1">Prometheus (HTTP/1)</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">swagger</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">info</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">title</span>: <span style="color:#ae81ff">Prometheus</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">description</span>: <span style="color:#e6db74">&#34;Prometheus metrics&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;0.0.1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">host</span>: <span style="color:#ae81ff">ESP_HOST</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">schemes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">https</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">produces</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#34;application/json&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">x-google-backend</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">address</span>: <span style="color:#ae81ff">https://SRV_HOST:443</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">protocol</span>: <span style="color:#e6db74">&#34;h2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;/metrics&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">get</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">summary</span>: <span style="color:#ae81ff">Prometheus metrics endpoint</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">operationId</span>: <span style="color:#ae81ff">metrics</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">responses</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;200&#34;</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">description</span>: <span style="color:#ae81ff">Success</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">schema</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">type</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;400&#34;</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">description</span>: <span style="color:#ae81ff">Failure</span>
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> This uses <a href="https://cloud.google.com/endpoints/docs/openapi">Cloud Endpoints for OpenAPI</a> rather than <a href="https://cloud.google.com/endpoints/docs/grpc/about-grpc">Cloud Endpoints for gRPC</a>. Both specs are shown here in YAML and you should see commonalities (e.g. <code>ESP_HOST</code>) and differences (e.g. <code>https://SRV_HOST:443</code> vs <code>grpc://SRV_HOST:443</code>)</p>
</blockquote>
<p>Because the service config has changed, after <code>gcloud services deploy</code>&lsquo;ing it, we must rebuild the image and redeploy it too:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud endpoints services deploy prometheus.yaml
</span></span><span style="display:flex;"><span>gcloud_build_image ...
</span></span><span style="display:flex;"><span>gcloud run deploy <span style="color:#e6db74">${</span>ESP_NAME<span style="color:#e6db74">}</span>
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> The <code>ESP_HOST</code> name does not change between <code>gcloud run deploy</code>&lsquo;ments.</p>
</blockquote>
<p>Then I can now <code>curl</code> the ESPv2 proxy&rsquo;s endpoint to access the backend&rsquo;s HTTP (Prometheus) service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"></code></pre></div><h2 id="hypothesis-3-both-grpc-and-http-work-with-cloud-endpoints-unproven">Hypothesis #3: Both gRPC <strong>and</strong> HTTP work with Cloud Endpoints (unproven)</h2>
<p>If I can deploy either, I should be able to deploy both, but this doesn&rsquo;t work:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud endpoints services deploy something.pb something.yaml prometheus.yaml
</span></span></code></pre></div><p>This yields errors:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>ERROR: (gcloud.endpoints.services.deploy)
</span></span><span style="display:flex;"><span>HttpError accessing &lt;https://servicemanagement.googleapis.com/v1/services/...
</span></span><span style="display:flex;"><span>response: &lt;{
</span></span><span style="display:flex;"><span>    &#39;x-debug-tracking-id&#39;: &#39;...;o=0&#39;,
</span></span><span style="display:flex;"><span>    &#39;vary&#39;: &#39;Origin, X-Origin, Referer&#39;,
</span></span><span style="display:flex;"><span>    &#39;content-type&#39;: &#39;application/json; charset=UTF-8&#39;,
</span></span><span style="display:flex;"><span>    &#39;content-encoding&#39;: &#39;gzip&#39;,
</span></span><span style="display:flex;"><span>    &#39;date&#39;: &#39;Tue, 08 Jun 2021 19:31:40 GMT&#39;,
</span></span><span style="display:flex;"><span>    &#39;server&#39;: &#39;ESF&#39;,
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    &#39;status&#39;: 500
</span></span><span style="display:flex;"><span>}&gt;,
</span></span><span style="display:flex;"><span>content &lt;{
</span></span><span style="display:flex;"><span>  &#34;error&#34;: {
</span></span><span style="display:flex;"><span>    &#34;code&#34;: 500,
</span></span><span style="display:flex;"><span>    &#34;message&#34;: &#34;Internal error encountered.&#34;,
</span></span><span style="display:flex;"><span>    &#34;status&#34;: &#34;INTERNAL&#34;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> Not very helpful but clearly it&rsquo;s not happy.</p>
</blockquote>
<p>The Google engineer was very helpful with the <a href="https://github.com/GoogleCloudPlatform/esp-v2/issues/523">issue</a> and cleverly suggested <code>GET</code>&lsquo;ing the OpenAPI service back as a gRPC service, i.e.:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  gcloud endpoints configs list <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --service<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>ESP_HOST<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  | jq -r .<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.id<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gcloud endpoints configs describe <span style="color:#e6db74">${</span>CONFIG<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--service<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>ESP_HOST<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>This yields (edited for sanity):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">google.api.Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">configVersion</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">ESP_HOST</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">title</span>: <span style="color:#ae81ff">Prometheus</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apis</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">0.</span><span style="color:#ae81ff">ESP_HOST</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">0.0.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">methods</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requestTypeUrl</span>: <span style="color:#ae81ff">type.googleapis.com/google.protobuf.Empty</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">responseTypeUrl</span>: <span style="color:#ae81ff">type.googleapis.com/google.protobuf.Value</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">usage</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">allowUnregisteredCalls</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>: <span style="color:#ae81ff">0.</span><span style="color:#ae81ff">ESP_HOST.Metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">address</span>: <span style="color:#ae81ff">https://SRV_HOST:443</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jwtAudience</span>: <span style="color:#ae81ff">https://SRV_HOST:443</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">pathTranslation</span>: <span style="color:#ae81ff">APPEND_PATH_TO_ADDRESS</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">h2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>: <span style="color:#ae81ff">0.</span><span style="color:#ae81ff">ESP_HOST.Metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">get</span>: <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>: <span style="color:#ae81ff">0.</span><span style="color:#ae81ff">ESP_HOST.Metrics</span>
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> I&rsquo;ve removed (hopefully) redundant elements and reordered what remains so that this should &ndash; if you squint &ndash; look like the child of the OpenAPI Prometheus and gRPC services.</p>
</blockquote>
<p>Here&rsquo;s Google reference docs for <a href="https://cloud.google.com/endpoints/docs/grpc-service-config/reference/rpc/google.api#google.api.Service"><code>google.api.Service</code></a></p>
<p>Unfortunately, it doesn&rsquo;t blend:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud endpoints services deploy prometheus.service.yaml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>Yields:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>ERROR: (gcloud.endpoints.services.deploy) INVALID_ARGUMENT: Cannot convert to service config.
</span></span><span style="display:flex;"><span>location: &#34;prometheus.service.yaml:2&#34;
</span></span><span style="display:flex;"><span>kind: ERROR
</span></span><span style="display:flex;"><span>message: &#34;Found field \&#39;configVersion\&#39; which is unknown in \&#39;google.api.Service\&#39;.&#34;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>location: &#34;prometheus.service.yaml:10&#34;
</span></span><span style="display:flex;"><span>kind: ERROR
</span></span><span style="display:flex;"><span>message: &#34;Found field \&#39;requestTypeUrl\&#39; which is unknown in \&#39;google.protobuf.Method\&#39;.&#34;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>location: &#34;prometheus.service.yaml:11&#34;
</span></span><span style="display:flex;"><span>kind: ERROR
</span></span><span style="display:flex;"><span>message: &#34;Found field \&#39;responseTypeUrl\&#39; which is unknown in \&#39;google.protobuf.Method\&#39;.&#34;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>location: &#34;prometheus.service.yaml:14&#34;
</span></span><span style="display:flex;"><span>kind: ERROR
</span></span><span style="display:flex;"><span>message: &#34;Found field \&#39;allowUnregisteredCalls\&#39; which is unknown in \&#39;google.api.UsageRule\&#39;.&#34;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>location: &#34;prometheus.service.yaml:19&#34;
</span></span><span style="display:flex;"><span>kind: ERROR
</span></span><span style="display:flex;"><span>message: &#34;Found field \&#39;jwtAudience\&#39; which is unknown in \&#39;google.api.BackendRule\&#39;.&#34;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>location: &#34;prometheus.service.yaml:20&#34;
</span></span><span style="display:flex;"><span>kind: ERROR
</span></span><span style="display:flex;"><span>message: &#34;Found field \&#39;pathTranslation\&#39; which is unknown in \&#39;google.api.BackendRule\&#39;.&#34;
</span></span></code></pre></div><p>This is a result of an incorrect YAML marshaling (<a href="https://github.com/GoogleCloudPlatform/esp-v2/issues/528">Issue #528</a>) which is easily corrected by reviewing <a href="https://cloud.google.com/endpoints/docs/grpc-service-config/reference/rpc/google.api#google.api.Service"><code>google.api.Service</code></a>, e.g. for <a href="https://developers.google.com/protocol-buffers/docs/reference/google.protobuf#google.protobuf.Method"><code>apis.methods</code></a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">google.api.Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">config_version</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">ESP_HOST</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">title</span>: <span style="color:#ae81ff">Prometheus</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apis</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">0.</span><span style="color:#ae81ff">ESP_HOST</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">0.0.1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">methods</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">request_type_url</span>: <span style="color:#ae81ff">type.googleapis.com/google.protobuf.Empty</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">response_type_url</span>: <span style="color:#ae81ff">type.googleapis.com/google.protobuf.Value</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">usage</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">allow_unregistered_calls</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>: <span style="color:#ae81ff">0.</span><span style="color:#ae81ff">ESP_HOST.Metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">address</span>: <span style="color:#ae81ff">https://SRV_HOST:443</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jwt_audience</span>: <span style="color:#ae81ff">https://SRV_HOST:443</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path_translation</span>: <span style="color:#ae81ff">APPEND_PATH_TO_ADDRESS</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">h2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>: <span style="color:#ae81ff">0.</span><span style="color:#ae81ff">ESP_HOST.Metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">get</span>: <span style="color:#ae81ff">/metrics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">selector</span>: <span style="color:#ae81ff">0.</span><span style="color:#ae81ff">ESP_HOST.Metrics</span>
</span></span></code></pre></div><p>yields:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>ERROR: (gcloud.endpoints.services.deploy) INVALID_ARGUMENT: Cannot convert to service config.
</span></span><span style="display:flex;"><span>location: &#34;prometheus.service.yaml:6&#34;
</span></span><span style="display:flex;"><span>kind: ERROR
</span></span><span style="display:flex;"><span>message: &#34;Cannot resolve api \&#39;0.ESP_HOST\&#39;.&#34;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>location: &#34;prometheus.service.yaml:15&#34;
</span></span><span style="display:flex;"><span>message: &#34;usage rule has selector(s) \&#39;0.ESP_HOST.Metrics\&#39; that do not match and are not shadowed by other rules.&#34;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>location: &#34;prometheus.service.yaml:26&#34;
</span></span><span style="display:flex;"><span>message: &#34;backend rule has selector(s) \&#39;0.ESP_HOST.Metrics\&#39; that do not match and are not shadowed by other rules.&#34;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>location: &#34;prometheus.service.yaml:19&#34;
</span></span><span style="display:flex;"><span>message: &#34;http rule has selector(s) \&#39;0.ESP_HOST.Metrics\&#39; that do not match and are not shadowed by other rules.&#34;
</span></span></code></pre></div><p>i.e. still screwed :-(</p>
<h2 id="epiphany-1-proxy-grpc-service-but-not-prometheus-metrics">Epiphany #1: Proxy gRPC service but not Prometheus metrics</h2>
<p>Since I can&rsquo;t get this to work through Cloud Endpoints, is there another way?</p>
<p>Perhaps.</p>
<p>I can live with proxying the gRPC service only through Cloud Endpoints. This gives me documentation, monitoring, control over the gRPC service.</p>
<p>The Prometheus metrics are a single endpoint <code>/metrics</code> and I can continue to authenticate these requests and so I can limit access to the endpoint. No documentation. No API keys but I can live with that.</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/cloud-endpoints/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Cloud-Endpoints</a>
   </li>
  
   <li class="list di">
     <a href="/tags/cloud-run/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Cloud Run</a>
   </li>
  
   <li class="list di">
     <a href="/tags/grpc/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">GRPC</a>
   </li>
  
   <li class="list di">
     <a href="/tags/openapi/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Openapi</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/210519/">Multiplexing gRPC and HTTP (Prometheus) endpoints with Cloud Run</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210520/">Consul discovers Google Cloud Run</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210419/">Prometheus Service Discovery w/ Consul for Cloud Run</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210412/">Fly.io</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210316/">Programmatically deploying Cloud Run services (Golang|Python)</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210222/">Dapr</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200717/">Remotely invoking WASM functions using gRPC and waPC</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200429/">Rust implementation of Crate Transparency using Google Trillian</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-dark-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://pretired.dazwilkin.com/" >
    &copy;  (p)retired 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>