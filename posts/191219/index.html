<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>(p)retired  | Prometheus AlertManager</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.61.0-DEV" />
    
    
      <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
    

    
    
      <link href="/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="Prometheus AlertManager" />
<meta property="og:description" content="Yesterday I discussed a Linode Prometheus Exporter and tantalized use of Prometheus AlertManager.
Success:
Configure The process is straightforward although I found the Prometheus (config) documentation slightly unwieldy to navigate :-(
The overall process is documented.
Here are the steps I took:
 Configure Prometheus Configure AlertManager Revise Docker Compose  Configure Prometheus Added the following to prometheus.yml:
rule_files: - &#34;/etc/alertmanager/rules/linode.yml&#34; alerting: alertmanagers: - scheme: http static_configs: - targets: - &#34;alertmanager:9093&#34; Rules must be defined in separate rules files." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pretired.dazwilkin.com/posts/191219/" />
<meta property="article:published_time" content="2019-12-19T00:00:00-07:00" />
<meta property="article:modified_time" content="2019-12-19T00:00:00-07:00" />
<meta itemprop="name" content="Prometheus AlertManager">
<meta itemprop="description" content="Yesterday I discussed a Linode Prometheus Exporter and tantalized use of Prometheus AlertManager.
Success:
Configure The process is straightforward although I found the Prometheus (config) documentation slightly unwieldy to navigate :-(
The overall process is documented.
Here are the steps I took:
 Configure Prometheus Configure AlertManager Revise Docker Compose  Configure Prometheus Added the following to prometheus.yml:
rule_files: - &#34;/etc/alertmanager/rules/linode.yml&#34; alerting: alertmanagers: - scheme: http static_configs: - targets: - &#34;alertmanager:9093&#34; Rules must be defined in separate rules files.">
<meta itemprop="datePublished" content="2019-12-19T00:00:00-07:00" />
<meta itemprop="dateModified" content="2019-12-19T00:00:00-07:00" />
<meta itemprop="wordCount" content="594">



<meta itemprop="keywords" content="Prometheus,Linode," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Prometheus AlertManager"/>
<meta name="twitter:description" content="Yesterday I discussed a Linode Prometheus Exporter and tantalized use of Prometheus AlertManager.
Success:
Configure The process is straightforward although I found the Prometheus (config) documentation slightly unwieldy to navigate :-(
The overall process is documented.
Here are the steps I took:
 Configure Prometheus Configure AlertManager Revise Docker Compose  Configure Prometheus Added the following to prometheus.yml:
rule_files: - &#34;/etc/alertmanager/rules/linode.yml&#34; alerting: alertmanagers: - scheme: http static_configs: - targets: - &#34;alertmanager:9093&#34; Rules must be defined in separate rules files."/>

      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-148669951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://pretired.dazwilkin.com/" class="f3 fw2 hover-white no-underline white-90 dib">
      (p)retired
    </a>
    <div class="flex-l items-center">
      

      
      











    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">Prometheus AlertManager</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2019-12-19T00:00:00-07:00">December 19, 2019</time>
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>Yesterday I discussed a <a href="https://pretired.dazwilkin.com/posts/191218/">Linode Prometheus Exporter</a> and tantalized use of Prometheus AlertManager.</p>
<p>Success:</p>
<p><img src="/images/191219.alertmanager.gmail.png" alt="Gmail Alert"></p>
<h2 id="configure">Configure</h2>
<p>The process is straightforward although I found the Prometheus (config) documentation slightly unwieldy to navigate :-(</p>
<p>The overall process is <a href="https://prometheus.io/docs/alerting/overview/">documented</a>.</p>
<p>Here are the steps I took:</p>
<ul>
<li><a href="#configure-prometheus">Configure Prometheus</a></li>
<li><a href="#configure-alertmanager">Configure AlertManager</a></li>
<li><a href="#revise-docker-compose">Revise Docker Compose</a></li>
</ul>
<h3 id="configure-prometheus">Configure Prometheus</h3>
<p>Added the following to <code>prometheus.yml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML"><span style="color:#66d9ef">rule_files</span>:
- <span style="color:#e6db74">&#34;/etc/alertmanager/rules/linode.yml&#34;</span>

<span style="color:#66d9ef">alerting</span>:
  <span style="color:#66d9ef">alertmanagers</span>:
    - <span style="color:#66d9ef">scheme</span>: http
      <span style="color:#66d9ef">static_configs</span>:
        - <span style="color:#66d9ef">targets</span>:
            - <span style="color:#e6db74">&#34;alertmanager:9093&#34;</span>
</code></pre></div><p>Rules must be defined in separate rules files. See below for the content for <code>linode.yml</code> and an explanation.</p>
<p>The <code>alerting</code> section specifies that an AlertManager will be accessible on <code>alertmanager:9093</code>. <code>9093</code> is the default port and the <code>alertmanager</code> hostname will come courtesy of Docker Compose.</p>
<p><code>linode.yaml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML"><span style="color:#66d9ef">groups</span>:
- <span style="color:#66d9ef">name</span>: linode
  <span style="color:#66d9ef">rules</span>:
  - <span style="color:#66d9ef">alert</span>: LinodeInstances
    <span style="color:#66d9ef">expr</span>: linode_instance_count &gt; <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">for</span>: 60m
    <span style="color:#66d9ef">labels</span>:
      <span style="color:#66d9ef">severity</span>: page
    <span style="color:#66d9ef">annotations</span>:
      <span style="color:#66d9ef">summary</span>: Linode Instances running
  - <span style="color:#66d9ef">alert</span>: LinodeNodeBalancers
    <span style="color:#66d9ef">expr</span>: linode_nodebalancer_count &gt; <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">for</span>: 60m
    <span style="color:#66d9ef">labels</span>:
      <span style="color:#66d9ef">severity</span>: page
    <span style="color:#66d9ef">annotations</span>:
      <span style="color:#66d9ef">summary</span>: Linode NodeBalancers running
</code></pre></div><p>The rule defines a group (of alerts) called <code>linode</code>. These will represent the set I'm going to define for my Linode account leveraging the exporter. There are 2 alerts.</p>
<ol>
<li>LinodeInstances</li>
<li>LinodeNodeBalanacers</li>
</ol>
<p>The magic happens with the <code>expr</code> statements. I'm not familiar with PromQL but e.g. <code>linode_instance_count</code> is the name of a metric exposed by the exporter and this alert will be true when that numbers exceeds 0, i.e. I have at least one instance running. The alert will fire when this holds true for an hour (60 minutes) or more. You can see the pattern here. As more metrics are surfaced by the exporter, e.g. Linode Kubernetes Engine, these can be quickly represented with alerts.</p>
<h3 id="configure-alertmanager">Configure AlertManager</h3>
<p>I'm using Docker Compose and already have the Prometheus container image. Unsurprisingly, there's an image for <a href="https://hub.docker.com/r/prom/alertmanager/">AlertManager</a> too. As with Prometheus, this expects a configuration YAML. Unoriginally, I called this <code>alertmanager.yaml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML"><span style="color:#66d9ef">route</span>:
  <span style="color:#66d9ef">group_by</span>: [<span style="color:#e6db74">&#34;...&#34;</span>]
  <span style="color:#66d9ef">receiver</span>: email-me

<span style="color:#66d9ef">receivers</span>:
- <span style="color:#66d9ef">name</span>: email-me
  <span style="color:#66d9ef">email_configs</span>:
  - <span style="color:#66d9ef">to</span>: [[EMAIL-ADDR]]
    <span style="color:#66d9ef">from</span>: [[EMAIL-ADDR]]
    <span style="color:#66d9ef">smarthost</span>: smtp.gmail.com:<span style="color:#ae81ff">587</span>
    <span style="color:#66d9ef">auth_username</span>: [[EMAIL-ADDR]]
    <span style="color:#66d9ef">auth_identity</span>: [[EMAIL-ADDR]]
    <span style="color:#66d9ef">auth_password</span>: [[EMAIL-PASS]]
</code></pre></div><p>This is one (of many) possible alert <code>receivers</code>. I'm alerting by having emails sent to my Gmail account. I found <a href="https://www.robustperception.io/sending-email-with-the-alertmanager-via-gmail">this</a> helpful explanation on the excellent Prometheus-centric blog <a href="https://www.robustperception.io">Robust Perception</a>. Replace <code>[[EMAIL-ADDR]]</code> with your Gmail address and <code>[[EMAIL-PASS]]</code> with the app token that you generate.</p>
<p>I'm unfamiliar with the <code>route</code> mechanism but &ndash; IIUC &ndash; this sents every alerts (<code>[&quot;...&quot;]</code>) to <code>email-me</code>.</p>
<h3 id="revise-docker-compose">Revise Docker Compose</h3>
<p>Everything is in place and we can now run the comnbined services by adding <code>prom/alertmanager</code> to the mix:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML"><span style="color:#66d9ef">prometheus</span>:
  <span style="color:#66d9ef">restart</span>: always
  <span style="color:#66d9ef">depends_on</span>:
  - linode-exporter
  <span style="color:#66d9ef">image</span>: prom/prometheus:v2<span style="color:#ae81ff">.14</span><span style="color:#ae81ff">.0</span>
  <span style="color:#66d9ef">container_name</span>: prometheus
  <span style="color:#66d9ef">volumes</span>:
  - ${PWD}/prometheus.yml:/etc/prometheus/prometheus.yml
  - ${PWD}/linode.yml:/etc/alertmanager/rules/linode.yml
  <span style="color:#66d9ef">expose</span>:
  - <span style="color:#e6db74">&#34;9090&#34;</span>
  <span style="color:#66d9ef">ports</span>:
  - <span style="color:#ae81ff">9090</span>:<span style="color:#ae81ff">9090</span>

<span style="color:#66d9ef">alertmanager</span>:
  <span style="color:#66d9ef">restart</span>: always
  <span style="color:#66d9ef">depends_on</span>:
  - prometheus
  <span style="color:#66d9ef">image</span>: prom/alertmanager:v0<span style="color:#ae81ff">.20</span><span style="color:#ae81ff">.0</span>
  <span style="color:#66d9ef">container_name</span>: alertmanager
  <span style="color:#66d9ef">volumes</span>:
  - ${PWD}/alertmanager.yml:/etc/alertmanager/alertmanager.yml
  <span style="color:#66d9ef">expose</span>:
  - <span style="color:#e6db74">&#34;9093&#34;</span>
  <span style="color:#66d9ef">ports</span>:
  - <span style="color:#ae81ff">9093</span>:<span style="color:#ae81ff">9093</span>
</code></pre></div><p><strong>NB</strong> Because we added a rules file to <code>prometheus.yml</code>, we must revise the <code>volumes</code> reference for the <code>prometheus</code> service</p>
<p><strong>NB</strong> <code>9093</code> is the default AlertManager port for receiving alerts (from Prometheus) and for presenting the UI</p>
<h2 id="run">Run</h2>
<p>All being well, <code>docker-compose up</code> then <code>docker-compose ps</code> should get us:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">     Name                    Command                  State               Ports         
----------------------------------------------------------------------------------------
alertmanager      /bin/alertmanager --config ...   Up             0.0.0.0:9093-&gt;9093/tcp
cadvisor          /usr/bin/cadvisor -logtostderr   Up <span style="color:#f92672">(</span>healthy<span style="color:#f92672">)</span>   0.0.0.0:8085-&gt;8080/tcp
linode-exporter   /linode-exporter --linode_ ...   Up             0.0.0.0:9388-&gt;9388/tcp
prometheus        /bin/prometheus --config.f ...   Up             0.0.0.0:9090-&gt;9090/tcp
</code></pre></div><p>You can browse:</p>
<ul>
<li>AlertManager on <a href="http://localhost:9093"><code>http://localhost:9093</code></a></li>
<li>Prometheus on <a href="http://localhost:9090"><code>http://localhost:9090</code></a></li>
<li>cAdvisor on <a href="http://localhost:8085"><code>http://localhost:8085</code></a></li>
</ul>
<p>Under Prometheus, you ought now be able to see a list of alerts:</p>
<p><img src="/images/191219.alertmanager.inactive.png" alt=""></p>
<p><strong>NB</strong> Because I've no active instances and nodebalancers (yet), these are &ldquo;inactive&rdquo;</p>
<p>Then, after creating a Linode Kubernetes Engine cluster:</p>
<p><img src="/images/191219.alertmanager.pending.png" alt=""></p>
<p>And then, after an hour:</p>
<p><img src="/images/191219.alertmanager.firing.png" alt=""></p>
<p>And:</p>
<p><img src="/images/191219.alertmanager.alert.png" alt=""></p>
<p>And, this triggers an email of the type that is shown at the top of this post. Neat!</p>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/prometheus" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Prometheus</a>
   </li>
  
   <li class="list">
     <a href="/tags/linode" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Linode</a>
   </li>
  
</ul>
<div class="mt6">
      
      
      </div>
    </section>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/191218/">Linode Prometheus Exporter</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://pretired.dazwilkin.com/" >
    &copy; 2019 (p)retired
  </a>
    <div>










</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
