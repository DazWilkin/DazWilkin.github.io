<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Using Rust to generate Kubernetes CRD | (p)retired</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="For the first time, I chose Rust to solve a problem. Until this, I&rsquo;ve been trying to use Rust to learn the language and to rewrite existing code. But, this problem led me to Rust because my other tools wouldn&rsquo;t cut it.
The question was how to represent oneof fields in Kubernetes Custom Resource Definitions (CRDs).
CRDs use OpenAPI schema and the YAML that results can be challenging to grok.
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: deploymentconfigs.example.com
spec:
  group: example.com
  names:
    categories: []
    kind: DeploymentConfig
    plural: deploymentconfigs
    shortNames: []
    singular: deploymentconfig
  scope: Namespaced
  versions:
  - additionalPrinterColumns: []
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: An example schema
        properties:
          spec:
            properties:
              deployment_strategy:
                oneOf:
                - required:
                  - rolling_update
                - required:
                  - recreate
                properties:
                  recreate:
                    properties:
                      something:
                        format: uint16
                        minimum: 0.0
                        type: integer
                    required:
                    - something
                    type: object
                  rolling_update:
                    properties:
                      max_surge:
                        format: uint16
                        minimum: 0.0
                        type: integer
                      max_unavailable:
                        format: uint16
                        minimum: 0.0
                        type: integer
                    required:
                    - max_surge
                    - max_unavailable
                    type: object
                type: object
            required:
            - deployment_strategy
            type: object
        required:
        - spec
        title: DeploymentConfig
        type: object
    served: true
    storage: true
    subresources: {}
I&rsquo;ve developed several Kubernetes Operators using the Operator SDK in Go (which builds upon Kubebuilder).">
    <meta name="generator" content="Hugo 0.150.0-DEV">
    
    
    
    
      <meta name="robots" content="index, follow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.2438bcafd7af9675c426d1a4afcd16cfff18e4e10f401071e45b5ccd3be40a0d.css" >




    

    
    
      

    

    

    <script data-goatcounter="https://pretired.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
 
    <meta property="og:url" content="https://pretired.dazwilkin.com/posts/240529/">
  <meta property="og:site_name" content="(p)retired">
  <meta property="og:title" content="Using Rust to generate Kubernetes CRD">
  <meta property="og:description" content="For the first time, I chose Rust to solve a problem. Until this, I’ve been trying to use Rust to learn the language and to rewrite existing code. But, this problem led me to Rust because my other tools wouldn’t cut it.
The question was how to represent oneof fields in Kubernetes Custom Resource Definitions (CRDs).
CRDs use OpenAPI schema and the YAML that results can be challenging to grok.
apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata: name: deploymentconfigs.example.com spec: group: example.com names: categories: [] kind: DeploymentConfig plural: deploymentconfigs shortNames: [] singular: deploymentconfig scope: Namespaced versions: - additionalPrinterColumns: [] name: v1alpha1 schema: openAPIV3Schema: description: An example schema properties: spec: properties: deployment_strategy: oneOf: - required: - rolling_update - required: - recreate properties: recreate: properties: something: format: uint16 minimum: 0.0 type: integer required: - something type: object rolling_update: properties: max_surge: format: uint16 minimum: 0.0 type: integer max_unavailable: format: uint16 minimum: 0.0 type: integer required: - max_surge - max_unavailable type: object type: object required: - deployment_strategy type: object required: - spec title: DeploymentConfig type: object served: true storage: true subresources: {} I’ve developed several Kubernetes Operators using the Operator SDK in Go (which builds upon Kubebuilder).">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-29T00:00:00-07:00">
    <meta property="article:modified_time" content="2024-05-29T00:00:00-07:00">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="CRD">
    <meta property="article:tag" content="Rust">

  <meta itemprop="name" content="Using Rust to generate Kubernetes CRD">
  <meta itemprop="description" content="For the first time, I chose Rust to solve a problem. Until this, I’ve been trying to use Rust to learn the language and to rewrite existing code. But, this problem led me to Rust because my other tools wouldn’t cut it.
The question was how to represent oneof fields in Kubernetes Custom Resource Definitions (CRDs).
CRDs use OpenAPI schema and the YAML that results can be challenging to grok.
apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata: name: deploymentconfigs.example.com spec: group: example.com names: categories: [] kind: DeploymentConfig plural: deploymentconfigs shortNames: [] singular: deploymentconfig scope: Namespaced versions: - additionalPrinterColumns: [] name: v1alpha1 schema: openAPIV3Schema: description: An example schema properties: spec: properties: deployment_strategy: oneOf: - required: - rolling_update - required: - recreate properties: recreate: properties: something: format: uint16 minimum: 0.0 type: integer required: - something type: object rolling_update: properties: max_surge: format: uint16 minimum: 0.0 type: integer max_unavailable: format: uint16 minimum: 0.0 type: integer required: - max_surge - max_unavailable type: object type: object required: - deployment_strategy type: object required: - spec title: DeploymentConfig type: object served: true storage: true subresources: {} I’ve developed several Kubernetes Operators using the Operator SDK in Go (which builds upon Kubebuilder).">
  <meta itemprop="datePublished" content="2024-05-29T00:00:00-07:00">
  <meta itemprop="dateModified" content="2024-05-29T00:00:00-07:00">
  <meta itemprop="wordCount" content="1234">
  <meta itemprop="keywords" content="Kubernetes,CRD,Rust">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Using Rust to generate Kubernetes CRD">
  <meta name="twitter:description" content="For the first time, I chose Rust to solve a problem. Until this, I’ve been trying to use Rust to learn the language and to rewrite existing code. But, this problem led me to Rust because my other tools wouldn’t cut it.
The question was how to represent oneof fields in Kubernetes Custom Resource Definitions (CRDs).
CRDs use OpenAPI schema and the YAML that results can be challenging to grok.
apiVersion: apiextensions.k8s.io/v1 kind: CustomResourceDefinition metadata: name: deploymentconfigs.example.com spec: group: example.com names: categories: [] kind: DeploymentConfig plural: deploymentconfigs shortNames: [] singular: deploymentconfig scope: Namespaced versions: - additionalPrinterColumns: [] name: v1alpha1 schema: openAPIV3Schema: description: An example schema properties: spec: properties: deployment_strategy: oneOf: - required: - rolling_update - required: - recreate properties: recreate: properties: something: format: uint16 minimum: 0.0 type: integer required: - something type: object rolling_update: properties: max_surge: format: uint16 minimum: 0.0 type: integer max_unavailable: format: uint16 minimum: 0.0 type: integer required: - max_surge - max_unavailable type: object type: object required: - deployment_strategy type: object required: - spec title: DeploymentConfig type: object served: true storage: true subresources: {} I’ve developed several Kubernetes Operators using the Operator SDK in Go (which builds upon Kubebuilder).">

      
    
	
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-dark-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        (p)retired
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Using Rust to generate Kubernetes CRD</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2024-05-29T00:00:00-07:00">May 29, 2024</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 6 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 1234 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>For the first time, I chose Rust to solve a problem. Until this, I&rsquo;ve been trying to use Rust to learn the language and to rewrite existing code. But, this problem led me to Rust because my other tools wouldn&rsquo;t cut it.</p>
<p>The question was how to represent oneof fields in Kubernetes <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/">Custom Resource Definitions (CRDs)</a>.</p>
<p>CRDs use <a href="https://github.com/OAI/OpenAPI-Specification/blob/main/versions/3.0.0.md#schemaObject">OpenAPI</a> schema and the YAML that results can be challenging to grok.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apiextensions.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CustomResourceDefinition</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deploymentconfigs.example.com</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group</span>: <span style="color:#ae81ff">example.com</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">names</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">categories</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DeploymentConfig</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">plural</span>: <span style="color:#ae81ff">deploymentconfigs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">shortNames</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">singular</span>: <span style="color:#ae81ff">deploymentconfig</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scope</span>: <span style="color:#ae81ff">Namespaced</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">versions</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">additionalPrinterColumns</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">v1alpha1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">schema</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">openAPIV3Schema</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">description</span>: <span style="color:#ae81ff">An example schema</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">deployment_strategy</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">oneOf</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>                  - <span style="color:#ae81ff">rolling_update</span>
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>                  - <span style="color:#ae81ff">recreate</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">recreate</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>                      <span style="color:#f92672">something</span>:
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">format</span>: <span style="color:#ae81ff">uint16</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">minimum</span>: <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">integer</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>                    - <span style="color:#ae81ff">something</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">rolling_update</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>                      <span style="color:#f92672">max_surge</span>:
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">format</span>: <span style="color:#ae81ff">uint16</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">minimum</span>: <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">integer</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#f92672">max_unavailable</span>:
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">format</span>: <span style="color:#ae81ff">uint16</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">minimum</span>: <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">integer</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>                    - <span style="color:#ae81ff">max_surge</span>
</span></span><span style="display:flex;"><span>                    - <span style="color:#ae81ff">max_unavailable</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">deployment_strategy</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">spec</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">title</span>: <span style="color:#ae81ff">DeploymentConfig</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">served</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">subresources</span>: {}
</span></span></code></pre></div><p>I&rsquo;ve developed several Kubernetes <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/">Operators</a> using the <a href="https://sdk.operatorframework.io/">Operator SDK</a> in Go (which builds upon <a href="https://github.com/kubernetes-sigs/kubebuilder">Kubebuilder</a>).</p>
<p>But I worried that, because Go doesn&rsquo;t (!?) directly represent union (<code>oneOf</code>) types. I have experienced this using Protobufs <code>oneOf</code> which is compiled to an interface type and uses (interface-)implementing types to represent the union&rsquo;s types. I was also unsure (see below) how to represent this using Kubebuilder.</p>
<p>Interestingly, Gemini proposes the following which I will try:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#75715e">// +kubebuilder:validation:Union</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DeploymentStrategy</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// +unionDiscriminator</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Type</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;type&#34;`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// +unionMember</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">RollingUpdate</span> <span style="color:#a6e22e">RollingUpdate</span> <span style="color:#e6db74">`json:&#34;rolling_update,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// +unionMember</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Recreate</span> <span style="color:#a6e22e">Recreate</span> <span style="color:#e6db74">`json:&#34;recreate,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We want to able to represent the following variants:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DeploymentConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">example.com/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">rolling-update</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">deployment_strategy</span>: <span style="color:#75715e"># &lt;--- Here&#39;s the union either rolling_update</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rolling_update</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max_surge</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max_unavailable</span>: <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>Or:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DeploymentConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">example.com/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">recreate</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">deployment_strategy</span>: <span style="color:#75715e"># &lt;--- Here&#39;s the union or recreate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">recreate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">something</span>: <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>I know from my adventures with Rust, that union types are permitted and I&rsquo;ve experience using Rust with Protobuf <code>oneOf</code> types.</p>
<p>So I started with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> kube_derive::CustomResource;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> schemars::JsonSchema;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> serde::{Serialize, Deserialize};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[derive(CustomResource, Debug, Serialize, Deserialize, Default, Clone, JsonSchema)]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[kube(group = </span><span style="color:#e6db74">&#34;example.com&#34;</span><span style="color:#75715e">, version = </span><span style="color:#e6db74">&#34;v1alpha1&#34;</span><span style="color:#75715e">, kind = </span><span style="color:#e6db74">&#34;DeploymentConfig&#34;</span><span style="color:#75715e">, namespaced)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">DeploymentConfigsSpec</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> deployment_strategy: <span style="color:#a6e22e">DeploymentStrategy</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[derive(Serialize,Deserialize,Clone,Debug,JsonSchema)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">DeploymentStrategy</span> {
</span></span><span style="display:flex;"><span>    RollingUpdate{
</span></span><span style="display:flex;"><span>        max_surge: <span style="color:#66d9ef">u16</span>,
</span></span><span style="display:flex;"><span>        max_unavailable: <span style="color:#66d9ef">u16</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    Recreate{
</span></span><span style="display:flex;"><span>        something: <span style="color:#66d9ef">u16</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Default <span style="color:#66d9ef">for</span> DeploymentStrategy {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">default</span>() -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        DeploymentStrategy::Recreate{
</span></span><span style="display:flex;"><span>            something: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It&rsquo;s then possible to create the CRD from the <code>Spec</code> and serialize it as JSON:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> kube::core::CustomResourceExt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// CRD as YAML
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> document_spec <span style="color:#f92672">=</span> DeploymentConfig::crd();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">println!</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>,serde_yaml::to_string(<span style="color:#f92672">&amp;</span>document_spec).unwrap());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Yields:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apiextensions.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CustomResourceDefinition</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deploymentconfigs.example.com</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group</span>: <span style="color:#ae81ff">example.com</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">names</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">categories</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DeploymentConfig</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">plural</span>: <span style="color:#ae81ff">deploymentconfigs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">shortNames</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">singular</span>: <span style="color:#ae81ff">deploymentconfig</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scope</span>: <span style="color:#ae81ff">Namespaced</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">versions</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">additionalPrinterColumns</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">v1alpha1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">schema</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">openAPIV3Schema</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">description</span>: <span style="color:#ae81ff">An example schema</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">deployment_strategy</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">oneOf</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>                  - <span style="color:#ae81ff">RollingUpdate</span>
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>                  - <span style="color:#ae81ff">Recreate</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">Recreate</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>                      <span style="color:#f92672">something</span>:
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">format</span>: <span style="color:#ae81ff">uint16</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">minimum</span>: <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">integer</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>                    - <span style="color:#ae81ff">something</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">RollingUpdate</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>                      <span style="color:#f92672">max_surge</span>:
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">format</span>: <span style="color:#ae81ff">uint16</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">minimum</span>: <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">integer</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#f92672">max_unavailable</span>:
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">format</span>: <span style="color:#ae81ff">uint16</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">minimum</span>: <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">integer</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>                    - <span style="color:#ae81ff">max_surge</span>
</span></span><span style="display:flex;"><span>                    - <span style="color:#ae81ff">max_unavailable</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">deployment_strategy</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">spec</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">title</span>: <span style="color:#ae81ff">DeploymentConfig</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">served</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">subresources</span>: {}
</span></span></code></pre></div><p>You can then apply this to a (sacrificial) cluster and try to create some Custom Resources (CRs) against it. The examples above will suffice:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--filename<span style="color:#f92672">=</span>deploymentconfig.tests.yaml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>error: error validating &#34;/path/to/deploymentconfig.tests.yaml&#34;: error validating data: [ValidationError(DeploymentConfig.spec.deployment_strategy): unknown field &#34;rolling_update&#34; in com.example.v1alpha1.DeploymentConfig.spec.deployment_strategy, ValidationError(DeploymentConfig.spec.deployment_strategy): unknown field &#34;recreate&#34; in com.example.v1alpha1.DeploymentConfig.spec.deployment_strategy]; if you choose to ignore these errors, turn validation off with --validate=false
</span></span></code></pre></div><p>Uh-oh! The <code>enum</code> branches <code>RollingUpdate</code> and <code>Recreate</code> aren&rsquo;t being correctly renamed when serialized to JSON.</p>
<p>This is straightforward to fix:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[derive(Serialize,Deserialize,Clone,Debug,JsonSchema)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">DeploymentStrategy</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Add Serde rename
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[serde(rename=</span><span style="color:#e6db74">&#34;rolling_update&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span>    RollingUpdate{
</span></span><span style="display:flex;"><span>        max_surge: <span style="color:#66d9ef">u16</span>,
</span></span><span style="display:flex;"><span>        max_unavailable: <span style="color:#66d9ef">u16</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Add Serde rename
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#[serde(rename=</span><span style="color:#e6db74">&#34;recreate&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span>    Recreate{
</span></span><span style="display:flex;"><span>        something: <span style="color:#66d9ef">u16</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Default <span style="color:#66d9ef">for</span> DeploymentStrategy {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">default</span>() -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        DeploymentStrategy::Recreate{
</span></span><span style="display:flex;"><span>            something: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Rerun to regenerate the CRD YAML:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apiextensions.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CustomResourceDefinition</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deploymentconfigs.example.com</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group</span>: <span style="color:#ae81ff">example.com</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">names</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">categories</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DeploymentConfig</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">plural</span>: <span style="color:#ae81ff">deploymentconfigs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">shortNames</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">singular</span>: <span style="color:#ae81ff">deploymentconfig</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scope</span>: <span style="color:#ae81ff">Namespaced</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">versions</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">additionalPrinterColumns</span>: []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">v1alpha1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">schema</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">openAPIV3Schema</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">description</span>: <span style="color:#ae81ff">An example schema</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">deployment_strategy</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">oneOf</span>:
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>                  - <span style="color:#ae81ff">rolling_update</span> <span style="color:#75715e"># Correct</span>
</span></span><span style="display:flex;"><span>                - <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>                  - <span style="color:#ae81ff">recreate      </span> <span style="color:#75715e"># Correct</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">recreate</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>                      <span style="color:#f92672">something</span>:
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">format</span>: <span style="color:#ae81ff">uint16</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">minimum</span>: <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">integer</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>                    - <span style="color:#ae81ff">something</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">rolling_update</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>                      <span style="color:#f92672">max_surge</span>:
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">format</span>: <span style="color:#ae81ff">uint16</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">minimum</span>: <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">integer</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#f92672">max_unavailable</span>:
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">format</span>: <span style="color:#ae81ff">uint16</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">minimum</span>: <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">integer</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>                    - <span style="color:#ae81ff">max_surge</span>
</span></span><span style="display:flex;"><span>                    - <span style="color:#ae81ff">max_unavailable</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#ae81ff">deployment_strategy</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#ae81ff">spec</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">title</span>: <span style="color:#ae81ff">DeploymentConfig</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">served</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">subresources</span>: {}
</span></span></code></pre></div><p>Reapply the CRD to the cluster and then reapply the tests:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--filename<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PWD<span style="color:#e6db74">}</span>/deploymentconfig.tests.yaml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>deploymentconfig.example.com/rolling-update created
</span></span><span style="display:flex;"><span>deploymentconfig.example.com/recreate created
</span></span><span style="display:flex;"><span>The DeploymentConfig &#34;bothof&#34; is invalid: &lt;nil&gt;: Invalid value: &#34;&#34;: &#34;spec.deployment_strategy&#34; must validate one and only one schema (oneOf). Found 2 valid alternatives
</span></span><span style="display:flex;"><span>dazwilkin@hades-canyon:~/Projects/stackoverflow/78523396/rust (master)$ 
</span></span></code></pre></div><p>The last test fails intentionally:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DeploymentConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">example.com/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">bothof</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">deployment_strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rolling_update</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max_surge</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max_unavailable</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">recreate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">something</span>: <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>Because <code>deployment_strategy</code> is <code>oneOf</code> <code>rolling_update</code> or <code>recreate</code>, it should not contain both and so this Custom Resource&rsquo;s creation fails.</p>
<p>So, as far as the CRD generation works, the Rust code is sufficient.</p>
<p>But, there&rsquo;s another problem.</p>
<p>It&rsquo;s possible to create the Custom Resources in Rust too:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// CRD as YAML
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> document_spec <span style="color:#f92672">=</span> DeploymentConfig::crd();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">println!</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>,serde_yaml::to_string(<span style="color:#f92672">&amp;</span>document_spec).unwrap());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// CR with RollingUpdate as YAML
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> d1 <span style="color:#f92672">=</span> DeploymentConfigsSpec{
</span></span><span style="display:flex;"><span>        deployment_strategy: <span style="color:#a6e22e">DeploymentStrategy</span>::RollingUpdate{
</span></span><span style="display:flex;"><span>            max_surge:<span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>            max_unavailable:<span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">println!</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>,serde_yaml::to_string(<span style="color:#f92672">&amp;</span>d1).unwrap());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// CR with Recreate as YAML
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> d2 <span style="color:#f92672">=</span> DeploymentConfigsSpec{
</span></span><span style="display:flex;"><span>        deployment_strategy:<span style="color:#a6e22e">DeploymentStrategy</span>::Recreate{
</span></span><span style="display:flex;"><span>            something: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">println!</span>(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>,serde_yaml::to_string(<span style="color:#f92672">&amp;</span>d2).unwrap());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This yields (incorrectly):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">deployment_strategy</span>: !<span style="color:#ae81ff">rolling_update</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_surge</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">max_unavailable</span>: <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">deployment_strategy</span>: !<span style="color:#ae81ff">recreate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">something</span>: <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>The solution I found for this problem is the following. As always I&rsquo;m interested in better ways to do this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[derive(Deserialize,Clone,Debug,JsonSchema)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">DeploymentStrategy</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[serde(rename=</span><span style="color:#e6db74">&#34;rolling_update&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span>    RollingUpdate{
</span></span><span style="display:flex;"><span>        max_surge: <span style="color:#66d9ef">u16</span>,
</span></span><span style="display:flex;"><span>        max_unavailable: <span style="color:#66d9ef">u16</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#[serde(rename=</span><span style="color:#e6db74">&#34;recreate&#34;</span><span style="color:#75715e">)]</span>
</span></span><span style="display:flex;"><span>    Recreate{
</span></span><span style="display:flex;"><span>        something: <span style="color:#66d9ef">u16</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Default <span style="color:#66d9ef">for</span> DeploymentStrategy {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">default</span>() -&gt; <span style="color:#a6e22e">Self</span> {
</span></span><span style="display:flex;"><span>        DeploymentStrategy::Recreate{
</span></span><span style="display:flex;"><span>            something: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Serialize <span style="color:#66d9ef">for</span> DeploymentStrategy {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">serialize</span><span style="color:#f92672">&lt;</span>S<span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span>self, serializer: <span style="color:#a6e22e">S</span>) -&gt; Result<span style="color:#f92672">&lt;</span>S::Ok, S::Error<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>            S: <span style="color:#a6e22e">serde</span>::Serializer {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> self {
</span></span><span style="display:flex;"><span>            DeploymentStrategy::RollingUpdate{
</span></span><span style="display:flex;"><span>                max_surge,
</span></span><span style="display:flex;"><span>                max_unavailable
</span></span><span style="display:flex;"><span>            } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> rolling_update <span style="color:#f92672">=</span> RollingUpdate {
</span></span><span style="display:flex;"><span>                    max_surge: <span style="color:#f92672">*</span>max_surge,
</span></span><span style="display:flex;"><span>                    max_unavailable: <span style="color:#f92672">*</span>max_unavailable,
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> map <span style="color:#f92672">=</span> std::collections::BTreeMap::new();
</span></span><span style="display:flex;"><span>                map.insert(<span style="color:#e6db74">&#34;rolling_update&#34;</span>, rolling_update);
</span></span><span style="display:flex;"><span>                map.serialize(serializer)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            DeploymentStrategy::Recreate{ 
</span></span><span style="display:flex;"><span>                something 
</span></span><span style="display:flex;"><span>            } <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> recreate <span style="color:#f92672">=</span> Recreate {
</span></span><span style="display:flex;"><span>                    something: <span style="color:#f92672">*</span>something,
</span></span><span style="display:flex;"><span>                };
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> map <span style="color:#f92672">=</span> std::collections::BTreeMap::new();
</span></span><span style="display:flex;"><span>                map.insert(<span style="color:#e6db74">&#34;recreate&#34;</span>, recreate);
</span></span><span style="display:flex;"><span>                map.serialize(serializer)
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[derive(Serialize,Deserialize,Clone,Debug,JsonSchema)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">RollingUpdate</span> {
</span></span><span style="display:flex;"><span>    max_surge: <span style="color:#66d9ef">u16</span>,
</span></span><span style="display:flex;"><span>    max_unavailable: <span style="color:#66d9ef">u16</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[derive(Serialize,Deserialize,Clone,Debug,JsonSchema)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Recreate</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pub</span> something: <span style="color:#66d9ef">u16</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is slightly awkward because it duplicates (which gives me pause) the type definitions of <code>RollingUpdate</code> and <code>Recreate</code>. The first time these are defined as variants of the <code>enum</code>. The second time they&rsquo;re defined explicitly as <code>struct</code> types.</p>
<p><code>Serialize</code> is implemented explicity for the <code>enum</code> (<code>DeploymentStrategy</code>) and it matches on the variants and replaces the enum variant with the struct type and adds (!) the resulting struct to a <code>BTreeMap</code>. The map is then serialized.</p>
<p>This code yields the same CRD but yields expected YAML for Custom Resources:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">deployment_strategy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rolling_update</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">max_surge</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">max_unavailable</span>: <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">deployment_strategy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">recreate</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">something</span>: <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>Don&rsquo;t forget to delete the CRD, Namespace and any CRs before you finish:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>NAMES<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  kubectl get deploymentconfigs <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --output<span style="color:#f92672">=</span>name<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> NAME in <span style="color:#e6db74">${</span>NAMES<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  kubectl delete <span style="color:#e6db74">${</span>NAME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl delete crd/deploymentconfigs.example.com
</span></span></code></pre></div><p>That&rsquo;s all!</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/kubernetes/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Kubernetes</a>
   </li>
  
   <li class="list di">
     <a href="/tags/crd/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">CRD</a>
   </li>
  
   <li class="list di">
     <a href="/tags/rust/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Rust</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/201113/">Akri</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/240528/">Using Delve to debug Go containers on Kubernetes</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/240409/">Google Cloud Translation w/ gRPC 3 ways</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/240405/">Google Cloud Events protobufs and SDKs</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/240325/">Prost! Tonic w/ a dash of JSON</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/240216/">MicroK8s operability add-on</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/240130/">Navigating Koyeb&#39;s API with Rust</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/230215/">Secure (TLS) gRPC services with LKE</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/220603/">Secure (TLS) gRPC services with VKE</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/220602/">Vultr CLI and JSON output</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210305/">Prometheus VPA Recommendations</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210122/">Krustlet on DO Managed Kubernetes</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210108/">Kubernetes cert-manager</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201229/">Kubernetes Webhooks</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201217/">Kubernetes Device Plugins</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-dark-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://pretired.dazwilkin.com/" >
    &copy;  (p)retired 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>