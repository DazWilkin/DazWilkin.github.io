<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Golang Xiaomi Bluetooth Temperature|Humidity (LYWSD03MMC) 2nd Gen | (p)retired</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Golang Xiami Bluetooth temperature|humidity (LYWSD03MMC) 2nd gen">
    <meta name="generator" content="Hugo 0.148.0-DEV">
    
    
    
    
      <meta name="robots" content="index, follow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.d05fb5f317fcf33b3a52936399bdf6f47dc776516e1692e412ec7d76f4a5faa2.css" >




    
    
    
      

    

    

    <script data-goatcounter="https://pretired.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
 
    <meta property="og:url" content="https://pretired.dazwilkin.com/posts/200417/">
  <meta property="og:site_name" content="(p)retired">
  <meta property="og:title" content="Golang Xiaomi Bluetooth Temperature|Humidity (LYWSD03MMC) 2nd Gen">
  <meta property="og:description" content="Golang Xiami Bluetooth temperature|humidity (LYWSD03MMC) 2nd gen">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-04-17T00:00:00-08:00">
    <meta property="article:modified_time" content="2020-04-17T00:00:00-08:00">
    <meta property="article:tag" content="Golang">
    <meta property="article:tag" content="Xiaomi">
    <meta property="article:tag" content="BLE">
    <meta property="article:tag" content="LYWSD03MMC">

  <meta itemprop="name" content="Golang Xiaomi Bluetooth Temperature|Humidity (LYWSD03MMC) 2nd Gen">
  <meta itemprop="description" content="Golang Xiami Bluetooth temperature|humidity (LYWSD03MMC) 2nd gen">
  <meta itemprop="datePublished" content="2020-04-17T00:00:00-08:00">
  <meta itemprop="dateModified" content="2020-04-17T00:00:00-08:00">
  <meta itemprop="wordCount" content="1144">
  <meta itemprop="keywords" content="Golang,Xiaomi,BLE,LYWSD03MMC">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Golang Xiaomi Bluetooth Temperature|Humidity (LYWSD03MMC) 2nd Gen">
  <meta name="twitter:description" content="Golang Xiami Bluetooth temperature|humidity (LYWSD03MMC) 2nd gen">

      
    
	
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-dark-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        (p)retired
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Golang Xiaomi Bluetooth Temperature|Humidity (LYWSD03MMC) 2nd Gen</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2020-04-17T00:00:00-08:00">April 17, 2020</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 6 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 1144 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>Well, this became more of an adventure that I&rsquo;d originally wanted but, after learning some BLE and, with the help of others (Thanks Jonatha, JsBergbau), I&rsquo;ve sample code that connects to 4 Xiaomi 2nd gen. Thermometers, subscribes to readings and publishes the data to MQTT. From there, I&rsquo;m scraping it using Inuits <a href="">MQTTGateway</a> into Prometheus.</p>
<p>Repo: <a href="https://github.com/DazWilkin/gomijia2">https://github.com/DazWilkin/gomijia2</a></p>
<p><img src="/images/200417.prometheus.png" alt="Prometheus"></p>
<h3 id="thankscredit">Thanks|Credit:</h3>
<ul>
<li><a href="https://github.com/u1f35c">Jonathan McDowell</a> for <a href="https://github.com/u1f35c/gomijia">gomijia</a> and <a href="https://github.com/u1f35c/gomijia/issues/1">help</a></li>
<li><a href="https://github.com/JsBergbau">JsBergbau</a> for <a href="https://github.com/JsBergbau/MiTemperature2/issues/29#issuecomment-614314939">help</a></li>
</ul>
<h3 id="background">Background</h3>
<p>I&rsquo;ve been playing around with <a href="https://esphome.io">ESPHome</a> and blogged around my very positive experience <a href="/posts/200227/">ESPHome, MQTT, Prometheus and almost Cloud IoT</a>. I&rsquo;ve ordered a couple of <a href="https://www.espressif.com/en/products/hardware/esp32-devkitc-googlecloud-iot/overview">ESP32-DevKitC</a> and hope this will enable me to connect to Google <a href="https://cloud.google.com/iot-core">Cloud IoT</a>.</p>
<p>Meantime I bought 4x Xiaomi 2nd gen. Thermometers (<a href="https://www.google.com/search?q=LYWSD03MMC">LYWSD03MMC</a>). These are Bluetooth Low-Energy (BLE) enabled and are supported by ESPHome. Awaiting the ESP32s, I decided to try to connect to the devices using Golang. The Mi Home app does not find these devices.</p>
<p>I discovered Jonathan&rsquo;s <a href="https://github.com/u1f35c/gomijia">gomijia</a> but this doesn&rsquo;t work with the 2nd gen. devices. IIUC it&rsquo;s because the 2nd gen. devices don&rsquo;t advertize temperature|humidity values (the orignal device clearly does).</p>
<p>After much Googling, I discovered JsBergbau&rsquo;s Python <a href="https://github.com/JsBergbau/MiTemperature2">solution</a> and this works. Critically (!) this code uses a device handle (<a href="https://github.com/JsBergbau/MiTemperature2/blob/5cc7924430bb9d3ecb61acbf887ad8c2e1d84ab8/LYWSD03MMC.py#L192"><code>0x0038</code></a> more later) seemingly (!) to tell the device to publish temperature|humidity data on (a different) handle (<code>0x0035</code>).</p>
<p>With these samples as a guide and after a bunch more Googling about BLE, services, characteristics etc., I was able to get the code to work</p>
<h3 id="servicescharacteristicshandles">Services|Characteristics|Handles</h3>
<p>I won&rsquo;t duplicate an overview of BLE here (see <a href="#useful">Useful</a>) but, understanding a BLE device&rsquo;s <a href="https://www.bluetooth.com/specifications/gatt/">GATT</a> is critical. The Linux <a href="http://manpages.ubuntu.com/manpages/cosmic/man1/gatttool.1.html"><code>gatttool</code></a> is very useful. I found PayPay&rsquo;s Golang-based <a href="https://github.com/paypal/gatt"><code>gatt</code></a> to be most useful. Here&rsquo;s the GATT per the PayPal tool for a LYWSD03MMC device:</p>
<pre tabindex="0"><code>State: PoweredOn
Scanning...

Peripheral ID:A4:C1:38:7B:B0:1A, NAME:(LYWSD03MMC)
  Local Name        = LYWSD03MMC
  TX Power Level    = 0
  Manufacturer Data = []
  Service Data      = []

Connected
Service: 1800 (Generic Access)
Service: 1801 (Generic Attribute)
Service: 180a (Device Information)
Service: 180f (Battery Service)
Service: 000102030405060708090a0b0c0d1912

Service: ebe0ccb07a0a4b0c8a1a6ff2997da3a6
  Characteristic  ebe0ccc17a0a4b0c8a1a6ff2997da3a6
    properties    read notify 
    value         000000 | &#34;\x00\x00\x00&#34;
  Descriptor      2901 (Characteristic User Description)
    value         54656d706572617475726520616e642048756d696469 | &#34;Temperature and Humidi&#34;
  Descriptor      2902 (Client Characteristic Configuration)
    value         0000 | &#34;\x00\x00&#34;

Service: fe95
Service: 0000010000656c622e746f696d2e696d

Disconnected
Done
</code></pre><p>It&rsquo;s also possible to enumerate a list of <code>handles</code>. The following (<code>0x0036</code> and <code>0x0038</code>) were the ones of interest to me. <code>0x0038</code> is the handle that JsBergbau&rsquo;s writes to in order to trigger being able to subscribe to handle <code>0x0036</code> to read temperature|humidity data.</p>
<p>Reviewing the device&rsquo;s GATT, I remain unsure which service characteristic corresponds to handle <code>0x0038</code>. I know it has a UUID of <code>00002902-0000-1000-8000-00805f9b34fb</code> but the suffix <code>-0000-1000-8000-00805f9b34fb</code> denotes that this is a standard BLE characteristic and the <code>00002902</code> is not unique in the device&rsquo;s GATT.</p>
<p>Fortunately, the characteristic corresponding to <code>0x0036</code> does appear in the GATT as shown above (<code>ebe0ccc1-7a0a-4b0c-8a1a-6ff2997da3a6</code>) has a descriptor value of <code>Temperature and Humidi[ty]</code></p>
<table>
  <thead>
      <tr>
          <th>Handle</th>
          <th>Characteristic</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0x0036</td>
          <td>ebe0ccc1-7a0a-4b0c-8a1a-6ff2997da3a6</td>
      </tr>
      <tr>
          <td>0x0038</td>
          <td>00002902-0000-1000-8000-00805f9b34fb</td>
      </tr>
  </tbody>
</table>
<h3 id="golang">Golang</h3>
<p>The code uses <a href="https://github.com/currantlabs">currantlabs</a> <a href="https://github.com/currantlabs/ble">ble</a>. Jonathan&rsquo;s code uses a fork of this repo. I do not know what currantlabs is but the repo works. I found it to be challenging to understand the code particularly in enumerating devices, services, characteristics etc. I will focus the rest of this discussion on my (!?) understanding of how the code works. I&rsquo;d value feedback on my misunderstandings.</p>
<p>First step is to create a Linux (BLE) Device (host) and then use this to connect to BLE devices:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#a6e22e">host</span>,<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">linux</span>.<span style="color:#a6e22e">NewDevice</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ble</span>.<span style="color:#a6e22e">WithSigHandler</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">1</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">device</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">host</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">ble</span>.<span style="color:#a6e22e">NewAddr</span>(<span style="color:#e6db74">&#34;a4:c1:38:00:00:00&#34;</span>))
</span></span></code></pre></div><blockquote>
<p><strong>TODO</strong>: I&rsquo;ve been meaning to run each device in its own Goroutine. When I tried this previously, I think I experienced concurrency problems. Will retry.</p></blockquote>
<p>The next step is the magical step that writes a magical value <code>0x1000</code> to the magical handler <code>0x0038</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#a6e22e">c</span><span style="color:#f92672">:=</span><span style="color:#a6e22e">ble</span>.<span style="color:#a6e22e">MustParse</span>(<span style="color:#e6db74">&#34;00002902-0000-1000-8000-00805f9b34fb&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bleClient</span>.<span style="color:#a6e22e">DiscoverProfile</span>(<span style="color:#66d9ef">true</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Find</span>(<span style="color:#a6e22e">ble</span>.<span style="color:#a6e22e">NewCharacteristic</span>(<span style="color:#a6e22e">c</span>)); <span style="color:#a6e22e">u</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bleClient</span>.<span style="color:#a6e22e">WriteCharacteristic</span>(<span style="color:#a6e22e">u</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">ble</span>.<span style="color:#a6e22e">Characteristic</span>), []<span style="color:#66d9ef">byte</span>{<span style="color:#ae81ff">0x10</span>,<span style="color:#ae81ff">0x00</span>}, <span style="color:#66d9ef">false</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p><strong>NB</strong> I don&rsquo;t know why this works!</p></blockquote>
<p>The Golang library requires characteristics to be used instead of handles. Using one of the command-line tools, I was able to enumerate all the handles and their associated characteristics. From other code, I learned that <code>0x0038</code> is critical and <code>00002902-0000-1000-8000-00805f9b34fb</code> is the characteristic that corresponds to this handle.</p>
<p>I learned (!?) that the library requires <code>DiscoverProfile(true)</code> to be called against the device before other commands will work correctly. After discovering the profile, the code then searches it for the characteristic we&rsquo;re interested in and then it writes <code>0x1000</code> to it.</p>
<blockquote>
<p><strong>TODO</strong>: I&rsquo;ve been meaning to duplicate this approach of <code>Find(...)</code> in the next section to avoid iterating over services and characteristics.</p></blockquote>
<p>Now that the value is written to <code>0x0038</code>, we can look for <code>0x0036</code> and subscribe to notifications from it.</p>
<p>This involves (currently but see <code>TODO</code> above) iterating over services that match the filter for the service (<code>ebe0ccb07a0a4b0c8a1a6ff2997da3a6</code>) shown in the GATT above that includes the characteristic (<code>ebe0ccc17a0a4b0c8a1a6ff2997da3a6</code>) that corresponds to <code>&quot;Temperature and Humidi[ty]&quot;</code>.</p>
<p>Again, It appears a requirement to iterate over all the characteristics Descriptors even though I don&rsquo;t reference these!</p>
<p>The key section is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Property</span> <span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">ble</span>.<span style="color:#a6e22e">CharNotify</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">CCCD</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">UUID</span>.<span style="color:#a6e22e">Equal</span>(<span style="color:#a6e22e">ble</span>.<span style="color:#a6e22e">MustParse</span>(<span style="color:#e6db74">&#34;ebe0ccc1-7a0a-4b0c-8a1a-6ff2997da3a6&#34;</span>)) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">Subscribe</span>(<span style="color:#a6e22e">c</span>, <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">handlerPublisher</span>(<span style="color:#f92672">...</span>)); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p><strong>NB</strong> <code>CCCD</code> means <code>Client Characteristic Configuration Descriptor</code> and this must be non-nil to be able tos subscribe to the characteristic.</p></blockquote>
<p>The initial <code>if</code> checks whether this characteristic supports notifications (<code>ble.CharNotify</code>)</p>
<p>If this characteristic is the one corresponding to <code>0x0036</code> (i.e. <code>ebe0ccc1-7a0a-4b0c-8a1a-6ff2997da3a6</code>) then we add a handler to its notifications.</p>
<p>The handler is trivial:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">req</span> []<span style="color:#66d9ef">byte</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hex</span>.<span style="color:#a6e22e">EncodeToString</span>(<span style="color:#a6e22e">req</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Unmarshall</span>(<span style="color:#a6e22e">req</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Unable to unmarshal data (%s)&#34;</span>, <span style="color:#a6e22e">s</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The Unmarshall step is also a black box to me. I don&rsquo;t know where this is duplicated but I used Fabien&rsquo;s bash <a href="http://www.d0wn.com/using-bash-and-gatttool-to-get-readings-from-xiaomi-mijia-lywsd03mmc-temperature-humidity-sensor/">script</a> as a guide:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Reading</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Temperature</span> <span style="color:#66d9ef">float64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Humidity</span>    <span style="color:#66d9ef">float64</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Unmarshall</span>(<span style="color:#a6e22e">req</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Reading</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 00 01 02 03 04</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// T2 T1 HX ?? ??</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">req</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">l</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">5</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[X] Expecting 5 bytes; got %d&#34;</span>, <span style="color:#a6e22e">l</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Reading</span>{}, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Expecting 5 bytes got %d&#34;</span>, <span style="color:#a6e22e">l</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Temperature is stored little endian</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> float64(int(<span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">LittleEndian</span>.<span style="color:#a6e22e">Uint16</span>(<span style="color:#a6e22e">req</span>[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">2</span>]))) <span style="color:#f92672">/</span> <span style="color:#ae81ff">100.0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> float64(<span style="color:#a6e22e">req</span>[<span style="color:#ae81ff">2</span>]) <span style="color:#f92672">/</span> <span style="color:#ae81ff">100.0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Reading</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Temperature</span>: <span style="color:#a6e22e">t</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Humidity</span>:    <span style="color:#a6e22e">h</span>,
</span></span><span style="display:flex;"><span>	}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p><strong>NB</strong> I don&rsquo;t know what the other 2 bytes represent :-(</p></blockquote>
<h3 id="mqtt--mqttgateway">MQTT | <a href="https://github.com/inuits/mqttgateway">MQTTGateway</a></h3>
<p>The MQTT publishing is straightforward. I&rsquo;m using Inuits <a href="https://github.com/inuits/mqttgateway">MQTTGateway</a> as described in the other post on ESPHome. The MQTTGateway subscribes to MQTT topics and converts these into Prometheus metrics. It&rsquo;s then trivial to scrape these using Prometheus to produce the graph shown at the top of the post.</p>
<h3 id="useful">Useful</h3>
<ul>
<li>Nordic Semiconductor has excellent resources including <a href="https://www.nordicsemi.com/Software-and-tools/Development-Tools/nRF-Connect-for-mobile">nRF Connect for Mobile</a></li>
<li>Snippet from <a href="https://www.oreilly.com/library/view/getting-started-with/9781491900550/ch04.html">O&rsquo;Reilly: &ldquo;Getting Started with Bluetooth Low Energy&rdquo;</a> very useful</li>
<li>Fabien&rsquo;s <a href="http://www.d0wn.com/using-bash-and-gatttool-to-get-readings-from-xiaomi-mijia-lywsd03mmc-temperature-humidity-sensor/">bash</a> script</li>
</ul>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/golang/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Golang</a>
   </li>
  
   <li class="list di">
     <a href="/tags/xiaomi/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Xiaomi</a>
   </li>
  
   <li class="list di">
     <a href="/tags/ble/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">BLE</a>
   </li>
  
   <li class="list di">
     <a href="/tags/lywsd03mmc/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">LYWSD03MMC</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/200325/">gRPC, Cloud Run &amp; Endpoints</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200320/">Golang gRPC Cloud Run</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200226/">OriginStamp: Verifying Proofs</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200219/">FreeTSA &amp; Digitorus&#39; Timestamp SDK</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200217/">OriginStamp Python|Golang SDK Examples</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200206/">Cloud Build wishlist: Mountable Golang Modules Proxy</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200122/">Setting up a GCE Instance as an Inlets Exit Node</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200110/">Google Fit</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200107/">Google Home Exporter</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/191220/">Google Cloud Platform (GCP) Exporter</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/191218/">Linode Prometheus Exporter</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190926/">PyPi Transparency</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190918/">Cloud Functions Simple(st) HTTP Multi-host Proxy</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190917/">Cloud Functions Simple(st) HTTP Proxy</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190907/">pypi-transparency</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-dark-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://pretired.dazwilkin.com/" >
    &copy;  (p)retired 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>