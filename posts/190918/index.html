<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>(p)retired  | Cloud Functions Simple(st) HTTP Multi-host Proxy</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.59.0-DEV" />
    
    
      <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
    

    
    
      <link href="/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="Cloud Functions Simple(st) HTTP Multi-host Proxy" />
<meta property="og:description" content="Tweaked yesterday&rsquo;s solution so that it will randomly select one from several hosts with which it&rsquo;s configured.
package proxy import ( &quot;log&quot; &quot;math/rand&quot; &quot;net/http&quot; &quot;net/url&quot; &quot;os&quot; &quot;strings&quot; &quot;time&quot; ) func robin() { hostsList := os.Getenv(&quot;PROXY_HOST&quot;) if hostsList == &quot;&quot; { log.Fatal(&quot;&#39;PROXY_HOST&#39; environment variable should contain comma-separated list of hosts&quot;) } // Comma-separated lists of hosts hosts := strings.Split(hostsList, &quot;,&quot;) urls := make([]*url.URL, len(hosts)) for i, host := range hosts { var origin = Endpoint{ Host: host, Port: os." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pretired.dazwilkin.com/posts/190918/" />
<meta property="article:published_time" content="2019-09-18T12:45:00-07:00" />
<meta property="article:modified_time" content="2019-09-18T12:45:00-07:00" />
<meta itemprop="name" content="Cloud Functions Simple(st) HTTP Multi-host Proxy">
<meta itemprop="description" content="Tweaked yesterday&rsquo;s solution so that it will randomly select one from several hosts with which it&rsquo;s configured.
package proxy import ( &quot;log&quot; &quot;math/rand&quot; &quot;net/http&quot; &quot;net/url&quot; &quot;os&quot; &quot;strings&quot; &quot;time&quot; ) func robin() { hostsList := os.Getenv(&quot;PROXY_HOST&quot;) if hostsList == &quot;&quot; { log.Fatal(&quot;&#39;PROXY_HOST&#39; environment variable should contain comma-separated list of hosts&quot;) } // Comma-separated lists of hosts hosts := strings.Split(hostsList, &quot;,&quot;) urls := make([]*url.URL, len(hosts)) for i, host := range hosts { var origin = Endpoint{ Host: host, Port: os.">


<meta itemprop="datePublished" content="2019-09-18T12:45:00-07:00" />
<meta itemprop="dateModified" content="2019-09-18T12:45:00-07:00" />
<meta itemprop="wordCount" content="353">



<meta itemprop="keywords" content="Go,gRPC," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cloud Functions Simple(st) HTTP Multi-host Proxy"/>
<meta name="twitter:description" content="Tweaked yesterday&rsquo;s solution so that it will randomly select one from several hosts with which it&rsquo;s configured.
package proxy import ( &quot;log&quot; &quot;math/rand&quot; &quot;net/http&quot; &quot;net/url&quot; &quot;os&quot; &quot;strings&quot; &quot;time&quot; ) func robin() { hostsList := os.Getenv(&quot;PROXY_HOST&quot;) if hostsList == &quot;&quot; { log.Fatal(&quot;&#39;PROXY_HOST&#39; environment variable should contain comma-separated list of hosts&quot;) } // Comma-separated lists of hosts hosts := strings.Split(hostsList, &quot;,&quot;) urls := make([]*url.URL, len(hosts)) for i, host := range hosts { var origin = Endpoint{ Host: host, Port: os."/>

      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-148669951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://pretired.dazwilkin.com/" class="f3 fw2 hover-white no-underline white-90 dib">
      (p)retired
    </a>
    <div class="flex-l items-center">
      

      
      











    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">Cloud Functions Simple(st) HTTP Multi-host Proxy</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2019-09-18T12:45:00-07:00">September 18, 2019</time>
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>Tweaked yesterday&rsquo;s solution so that it will randomly select one from several hosts with which it&rsquo;s configured.</p>

<pre><code class="language-Golang">package proxy

import (
	&quot;log&quot;
	&quot;math/rand&quot;
	&quot;net/http&quot;
	&quot;net/url&quot;
	&quot;os&quot;
	&quot;strings&quot;
	&quot;time&quot;
)

func robin() {
	hostsList := os.Getenv(&quot;PROXY_HOST&quot;)
	if hostsList == &quot;&quot; {
		log.Fatal(&quot;'PROXY_HOST' environment variable should contain comma-separated list of hosts&quot;)
	}
    // Comma-separated lists of hosts
    hosts := strings.Split(hostsList, &quot;,&quot;)
    
    urls := make([]*url.URL, len(hosts))
    for i, host := range hosts {
		var origin = Endpoint{
			Host: host,
			Port: os.Getenv(&quot;PROXY_PORT&quot;),
		}
		url, err := origin.URL()
		if err != nil {
			log.Fatal(err)
		}
		urls[i] = url
	}

	s := rand.NewSource(time.Now().UnixNano())
	q := rand.New(s)

	Handler = func(w http.ResponseWriter, r *http.Request) {
		// Pick one of the URLs at random
		url := urls[q.Int31n(int32(len(urls)))]
		log.Printf(&quot;[Handler] Forwarding: %s&quot;, url.String())
        // Forward to it
        reverseproxy(url, w, r)
	}
}
</code></pre>

<p>This requires a minor tweak to the deployment to escape the commas within the <code>PROXY_HOST</code> string to disambiguate these for <code>gcloud</code>:</p>

<pre><code class="language-bash">FUNCTION=multi
gcloud functions deploy ${FUNCTION} \
--entry-point=Handler \
--runtime=go111 \
--set-env-vars=^:^PROXY_HOST=${NODEHOSTS}:PROXY_PORT=${NODEPORT} \
--trigger-http \
--project=${PROJECT}
</code></pre>

<p><strong>NB</strong> The <code>--set-env-vars</code> flag is followed by <code>^:^</code> to denote the command uses <code>:</code> instead of <code>,</code> because the value of <code>${HOSTS}</code> contains commas</p>

<p>How to get the list of hosts? Assuming</p>

<pre><code class="language-bash">SERVICE=nginx
NODEPORT=$(\
  kubectl get service/${SERVICE} \
  --output=jsonpath=&quot;{.spec.ports[0].nodePort}&quot;)

TAG=$(\
  gcloud compute instances list \
  --project=${PROJECT} \
  --format=&quot;value(tags.items)&quot; \
  | shuf --head-count=1) \
&amp;&amp; echo ${TAG}

FIREWALL=lb
gcloud compute firewall-rules create ${FIREWALL} \
--project=${PROJECT}  \
--network=default \
--action=ALLOW \
--rules=tcp:${NODEPORT} \
--target-tags=microk8s

NODEHOSTS=$(\
  gcloud compute instances list \
  --project=${PROJECT} \
  --filter=&quot;tags.items=${TAG}&quot; \
  --format=&quot;value(networkInterfaces[0].accessConfigs[0].natIP)&quot; \
  | tr '\n' ',' \
  | sed 's|,*$||g') \
&amp;&amp; echo $HOSTS
</code></pre>

<p><strong>NB</strong> This is hacky because it picks a tag randomly from the project&rsquo;s instances&rsquo; tags</p>

<p>Once deployed:</p>

<pre><code class="language-bash">ENDPOINT=$(\
  gcloud functions describe ${FUNCTION} \
  --project=$PROJECT \
  --format=&quot;value(httpsTrigger.url)&quot;)
  curl \
  --silent \
  --write-out &quot;%{http_code}&quot; \
  --output /dev/null \
  ${ENDPOINT}
</code></pre>

<p>Attempting to determine how efficient the process is:</p>

<pre><code class="language-bash">gcloud logging read &quot;resource.type=\&quot;cloud_function\&quot; resource.labels.function_name=\&quot;${FUNCTION}\&quot;&quot; \
--project=$PROJECT \
--freshness=1d \
--format=json \
| jq --raw-output .[].textPayload \
| egrep -o &quot;\[Handler\] Forwarding: http://[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}.[0-9]{1,3}:30536&quot; \
| awk '{print $3}' \
| sort \
| uniq -c
    103 http://HOST-1:30536
    124 http://HOST-2:30536
    105 http://HOST-3:30536
</code></pre>

<p>So, not bad ;-)</p>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/go" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Go</a>
   </li>
  
   <li class="list">
     <a href="/tags/grpc" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">gRPC</a>
   </li>
  
</ul>
<div class="mt6">
      
      
      </div>
    </section>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/190917/">Cloud Functions Simple(st) HTTP Proxy</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190907/">pypi-transparency</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://pretired.dazwilkin.com/" >
    &copy; 2019 (p)retired
  </a>
    <div>










</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
