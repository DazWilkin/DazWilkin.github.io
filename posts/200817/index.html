<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>WASM Transparency | (p)retired</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="A Google Trillian solution that enables WASM binaries to be shipped to and run from a remote gRPC server">
    <meta name="generator" content="Hugo 0.148.0-DEV">
    
    
    
    
      <meta name="robots" content="index, follow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.8d048772ae72ab11245a0e296d1f2a36d3e3dd376c6c867394d6cc659c68fc37.css" >




    

    
    
      

    

    

    <script data-goatcounter="https://pretired.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
 
    <meta property="og:url" content="https://pretired.dazwilkin.com/posts/200817/">
  <meta property="og:site_name" content="(p)retired">
  <meta property="og:title" content="WASM Transparency">
  <meta property="og:description" content="A Google Trillian solution that enables WASM binaries to be shipped to and run from a remote gRPC server">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-08-17T00:00:00-07:00">
    <meta property="article:modified_time" content="2020-08-17T00:00:00-07:00">
    <meta property="article:tag" content="Wasm">
    <meta property="article:tag" content="Wapc">
    <meta property="article:tag" content="Rust">
    <meta property="article:tag" content="Golang">
    <meta property="article:tag" content="Trillian">
    <meta property="article:tag" content="Protobufs">

  <meta itemprop="name" content="WASM Transparency">
  <meta itemprop="description" content="A Google Trillian solution that enables WASM binaries to be shipped to and run from a remote gRPC server">
  <meta itemprop="datePublished" content="2020-08-17T00:00:00-07:00">
  <meta itemprop="dateModified" content="2020-08-17T00:00:00-07:00">
  <meta itemprop="wordCount" content="2371">
  <meta itemprop="keywords" content="Wasm,Wapc,Rust,Golang,Trillian,Protobufs,Gprc">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="WASM Transparency">
  <meta name="twitter:description" content="A Google Trillian solution that enables WASM binaries to be shipped to and run from a remote gRPC server">

      
    
	
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-dark-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        (p)retired
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">WASM Transparency</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2020-08-17T00:00:00-07:00">August 17, 2020</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 12 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 2371 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>I&rsquo;ve been playing around with a proof-of-concept combining WASM and <a href="https://github.com/google/trillian">Trillian</a>. The hypothesis was to explore using WASM as a form of chaincode with Trillian. The project works but it&rsquo;s far from being a chaincode-like solution.</p>
<p>Let&rsquo;s start with a couple of (trivial) examples and then I&rsquo;ll explain what&rsquo;s going on and how it&rsquo;s implemented.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>2020/08/14 18:42:17 [main:loop:dynamic-invoke] Method: mul
</span></span><span style="display:flex;"><span>2020/08/14 18:42:17 [random:New] Message
</span></span><span style="display:flex;"><span>2020/08/14 18:42:17 [random:New] Float32
</span></span><span style="display:flex;"><span>2020/08/14 18:42:17 [random:New] Float32
</span></span><span style="display:flex;"><span>2020/08/14 18:42:17 [random:New] Message
</span></span><span style="display:flex;"><span>2020/08/14 18:42:17 [random:New] Float32
</span></span><span style="display:flex;"><span>2020/08/14 18:42:17 [random:New] Float32
</span></span><span style="display:flex;"><span>2020/08/14 18:42:17 [Client:Invoke] Metadata: complex.wasm
</span></span><span style="display:flex;"><span>2020/08/14 18:42:17 [main:loop:dynamic-invoke] Success: result:{real:0.036980484 imag:0.3898267}
</span></span></code></pre></div><p>After shipping a Rust-sourced WASM solution (<code>complex.wasm</code>) to the WASM transparency server, the client invokes a method <code>mul</code> that&rsquo;s exposed by it using a dynamically generated request message and outputs the response. Woo hoo! Yes, an expensive way to multiple complex numbers.</p>
<p>Also:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>2020/08/14 18:42:28 [main:loop:dynamic-invoke] Method: create
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [random:New] String
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [random:New] Message
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [random:New] String
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [random:New] String
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [random:New] String
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [random:New] String
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [Client:Invoke] Metadata: fabcarx.wasm
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [main:loop:dynamic-invoke] Success: car:{manufacturer:&#34;X&#34;  model:&#34;X&#34;  color:&#34;X&#34;  owner:&#34;X&#34;}
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [main:loop:dynamic-invoke] Method: query
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [random:New] String
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [Client:Invoke] Metadata: fabcarx.wasm
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [main:loop:dynamic-invoke] Success: car:{manufacturer:&#34;X&#34;  model:&#34;X&#34;  color:&#34;X&#34;  owner:&#34;X&#34;}
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [main:loop:dynamic-invoke] Method: change_owner
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [random:New] String
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [random:New] String
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [Client:Invoke] Metadata: fabcarx.wasm
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [main:loop:dynamic-invoke] Success: car:{manufacturer:&#34;X&#34;  model:&#34;X&#34;  color:&#34;X&#34;  owner:&#34;X&#34;}
</span></span><span style="display:flex;"><span>2020/08/14 18:42:28 [main:loop:dynamic-invoke] Complete
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> I need to improve the randon message generator for strings so that the value is not always <code>X</code>; <code>change_owner</code> does work (<a href="https://github.com/DazWilkin/go-protobuf-extras/issues/1">issue</a>)</p></blockquote>
<p>Way back when I first began exploring blockchain technologies, I played around with Hyperledger. It has a prototypical example called <a href="https://hyperledger-fabric.readthedocs.io/en/release-1.4/write_first_app.html">fabcar</a> and the above shows a WASM Transparency version of this app. After the <code>fabcarx.wasm</code> binary is shipped to the WAM Transparency server, the client invokes <code>create</code>, <code>query</code> and then <code>change_owner</code> methods exposed by it.</p>
<p>So, why is any of this complexity of any value?</p>
<p>The WASM binaries use <a href="https://github.com/wapc">waPC</a> to transfer arbitrary data between the Transparency server&rsquo;s Golang WASM host and the Rust WASM guests. In order to provide structure to this data, the solution uses <a href="https://developers.google.com/protocol-buffers">protocol buffers</a>. Specifically, starting with a protobuf definition that includes one of more <code>service</code> definitions, the Rust-based WASM code implements the protobuf services. A protobuf Descriptor file is generated from the protobuf sources too. The Descriptor (as metadata) is associated with the WASM binary. Descriptors are machine-readable variants of protobuf files and permit the Golang host to dynamically create clients.</p>
<p>A client uploads the WASM binary and its descriptor file to the Transparency server. The client (and server) computes RFC6962 hashes of the binary. The client must provide the server with this hash to get or invoke the binary. The client uses the returned Descriptor to enumerate the services exposed by the WASM binary and create request messages for these services. The client invokes services using the request message and uses the Descriptor to unmarshal the results.</p>
<p>The client envelopes these arbitrary requests and responses into protobuf&rsquo;s well-known type <a href="https://pkg.go.dev/google.golang.org/protobuf/types/known/anypb?tab=doc"><code>Any</code></a>. This permits a specific RPC to represent arbitrary WASM function request|response types. Conveniently <code>Any</code> is the combination of a unique type URL and a slice of bytes. waPC uses slices of bytes as its encoding for data between WASM host and WASM guests.</p>
<p>The full flow to invoke a function is thus:</p>
<ol>
<li>Client initiates connection with the Transparency server.</li>
<li>Client gets metadata for a (previously added) WASM binary.</li>
<li>Client parses Descriptor, identifies a service and determines the service&rsquo;s input and output message descriptors.</li>
<li>Client dynamically constructs a request message (using a <a href="https://github.com/DazWilkin/go-protobuf-extras">random message generator</a> in this case)</li>
<li>Client marshals the message into <code>Any</code> (<code>[]byte</code>) and sends, with the function name and WASM binary name to the server.</li>
<li>Server determines whether it has the WASM binary (using its hash)</li>
<li>Server unmarshals the <code>Any</code> into the service&rsquo;s input type using the associated Descriptor.</li>
<li>Server uses waPC to invoke the designated WASM function with the request parameters and receives the result</li>
<li>Server envelopes the <code>Any</code> result into a response message that it returns to the Client</li>
<li>Client uses Descriptor to unmarshal the <code>Any</code> into a dynamically constructed message and outputs it</li>
</ol>
<p>Let&rsquo;s walk through these components with some code snippets.</p>
<h2 id="protobuf-descriptor-sets">Protobuf Descriptor (Sets)</h2>
<p>There&rsquo;s not (!?) <a href="https://developers.google.com/protocol-buffers/docs/techniques#self-description">much</a> by way of documentation explaining protobuf descriptor (set) files. See the <code>protoc</code> command below which shows how to generate a descriptor file for the protobuf examples used in this solution. Descriptor files are binary equivalents of the human-readable <code>*.proto</code> (protobuf) sources. Google&rsquo;s <a href="https://pkg.go.dev/google.golang.org/protobuf?tab=overview">Golang protobuf APIv2</a> includes various packages that manipulate Descriptors and can create dynamic messages using these, e.g. <a href="https://pkg.go.dev/google.golang.org/protobuf/reflect/protoreflect?tab=doc">protoreflect</a> and <a href="https://pkg.go.dev/google.golang.org/protobuf/types/dynamicpb?tab=doc">dynamicpb</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>MODULE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;github.com/DazWilkin/go-wasm-transparency&#34;</span>
</span></span><span style="display:flex;"><span>protoc <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--proto_path<span style="color:#f92672">=</span>./examples <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--descriptor_set_out<span style="color:#f92672">=</span>./examples/descriptor.pb <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--go_out<span style="color:#f92672">=</span>plugins<span style="color:#f92672">=</span>grpc,module<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>MODULE<span style="color:#e6db74">}</span>:. <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>./examples/*.proto
</span></span></code></pre></div><p>The descriptor file (as in this case) represents multiple <code>*.proto</code> files. Each protobuf file represents multiple services and can contain multiple message types etc. One service though binds an input message type with an output message type. As a result, the following uniquely (and sufficiently) define a WASM function for it be invoked:</p>
<table>
  <thead>
      <tr>
          <th>Metadata</th>
          <th>Role</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>WASM binary</td>
          <td>One or more WASM function(s) that have a signature <code>fn: Any --&gt; Any</code></td>
      </tr>
      <tr>
          <td>Descriptor Set</td>
          <td>A binary format protobuf that includes one of more protobuf files that define the WASM functions as protobuf services and messages</td>
      </tr>
      <tr>
          <td>Protobuf Package</td>
          <td>Services and messages within a proto are namespaced by the protobuf&rsquo;s package name</td>
      </tr>
      <tr>
          <td>Protobuf Service</td>
          <td>Protobuf services correspond 1:1 with WASM functions; a service&rsquo;s input and output correspond to the functions request and response</td>
      </tr>
      <tr>
          <td>Input Message</td>
          <td>The message to be sent</td>
      </tr>
      <tr>
          <td>Output Message</td>
          <td>The message that will be received is created dynamically knowing its type from the result</td>
      </tr>
  </tbody>
</table>
<blockquote>
<p><strong>NOTE</strong> in this prototype, the input message is randomly-generated</p></blockquote>
<p>There are 2 levels of Protobuf serivces|messages here. The primary level is the WASM Transparency Service&rsquo;s protobufs, e.g.:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#f92672">package</span> wasm_transparency<span style="color:#f92672">.</span>v1;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">service</span> WASMTransparency {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#f92672">...</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">rpc</span> Get(GetRequest) <span style="color:#66d9ef">returns</span> (GetResponse) {};<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#f92672">...</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">GetRequest</span> {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    Metadata metadata <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">GetResponse</span> {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">bytes</span> content <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">string</span> error <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>This level defines the messages used by the client to invoke methods on the server.</p>
<p>However, because the server must be capable of invoking <em>arbitrary</em> WASM functions and because these WASM functions are defined by protobufs and because protobufs does not support generic message types, the solution envelopes this second level of protobufs using <code>Any</code> as described by the previous reference.</p>
<blockquote>
<p><strong>NOTE</strong> Protobuf <code>Any</code> combine a type and a value (<code>[]byte</code>) and conveniently waPC uses <code>[]byte</code> as the data type between hosts and guests.</p></blockquote>
<p>So, for example <code>complex.proto</code> defines the 4 functions exported by <code>complex.wasm</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#f92672">package</span> examples;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">service</span> ComplexService {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">rpc</span> add(ComplexRequest) <span style="color:#66d9ef">returns</span> (ComplexResponse);<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">rpc</span> sub(ComplexRequest) <span style="color:#66d9ef">returns</span> (ComplexResponse);<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">rpc</span> mul(ComplexRequest) <span style="color:#66d9ef">returns</span> (ComplexResponse);<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">rpc</span> div(ComplexRequest) <span style="color:#66d9ef">returns</span> (ComplexResponse);<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">ComplexRequest</span> {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    Complex a <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    Complex b <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">ComplexResponse</span> {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    Complex result <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">string</span> error <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Complex</span> {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">float</span> real <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">float</span> imag <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Messages sent by the Client would be e.g. of type <code>GetRequest</code> containing the metadata described in the table above that&rsquo;s sufficient to invoke a function. In practice, this would include a Descriptor representing <code>complex.proto</code> and an instance of <code>ComplexRequest</code> (as <code>Any</code>) that provides the request parameters.</p>
<h2 id="randomly-generated-messages">Randomly-generated Messages</h2>
<p>By way of explaining how the Client is able to generate messages to be used to invoke the WASM functions, let&rsquo;s detour through <a href="https://github.com/DazWilkin/go-protobuf-extras">go-protobuf-extras</a> because it generates random protobuf messages from Descriptors.</p>
<p>It does this use a single, straightforward function with an extensive switch statement:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Message</span>(<span style="color:#a6e22e">md</span> <span style="color:#a6e22e">protoreflect</span>.<span style="color:#a6e22e">MessageDescriptor</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">dynamicpb</span>.<span style="color:#a6e22e">Message</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dynamicpb</span>.<span style="color:#a6e22e">NewMessage</span>(<span style="color:#a6e22e">md</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fds</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">md</span>.<span style="color:#a6e22e">Fields</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Iterate over *all* fields</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">k</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">k</span> &lt; <span style="color:#a6e22e">fds</span>.<span style="color:#a6e22e">Len</span>(); <span style="color:#a6e22e">k</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fds</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">k</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">protoreflect</span>.<span style="color:#a6e22e">Value</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">result</span> <span style="color:#a6e22e">protoreflect</span>.<span style="color:#a6e22e">Value</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">fd</span>.<span style="color:#a6e22e">Kind</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">protoreflect</span>.<span style="color:#a6e22e">Int32Kind</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[random:New] Int32&#34;</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">result</span> = <span style="color:#a6e22e">protoreflect</span>.<span style="color:#a6e22e">ValueOfInt32</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Int31</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">protoreflect</span>.<span style="color:#a6e22e">FloatKind</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[random:New] Float32&#34;</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">result</span> = <span style="color:#a6e22e">protoreflect</span>.<span style="color:#a6e22e">ValueOfFloat32</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Float32</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">protoreflect</span>.<span style="color:#a6e22e">MessageKind</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[random:New] Message&#34;</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">md</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fd</span>.<span style="color:#a6e22e">Message</span>()
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">result</span> = <span style="color:#a6e22e">protoreflect</span>.<span style="color:#a6e22e">ValueOfMessage</span>(<span style="color:#a6e22e">Message</span>(<span style="color:#a6e22e">md</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">protoreflect</span>.<span style="color:#a6e22e">StringKind</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;[random:New] String&#34;</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">result</span> = <span style="color:#a6e22e">protoreflect</span>.<span style="color:#a6e22e">ValueOfString</span>(<span style="color:#e6db74">&#34;X&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;[random:New] unanticipated kind&#34;</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#a6e22e">fd</span>, <span style="color:#a6e22e">v</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> this function is incomplete and does not (yet) cover all possible <code>kinds</code>.</p></blockquote>
<h2 id="client">Client</h2>
<p>The function uses the Golang APIv2 <code>dynamicpb</code> package to create an empty protobuf message of the desired type (<code>protoreflect.MessageDescriptor</code>). For each of the <code>Fields</code> in the <code>MessageDescriptor</code> the function simply determines the type and creates a random value of that type. As you&rsquo;ll see, <code>MessageDescriptor</code> is determined by parsing the protobuf Descriptor file.</p>
<p>The client creates a <code>FileDescriptorSet</code> and unmarshals the Descriptor Set file&rsquo;s contents into it. It then creates a <code>protodesc</code> files registry that enables <code>FindDescriptorByName</code>. In this case, it uses a specific service descriptor i.e. <code>examples.ComplexServer</code> (the full name is scoped by the package name). It then iterates over all the methods (<code>add</code>, <code>sub</code>, <code>mul</code> and <code>div</code>) that are defined within the service. For a specific method e.g. <code>mul</code> defined to be <code>rpc mul(ComplexRequest) returns (ComplexResponse)</code>, it grabs the input (<code>ComplexRequest</code>) message descriptor and creates a new dynamic, random message using it.</p>
<p>In order to invoke the WASM function on the server, the e.g. <code>ComplexRequest</code> is marshaled into an <code>Any</code> and this is used as the <code>Parameters</code> value in the <code>InvokeRequest</code>. Not shown here is the reverse process given the <code>InvokeResponse</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#75715e">// Load and parse the descriptor file</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">egDescriptorSet</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">descriptorpb</span>.<span style="color:#a6e22e">FileDescriptorSet</span>{}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metadata</span>().<span style="color:#a6e22e">DescriptorFile</span>.<span style="color:#a6e22e">Content</span>, <span style="color:#a6e22e">egDescriptorSet</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Create a files registry</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">files</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protodesc</span>.<span style="color:#a6e22e">NewFiles</span>(<span style="color:#a6e22e">egDescriptorSet</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Lookup the service</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fullname</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">DescriptorFile</span>.<span style="color:#a6e22e">FullServiceName</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">d</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">files</span>.<span style="color:#a6e22e">FindDescriptorByName</span>(<span style="color:#a6e22e">protoreflect</span>.<span style="color:#a6e22e">FullName</span>(<span style="color:#a6e22e">fullname</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Assert it into a ServiceDescriptor</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">d</span>.(<span style="color:#a6e22e">protoreflect</span>.<span style="color:#a6e22e">ServiceDescriptor</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Use the ServiceDescriptor to lookup the methods</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mds</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Methods</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> &lt; <span style="color:#a6e22e">mds</span>.<span style="color:#a6e22e">Len</span>(); <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Get this MethodDescriptor</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">md</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mds</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">j</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Get the MessageDescriptor for the service&#39;s method&#39;s input</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">md</span>.<span style="color:#a6e22e">Input</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// New-up an random params message</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">params</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">random</span>.<span style="color:#a6e22e">Message</span>(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">b</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">params</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">any</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">anypb</span>.<span style="color:#a6e22e">Any</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">TypeUrl</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Value</span>:   <span style="color:#a6e22e">b</span>,
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">rqst</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">InvokeRequest</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Metadata</span>: <span style="color:#a6e22e">wasm</span>.<span style="color:#a6e22e">FromMetadata</span>(<span style="color:#a6e22e">m</span>),
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Request</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">FunctionRequest</span>{
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">Name</span>:       string(<span style="color:#a6e22e">md</span>.<span style="color:#a6e22e">Name</span>()),
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">Parameters</span>: <span style="color:#66d9ef">any</span>,
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="server">Server</h2>
<p>The server comprises 3 components:</p>
<ol>
<li>gRPC server</li>
<li>Trillian personality</li>
<li>waPC host and guests</li>
</ol>
<p>The gRPC server implementation is straightforward. It implements <code>Add</code>, <code>Get</code> and <code>Invoke</code> methods as defined in <code>wasm_transparency.proto</code>. These respectively, add a WASM binary and metadata to the server, get an existing WASM binary by its metadata and, most interestingly, permit clients to remotely invoke WASM functions.</p>
<p>I&rsquo;ve discussed using Trillian <a href="/tags/trillian/">elsewhere</a>. Suffice to say that, this personality is very similar to the others with the exception that the client uses RFC6962 hashing (rather than pure SHA-256) in order to identify a specific WASM binary. See the spec&rsquo;s <a href="https://tools.ietf.org/html/rfc6962#section-2.1">section 2.1</a> for more details on hashing leaves. <code>Add</code> adds the WASM binary to Trillian, <code>Get</code> and <code>Invoke</code> look up existing binaries.</p>
<h3 id="golang-wapc-host">Golang waPC Host</h3>
<p>When a client seeks to invoke a WASM binary&rsquo;s function, the server retrieves the binary from Trillian and then creates a waPC host instance of it. In order to expedite invocations, if the server&rsquo;s waPC host has previously invoked a function on the binary, there&rsquo;s no need to retrieve the binary from Trillian again. Instead the server reuses an existing copy of the instance.</p>
<p>The client submitted the request parameters enveloped within the <code>InvokeRequest</code> as part of the <code>FunctionRequest</code>. This parameters are already marshaled into <code>Any</code> (<code>[]byte</code>).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span>syntax <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;proto3&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> wasm_transparency<span style="color:#f92672">.</span>v1;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">FunctionRequest</span> {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">string</span> name <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    google.protobuf.Any parameters <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">FunctionResponse</span> {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    google.protobuf.Any result <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">string</span> error <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>And so the actual <code>Invoke</code> function is straightforward, given the <code>Any</code> parameters, invoke the specific operation (e.g. <code>mul</code>) exported by the WASM function and return the result to the client:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#a6e22e">Function</span>) <span style="color:#a6e22e">Invoke</span>(<span style="color:#66d9ef">any</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">anypb</span>.<span style="color:#a6e22e">Any</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">anypb</span>.<span style="color:#a6e22e">Any</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;[wapc:Function:Invoke] Entered&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">b</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">i</span>.<span style="color:#a6e22e">Invoke</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">op</span>, <span style="color:#66d9ef">any</span>.<span style="color:#a6e22e">GetValue</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">anypb</span>.<span style="color:#a6e22e">Any</span>{}, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">anypb</span>.<span style="color:#a6e22e">Any</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">TypeUrl</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Value</span>:   <span style="color:#a6e22e">b</span>,
</span></span><span style="display:flex;"><span>	}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> even though <code>Any</code> requires <code>TypeURL</code> to uniquely identify these, they&rsquo;re unused in this solution because the Client has the protobuf Descriptor and knows what to expect.</p></blockquote>
<p>waPC uses a string to identify functions exported by a WASM binary. The convention in this solution is that the protobuf method name (e.g. <code>mul</code>) matches the waPC operation name that corresponds to the exported function. Here&rsquo;s where this matching of <code>mul</code> to an actual (Rust) function is defined in the source of the WASM binary:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">handle_wapc</span>(operation: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span>, msg: <span style="color:#66d9ef">&amp;</span>[<span style="color:#66d9ef">u8</span>]) -&gt; <span style="color:#a6e22e">CallResult</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match</span> operation {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;add&#34;</span> <span style="color:#f92672">=&gt;</span> complex::export::add(msg),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;sub&#34;</span> <span style="color:#f92672">=&gt;</span> complex::export::sub(msg),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;mul&#34;</span> <span style="color:#f92672">=&gt;</span> complex::export::mul(msg),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;div&#34;</span> <span style="color:#f92672">=&gt;</span> complex::export::div(msg),
</span></span><span style="display:flex;"><span>        e <span style="color:#f92672">=&gt;</span> Err((String::from(<span style="color:#e6db74">&#34;dispatch error: &#34;</span>) <span style="color:#f92672">+</span> <span style="color:#f92672">&amp;</span>String::from(e)).into()),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="rust-wapc-guest">Rust waPC Guest</h3>
<p>The waPC SDK provides example host and guest code. The implementation is straightforward. There is expected to be a <code>handle_wapc</code> function that, given an <code>operation</code> and a <code>msg</code> (a reference to a slice of bytes which should sound familiar!), matches on the operation name e.g. <code>mul</code> and invokes e.g. <code>complex::export::mul(msg)</code>. This structure is user-defined but I wanted to show how these functions reflect the marshaling to protobuf.</p>
<p>So, <code>export::mul</code> takes the borrowed slice of bytes and creates a <code>protobuf::well_known_types::Any</code> from it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">mul</span>(msg: <span style="color:#66d9ef">&amp;</span>[<span style="color:#66d9ef">u8</span>]) -&gt; <span style="color:#a6e22e">CallResult</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// From bytes --&gt; Any
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// We must know the Type because it&#39;s lost in the transfer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> rqst <span style="color:#f92672">=</span> Any {
</span></span><span style="display:flex;"><span>        type_url: <span style="color:#e6db74">&#34;type.googleapis.com/examples.ComplexRequest&#34;</span>.to_string(),
</span></span><span style="display:flex;"><span>        value: <span style="color:#a6e22e">msg</span>.iter().cloned().collect(),
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">..</span>Default::default()
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Call the RPC
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> resp <span style="color:#f92672">=</span> <span style="color:#66d9ef">super</span>::any::mul(rqst)<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Any --&gt; bytes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> b <span style="color:#f92672">=</span> resp.get_value();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> v <span style="color:#f92672">=</span> b.iter().cloned().collect();
</span></span><span style="display:flex;"><span>    Ok(v)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And then invokes <code>any::mul</code> which <code>unpack</code>s the <code>Any</code> into <code>ComplexRequest</code> as defined by the protobuf. This function then calls <code>rpc::mul</code> which does the multiplication and returns a <code>ComplexResponse</code> and this bubbles back up|down the functions to be returned to the waPC host.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">mul</span>(any: <span style="color:#a6e22e">Any</span>) -&gt; Result<span style="color:#f92672">&lt;</span>Any, ProtobufError<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// From Any --&gt; ComplexRequest
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> rqst <span style="color:#f92672">=</span> unpack(any);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Call the RPC
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> resp: <span style="color:#a6e22e">ComplexResponse</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">super</span>::rpc::mul(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> rqst);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// From ComplexResponse --&gt; Any
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Any::pack(<span style="color:#f92672">&amp;</span>resp)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Lastly we implement the multiplication using Rust&rsquo;s <code>num_complex</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">mul</span>(rqst: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">ComplexRequest</span>) -&gt; <span style="color:#a6e22e">ComplexResponse</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> (a, b) <span style="color:#f92672">=</span> complex(rqst);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> a <span style="color:#f92672">*</span> b;
</span></span><span style="display:flex;"><span>    ComplexResponse {
</span></span><span style="display:flex;"><span>        result: <span style="color:#a6e22e">protobuf</span>::SingularPtrField::some(<span style="color:#66d9ef">crate</span>::protos::complex::Complex {
</span></span><span style="display:flex;"><span>            real: <span style="color:#a6e22e">result</span>.re,
</span></span><span style="display:flex;"><span>            imag: <span style="color:#a6e22e">result</span>.im,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">..</span>Default::default()
</span></span><span style="display:flex;"><span>        }),
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">..</span>Default::default()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We must build the Rust WASM binary using:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cargo build --release --target wasm32-unknown-unknown
</span></span></code></pre></div><p>And this will generate e.g. <code>complex.wasm</code> in <code>./target/wasm32-unknown-unknown/release</code>. This binary <code>complex.wasm</code> is what must be <code>Add</code> by the Client (along with the metadata) to the solution.</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/wasm/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Wasm</a>
   </li>
  
   <li class="list di">
     <a href="/tags/wapc/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Wapc</a>
   </li>
  
   <li class="list di">
     <a href="/tags/rust/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Rust</a>
   </li>
  
   <li class="list di">
     <a href="/tags/golang/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Golang</a>
   </li>
  
   <li class="list di">
     <a href="/tags/trillian/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Trillian</a>
   </li>
  
   <li class="list di">
     <a href="/tags/protobufs/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Protobufs</a>
   </li>
  
   <li class="list di">
     <a href="/tags/gprc/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Gprc</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/200807/">waPC and MsgPack (Rust|Golang)</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200717/">Remotely invoking WASM functions using gRPC and waPC</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200617/">WASM Cloud Functions</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200612/">waPC &amp; Protobufs</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200429/">Rust implementation of Crate Transparency using Google Trillian</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200723/">Envoy WASM filters in Rust</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200630/">Golang Protobuf APIv2</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200325/">gRPC, Cloud Run &amp; Endpoints</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200310/">Google&#39;s New Golang SDK for Protobufs</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200508/">Google Container Registry w/ OCI</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200403/">Rust Crate Transparency &amp;&amp; Rust SDK for Google Trillian</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200320/">Golang gRPC Cloud Run</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190907/">pypi-transparency</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-dark-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://pretired.dazwilkin.com/" >
    &copy;  (p)retired 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>