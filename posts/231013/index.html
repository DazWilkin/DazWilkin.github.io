<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Prometheus Operator `ScrapeConfig` | (p)retired</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="TL;DR Enable ScrapeConfig to use (discovery|target) proxies
I&rsquo;ve developed a companion, local daemon (called ackalctld) for Ackal that provides a functionally close version of the service.
One way to deploy ackalctld is to use Kubernetes and it would be convenient if the Prometheus metrics were scrapeable by Prometheus Operator.
In order for this to work, Prometheus Operator needs to be able to scrape Google Cloud Run targets because ackalctld creates Cloud Run services for its health check clients.">
    <meta name="generator" content="Hugo 0.146.0-DEV">
    
    
    
    
      <meta name="robots" content="index, follow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.d05fb5f317fcf33b3a52936399bdf6f47dc776516e1692e412ec7d76f4a5faa2.css" >




    
    
    
      

    

    

    <script data-goatcounter="https://pretired.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
 
    <meta property="og:url" content="https://pretired.dazwilkin.com/posts/231013/">
  <meta property="og:site_name" content="(p)retired">
  <meta property="og:title" content="Prometheus Operator `ScrapeConfig`">
  <meta property="og:description" content="TL;DR Enable ScrapeConfig to use (discovery|target) proxies
Iâ€™ve developed a companion, local daemon (called ackalctld) for Ackal that provides a functionally close version of the service.
One way to deploy ackalctld is to use Kubernetes and it would be convenient if the Prometheus metrics were scrapeable by Prometheus Operator.
In order for this to work, Prometheus Operator needs to be able to scrape Google Cloud Run targets because ackalctld creates Cloud Run services for its health check clients.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-10-13T00:00:00-07:00">
    <meta property="article:modified_time" content="2023-10-13T00:00:00-07:00">
    <meta property="article:tag" content="Prometheus">
    <meta property="article:tag" content="Prometheus Operator">

  <meta itemprop="name" content="Prometheus Operator `ScrapeConfig`">
  <meta itemprop="description" content="TL;DR Enable ScrapeConfig to use (discovery|target) proxies
Iâ€™ve developed a companion, local daemon (called ackalctld) for Ackal that provides a functionally close version of the service.
One way to deploy ackalctld is to use Kubernetes and it would be convenient if the Prometheus metrics were scrapeable by Prometheus Operator.
In order for this to work, Prometheus Operator needs to be able to scrape Google Cloud Run targets because ackalctld creates Cloud Run services for its health check clients.">
  <meta itemprop="datePublished" content="2023-10-13T00:00:00-07:00">
  <meta itemprop="dateModified" content="2023-10-13T00:00:00-07:00">
  <meta itemprop="wordCount" content="1082">
  <meta itemprop="keywords" content="Prometheus,Prometheus Operator">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Prometheus Operator `ScrapeConfig`">
  <meta name="twitter:description" content="TL;DR Enable ScrapeConfig to use (discovery|target) proxies
Iâ€™ve developed a companion, local daemon (called ackalctld) for Ackal that provides a functionally close version of the service.
One way to deploy ackalctld is to use Kubernetes and it would be convenient if the Prometheus metrics were scrapeable by Prometheus Operator.
In order for this to work, Prometheus Operator needs to be able to scrape Google Cloud Run targets because ackalctld creates Cloud Run services for its health check clients.">

      
    
	
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-dark-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        (p)retired
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Prometheus Operator `ScrapeConfig`</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2023-10-13T00:00:00-07:00">October 13, 2023</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 6 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 1082 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>TL;DR <a href="https://github.com/prometheus-operator/prometheus-operator/issues/5966#issuecomment-1754317247">Enable <code>ScrapeConfig</code> to use (discovery|target) proxies</a></p>
<p>I&rsquo;ve developed a companion, local daemon (called <code>ackalctld</code>) for <a href="https://ack.al" data-goatcounter-click="ack.al">Ackal</a> that provides a functionally close version of the service.</p>
<p>One way to deploy <code>ackalctld</code> is to use Kubernetes and it would be convenient if the Prometheus metrics were scrapeable by <a href="https://github.com/prometheus-operator/prometheus-operator">Prometheus Operator</a>.</p>
<p>In order for this to work, Prometheus Operator needs to be able to scrape Google <a href="https://cloud.google.com/run">Cloud Run</a> targets because <code>ackalctld</code> creates Cloud Run services for its health check clients.</p>
<p>In order to auth to Cloud Run, Prometheus Operator must be able to generate id tokens with per-target audience.</p>
<p>As I&rsquo;ve written before, I&rsquo;ve two solutions:</p>
<ol>
<li><a href="/posts/211005/">Scraping metrics exposed by Google Cloud Run services that require authentication</a> with <a href="https://github.com/DazWilkin/gcp-oidc-token-proxy">OIDC Token Proxy for GCP</a></li>
<li><a href="/posts/220225/">Prometheus HTTP Service Discovery of Cloud Run services</a></li>
</ol>
<p>A general solution is to have the authenticating (to Google Cloud Run) proxy described in #2 above. Running such a proxy, permits the following Prometheus configuration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;Service Discovery of Cloud Run services&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_url</span>: <span style="color:#ae81ff">http://proxy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">url</span>: <span style="color:#ae81ff">http://service-discovery-endpoint</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">proxy_url</span>: <span style="color:#ae81ff">http://proxy</span>
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> The above configuration is confusing but combines 2 uses of the (same) proxy. The first use of the proxy is to authenticate requests to the Service Discovery endpoint. This is described by the <code>proxy_url</code> setting as part of <code>http_sd_configs</code>. The second use of the proxy is to authenticate requests to the scrape targets returned by the Service Discovery endpoint.</p></blockquote>
<blockquote>
<p><strong>NOTE</strong> The <code>scheme</code> is <code>http</code>. This is to simplify the use of the locally-running proxy. Rather than have it proxy TLS connections too, the proxy receives <code>HTTP</code> requests but it upgrades (every) request to <code>HTTPS</code>. Local connections are insecure. Remote (proxied) connections are secure.</p></blockquote>
<p>In the case of <code>ackalctld</code>, Service Discovery is performed locally and so the desired configuration is simpler:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#34;Service Discovery of Cloud Run services&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">scheme</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">proxy_url</span>: <span style="color:#ae81ff">http://proxy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http_sd_configs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">url</span>: <span style="color:#ae81ff">http://service-discovery-endpoint</span>
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> The second <code>proxy_url</code>, to configure the proxy to proxy requests to the Service Discovery endpoint is not needed. The remaining <code>proxy_url</code>, proxies requests to Google Cloud Run to authenticate the requests to the scrape targets (only).</p></blockquote>
<p>I discovered that Prometheus Operator includes a new Custom Resource <a href="https://prometheus-operator.dev/docs/user-guides/scrapeconfig/"><code>ScrapeConfig</code></a>. The documentation is slightly inconsistent and I&rsquo;ll include some updates in what follows.</p>
<p>Here&rsquo;s the proposal for <a href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/proposals/202212-scrape-config.md">ScrapeConfig CRD</a>.</p>
<p>Here&rsquo;s Prometheus Operator API documentation for:</p>
<ul>
<li><a href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#monitoringcoreoscomv1alpha1"><code>monitoring.coreos/v1alpha</code></a>
<ul>
<li><a href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#scrapeconfig"><code>ScrapeConfig</code></a></li>
<li><a href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#httpsdconfig"><code>HTTPSDConfig</code></a></li>
</ul>
</li>
</ul>
<p>The variant that&rsquo;s of interest for <code>ackalctld</code> is <a href="https://prometheus-operator.dev/docs/user-guides/scrapeconfig/#http_sd"><code>http_sd</code></a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">monitoring.coreos.com/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ScrapeConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http-sd</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">my-namespace</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus</span>: <span style="color:#ae81ff">system-monitoring-prometheus</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">scrape-config-example</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">httpSDConfigs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">url</span>: <span style="color:#ae81ff">http://my-external-api/discovery</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">refreshInterval</span>: <span style="color:#ae81ff">15s</span>
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> <code>ScrapeConfig</code> is <code>monitoring.coreos.com/v1alpha1</code></p></blockquote>
<p>However, it&rsquo;s not currently possibly to represent proxies with Service Discovery with the Prometheus Operator and the version of Prometheus Operator that was deployed to my latest (!?) <a href="https://microk8s.io">MicroK8s</a> installation did not include the <code>ScrapeConfig</code> (<code>v1alpha</code>) CRDs.</p>
<p>As we would expect, <code>HTTPSDConfig</code> follows Prometheus&rsquo; <a href="https://prometheus.io/docs/prometheus/latest/http_sd/">HTTP Service Discovery</a> and expects the discovery endpoint (!) to return JSON in the <a href="https://prometheus.io/docs/prometheus/latest/http_sd/#http_sd-format"><code>HTTP_SD format</code></a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;targets&#34;: </span>[ <span style="color:#e6db74">&#34;&lt;host&gt;&#34;</span>, <span style="color:#ae81ff">... ],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;labels&#34;: </span>{
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;&lt;labelname&gt;&#34;: </span><span style="color:#e6db74">&#34;&lt;labelvalue&gt;&#34;</span>, <span style="color:#ae81ff">...</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">...</span>
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>Using <code>ackalctld</code> deployed to Kubernetes, we can:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>NAMESPACE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;...&#34;</span>
</span></span><span style="display:flex;"><span>SERVICE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;...&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FILTER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.spec.ports[?(@.name==\&#34;service-disco\&#34;)].nodePort}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  kubectl get services/<span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>FILTER<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--silent <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--get http://localhost:<span style="color:#e6db74">${</span>PORT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| jq -r .
</span></span></code></pre></div><p>Yielding:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JSON" data-lang="JSON"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;targets&#34;</span>: [
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;{host}.a.run.app:443&#34;</span>
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;labels&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;customer_id&#34;</span>: <span style="color:#e6db74">&#34;{customer_id}&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;endpoint&#34;</span>: <span style="color:#e6db74">&#34;{endpoint}&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;location&#34;</span>: <span style="color:#e6db74">&#34;{location}&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;period&#34;</span>: <span style="color:#e6db74">&#34;{period}&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>As I mentioned, the Prometheus Operator deployed as an addon to MicroK8s was outdated. You will need v0.68.0 or more recent:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>FILTER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.spec.template.spec.containers[?(@.name==\&#34;prometheus-operator\&#34;)].image}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get deployment/prometheus-operator <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace<span style="color:#f92672">=</span>monitoring <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>FILTER<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>quay.io/prometheus-operator/prometheus-operator:v0.68.0
</span></span></code></pre></div><p>Although MicroK8s says that you can disable then re-enable addons to get the latest version, evidently the latest (supported) version with the latest MicroK8s is not v0.68.0 and so I disabled it, deleted the namespace and deployed the latest version from GitHub:</p>
<p><a href="https://github.com/prometheus-operator/kube-prometheus">https://github.com/prometheus-operator/kube-prometheus</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--server-side <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--filename<span style="color:#f92672">=</span>manifests/setup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl wait <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--for condition<span style="color:#f92672">=</span>Established <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--all CustomResourceDefinition <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace<span style="color:#f92672">=</span>monitoring
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl apply <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--filename<span style="color:#f92672">=</span>manifests/
</span></span></code></pre></div><p>And then:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>FILTER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.items[?(.metadata.name==\&#34;scrapeconfigs.monitoring.coreos.com\&#34;)].metadata.name}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get crds <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>FILTER<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>scrapeconfigs.monitoring.coreos.com
</span></span></code></pre></div><p>I then &ndash; naively &ndash; tried to deploy a <code>ScrapeConfig</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">monitoring.coreos.com/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ScrapeConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">healthchecks</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">prometheus</span>: <span style="color:#ae81ff">system-monitoring-prometheus</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app.kubernetes.io/name</span>: <span style="color:#ae81ff">healthchecks</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">httpSDConfigs</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">url</span>: <span style="color:#ae81ff">http://ackalctld.ackalcltd.svc.cluster.local</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">refreshInterval</span>: <span style="color:#ae81ff">15s</span>
</span></span></code></pre></div><p>But, nothing happened ðŸ˜ž</p>
<p>Interestingly, I realized that the operator&rsquo;s <code>Prometheus</code> Kind did not include any config for <code>ScrapeConfig</code>. Specifically, there is no <code>scrapeConfigSelector</code> nor (and it&rsquo;s not documented) <code>scrapeConfigNamespaceSelector</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get prometheus/k8s <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace<span style="color:#f92672">=</span>monitoring <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.spec}&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| jq -r .
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JSON" data-lang="JSON"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;alerting&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;alertmanagers&#34;</span>: [
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;apiVersion&#34;</span>: <span style="color:#e6db74">&#34;v2&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;alertmanager-main&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;namespace&#34;</span>: <span style="color:#e6db74">&#34;monitoring&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;port&#34;</span>: <span style="color:#e6db74">&#34;web&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;enableFeatures&#34;</span>: [],
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;evaluationInterval&#34;</span>: <span style="color:#e6db74">&#34;30s&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;externalLabels&#34;</span>: {},
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;image&#34;</span>: <span style="color:#e6db74">&#34;quay.io/prometheus/prometheus:v2.47.0&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;nodeSelector&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;kubernetes.io/os&#34;</span>: <span style="color:#e6db74">&#34;linux&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;podMetadata&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;labels&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;app.kubernetes.io/component&#34;</span>: <span style="color:#e6db74">&#34;prometheus&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;app.kubernetes.io/instance&#34;</span>: <span style="color:#e6db74">&#34;k8s&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;app.kubernetes.io/name&#34;</span>: <span style="color:#e6db74">&#34;prometheus&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;app.kubernetes.io/part-of&#34;</span>: <span style="color:#e6db74">&#34;kube-prometheus&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;app.kubernetes.io/version&#34;</span>: <span style="color:#e6db74">&#34;2.47.0&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;podMonitorNamespaceSelector&#34;</span>: {},
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;podMonitorSelector&#34;</span>: {},
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;portName&#34;</span>: <span style="color:#e6db74">&#34;web&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;probeNamespaceSelector&#34;</span>: {},
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;probeSelector&#34;</span>: {},
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;replicas&#34;</span>: <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;resources&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;requests&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;memory&#34;</span>: <span style="color:#e6db74">&#34;400Mi&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;ruleNamespaceSelector&#34;</span>: {},
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;ruleSelector&#34;</span>: {},
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;scrapeInterval&#34;</span>: <span style="color:#e6db74">&#34;30s&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;securityContext&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;fsGroup&#34;</span>: <span style="color:#ae81ff">2000</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;runAsNonRoot&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;runAsUser&#34;</span>: <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;serviceAccountName&#34;</span>: <span style="color:#e6db74">&#34;prometheus-k8s&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;serviceMonitorNamespaceSelector&#34;</span>: {},
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;serviceMonitorSelector&#34;</span>: {},
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#e6db74">&#34;2.47.0&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I <code>patch</code>&lsquo;ed the <code>k8s</code> resource and added:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JSON" data-lang="JSON"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;scrapeConfigNamespaceSelector&#34;</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;scrapeConfigSelector&#34;</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> The <a href="https://prometheus-operator.dev/docs/user-guides/scrapeconfig/#configure-prometheus-or-prometheusagent-to-select-scrapeconfigs">documentation</a> suggests using a annotation <code>prometheus: system-monitoring-prometheus</code> but I left the configuration to include all (<code>{}</code>) <code>ScrapeConfig</code>&rsquo;s.</p></blockquote>
<p>After this change was made, Prometheus Service Discovery included the <code>ScrapeConfig</code> and the Targets included the Cloud Run services returned by <code>ackalctld</code>&rsquo;s Service Discovery endpoint.</p>
<p>However, as expected, absent the ability to proxy the Cloud Run services (to add auth), when Prometheus tries to scrape the endpoints, it&rsquo;s failing.</p>
<p>I&rsquo;d hoped I could hack the <code>proxy_url</code> into the configuration that&rsquo;s generated by the Prometheus Operator and applied (by restarting) Prometheus.</p>
<p>It doesn&rsquo;t work ðŸ˜ž</p>
<p>I suspect but don&rsquo;t know that, the Operator is catching the update (to the Secret that&rsquo;s used to contain the configuration) and reverting it (to the <code>ScrapeConfig</code> configuration) before Prometheus has a change to scrape the endpoint successfully.</p>
<p>I tried:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>NAMESPACE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;...&#34;</span>
</span></span><span style="display:flex;"><span>SCRAPECONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;...&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EXPR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  .scrape_configs[]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  | select(.job_name==\&#34;scrapeconfig/</span><span style="color:#e6db74">${</span>SCRAPECONFIG<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl get secret/prometheus-k8s <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace<span style="color:#f92672">=</span>monitoring <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.data.prometheus\.yaml\.gz}&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| base64 --decode <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| gunzip -c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| yq eval <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --expression<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>EXPR<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>job_name: scrapeconfig/ackalctld/ackalctld
</span></span><span style="display:flex;"><span>http_sd_configs:
</span></span><span style="display:flex;"><span>  - url: http://ackalctld.ackalctld.svc.cluster.local:8080
</span></span></code></pre></div><p>And then <code>PATCH</code>&lsquo;ing it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>NAMESPACE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;...&#34;</span>
</span></span><span style="display:flex;"><span>SCRAPECONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;...&#34;</span>
</span></span><span style="display:flex;"><span>SERVICE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;...&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PRXY<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;7777&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EXPR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  with(
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    .scrape_configs[]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    | select(.job_name==\&#34;scrapeconfig/</span><span style="color:#e6db74">${</span>SCRAPECONFIG<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ; .proxy_url|=\&#34;http://</span><span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span><span style="color:#e6db74">.</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span><span style="color:#e6db74">.svc.cluster.local:</span><span style="color:#e6db74">${</span>PRXY<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  )
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VALUE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  kubectl get secret/prometheus-k8s <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --namespace<span style="color:#f92672">=</span>monitoring <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.data.prometheus\.yaml\.gz}&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  | base64 --decode <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  | gunzip -c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  | yq eval <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --expression<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>EXPR<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  | gzip -c <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  | base64 --wrap<span style="color:#f92672">=</span>0<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PATCH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    \&#34;op\&#34;:\&#34;replace\&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    \&#34;path\&#34;:\&#34;/data/prometheus.yaml.gz\&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    \&#34;value\&#34; : \&#34;</span><span style="color:#e6db74">${</span>VALUE<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">]&#34;</span>
</span></span><span style="display:flex;"><span>kubectl patch secret/prometheus-k8s <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace<span style="color:#f92672">=</span>monitoring <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--type<span style="color:#f92672">=</span>json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--patch<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PATCH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>So, the next step as shown in the TL;DR atop this post is to revise Prometheus Operator to reflect <code>proxy_url</code> in <code>ScrapeConfig</code> CRD.</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/prometheus/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Prometheus</a>
   </li>
  
   <li class="list di">
     <a href="/tags/prometheus-operator/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Prometheus Operator</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/220520/">Prometheus Exporters for fly.io and Vultr</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/220225/">Prometheus HTTP Service Discovery of Cloud Run services</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/211005/">Scraping metrics exposed by Google Cloud Run services that require authentication</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210520/">Consul discovers Google Cloud Run</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210519/">Multiplexing gRPC and HTTP (Prometheus) endpoints with Cloud Run</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210419/">Prometheus Service Discovery w/ Consul for Cloud Run</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/210305/">Prometheus VPA Recommendations</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201008/">Deploying a Rust HTTP server to DigitalOcean App Platform</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-dark-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://pretired.dazwilkin.com/" >
    &copy;  (p)retired 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>