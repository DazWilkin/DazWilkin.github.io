<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Programmatically deploying Cloud Run services (Golang|Python) | (p)retired</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Programmatically deploying Cloud Run services (Golang|Python)">
    <meta name="generator" content="Hugo 0.153.0-DEV">
    
    
    
    
      <meta name="robots" content="index, follow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.cf4aecb341f2e16e80e407465df095cee730d71e19c4574f8e9b28d163dc4225.css" >



  


    

    
    
      

    

    

    <script data-goatcounter="https://pretired.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
 
    <meta property="og:url" content="https://pretired.dazwilkin.com/posts/210316/">
  <meta property="og:site_name" content="(p)retired">
  <meta property="og:title" content="Programmatically deploying Cloud Run services (Golang|Python)">
  <meta property="og:description" content="Programmatically deploying Cloud Run services (Golang|Python)">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-03-16T00:00:00-07:00">
    <meta property="article:modified_time" content="2021-03-16T00:00:00-07:00">
    <meta property="article:tag" content="Google">
    <meta property="article:tag" content="Run">
    <meta property="article:tag" content="Cloud Run">
    <meta property="article:tag" content="Golang">
    <meta property="article:tag" content="Python">

  <meta itemprop="name" content="Programmatically deploying Cloud Run services (Golang|Python)">
  <meta itemprop="description" content="Programmatically deploying Cloud Run services (Golang|Python)">
  <meta itemprop="datePublished" content="2021-03-16T00:00:00-07:00">
  <meta itemprop="dateModified" content="2021-03-16T00:00:00-07:00">
  <meta itemprop="wordCount" content="1420">
  <meta itemprop="keywords" content="Google,Run,Cloud Run,Golang,Python">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Programmatically deploying Cloud Run services (Golang|Python)">
  <meta name="twitter:description" content="Programmatically deploying Cloud Run services (Golang|Python)">

      
    
	
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-dark-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        (p)retired
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Programmatically deploying Cloud Run services (Golang|Python)</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2021-03-16T00:00:00-07:00">March 16, 2021</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 7 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 1420 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>Phew! Programmitcally deploying Cloud Run services should be easy but it didn&rsquo;t find it so.</p>
<p>My issues were that the Cloud Run Admin (!) API is poorly documented and it uses non-standard endpoints (thanks Sal!). Here, for others who may struggle with this, is how I got this to work.</p>
<h2 id="goal">Goal</h2>
<p>Programmatically (have Golang, Python, want Rust) deploy services to Cloud Run.</p>
<p>i.e. achieve this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud run deploy <span style="color:#e6db74">${</span>NAME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--image<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>IMAGE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--no-allow-unauthenticated <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span></code></pre></div><blockquote>
<p><strong>TRICK</strong> <a href="https://cloud.google.com/sdk/gcloud/reference#--log-http"><code>--log-http</code></a> is your friend</p>
</blockquote>
<p>I&rsquo;ll document this here as it&rsquo;s generally applicable but, as I struggled to emulate the <code>gcloud run deploy</code> command in code, I used <code>--log-http</code> to see how Cloud SDK achieves this. Running the above command with <code>--log-http</code> yields:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>uri: https://${REGION}-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/${PROJECT}/services/${NAME}
</span></span><span style="display:flex;"><span>method: GET
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>uri: https://${REGION}-run.googleapis.com/apis/serving.knative.dev/v1/namespaces/${PROJECT}/services
</span></span><span style="display:flex;"><span>method: POST
</span></span><span style="display:flex;"><span>== body start ==
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    &#34;apiVersion&#34;: &#34;serving.knative.dev/v1&#34;,
</span></span><span style="display:flex;"><span>    &#34;kind&#34;: &#34;Service&#34;,
</span></span><span style="display:flex;"><span>    &#34;metadata&#34;: {
</span></span><span style="display:flex;"><span>        &#34;annotations&#34;: {...},
</span></span><span style="display:flex;"><span>        &#34;labels&#34;: {},
</span></span><span style="display:flex;"><span>        &#34;name&#34;: &#34;${NAME}&#34;,
</span></span><span style="display:flex;"><span>        &#34;namespace&#34;: &#34;${PROJECT}&#34;
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    &#34;spec&#34;: {...}
</span></span><span style="display:flex;"><span>    ...
</span></span></code></pre></div><p>I draw your attention to:</p>
<ol>
<li>The endpoint is <code>https://${REGION}-run.googleapis.com</code>. This is documented <a href="https://cloud.google.com/run/docs/reference/rest/#service-endpoint">Service Endpoint</a>. It&rsquo;s possible to GET (lists) on <code>https://run.googleapis.com</code> but to create, edit, delete etc. you must use <code>https://${REGION}-run.googleapis.com</code>.</li>
<li>The path includes <code>namespaces/${PROJECT}</code>. The <a href="https://cloud.google.com/run/docs/reference/rest/v1/namespaces.services/create">documentation</a> explains that this value may be either the Project ID or the Project number. Because the service is a Kubernetes API, Namespaces are employed.</li>
<li>The <code>POST</code>&rsquo;s body is a Kubernetes (Knative) Service manifest. It is documented by Google <a href="https://cloud.google.com/run/docs/reference/rest/v1/namespaces.services#Service">here</a> but I found some inconsistencies in this documentation.</li>
</ol>
<blockquote>
<p><strong>TRICK</strong> Once deployed, you can view a service either in the Console or using e.g. gcloud to verify the YAML manifest</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud run services describe <span style="color:#e6db74">${</span>NAME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--format<span style="color:#f92672">=</span>yaml
</span></span></code></pre></div><h2 id="code">Code</h2>
<p>There are 2 insights necessary to get the code to work:</p>
<ol>
<li>The endpoint must be adjusted to reflect <code>https://${REGION}-run.googleapis.com</code></li>
<li>The manifest must be error-free</li>
</ol>
<p>After some searching, I was unable to find either Cloud Client Libraries for the Cloud Run Admin service or Protobufs. Google provides [API Client Libraries] in multiple languages for every service. API Client Libraries are the historical REST-based mechanism, are machine-generated and are a good fallback. Google Cloud (!) offers an alternative called Cloud Client Libraries. These are (often) hand-crafted and sometimes use gRPC (rather than REST). For some of its services, Google provides the services&rsquo; Protobufs and this provides a mechanism by which developers can use <code>protoc</code> to generate client libraries in their language of choice.</p>
<p>Google&rsquo;s <a href="https://cloud.google.com/apis/docs/client-libraries-explained">Client Libraries Explained</a></p>
<p>An (as-)definitive(-as-it-gets) list of Google&rsquo;s <a href="https://cloud.google.com/apis/docs/cloud-client-libraries">Cloud Client Libraries</a>. Here&rsquo;s the Golang <a href="https://pkg.go.dev/cloud.google.com/go#readme-supported-apis">Supported APIs</a> for Cloud Client Libraries and the Python <a href="https://github.com/googleapis/google-cloud-python#libraries">Libraries</a>. It&rsquo;s possible (!) that there&rsquo;s a Cloud Client available for one language but not another. In this case, it appears there are no Cloud Client Libraries for Cloud Run (Admin) API.</p>
<p>So, then I had a look for gRPC (Protobuf) definitions. Confusingly, this repo is called <a href="https://github.com/googleapis/googleapis"><code>googleapis/googleapis</code></a> and you must navigate directories to find <a href="https://github.com/googleapis/googleapis/tree/master/google">libraries</a> and then those for <a href="https://github.com/googleapis/googleapis/tree/master/google/cloud">cloud</a>. No Cloud Run.</p>
<p>So, back to the ever-reliable <a href="https://developers.google.com/api-client-library/">API Client Libraries</a>. This page&rsquo;s links tend to go directly to the GitHub repo but, for Golang, here&rsquo;s the documentation <a href="https://pkg.go.dev/google.golang.org/api#section-directories">list</a> and for Python <a href="https://github.com/googleapis/google-api-python-client/blob/master/docs/dyn/index.md">list</a>.</p>
<blockquote>
<p><strong>NOTE</strong> For Golang, the API Client Libraries are <code>google.golang.org</code> and the Cloud Client Libraries are <code>cloud.google.com</code></p>
</blockquote>
<blockquote>
<p><strong>INSIGHT</strong> Cloud Run Admin API|service <strong>only</strong> has API Client Libraries.</p>
</blockquote>
<p>The API Client Libraries <strong>all</strong> provide a mechanism (called <code>ClientOptions</code>) to override the default service endpoint. I was unfamiliar with this until a friend (thanks Sal!) told me about it:</p>
<ul>
<li>Golang&rsquo;s <a href="https://pkg.go.dev/google.golang.org/api/option">option</a></li>
<li>Python&rsquo;s <a href="https://googleapis.dev/python/google-api-core/latest/client_options.html">ClientOptions</a></li>
</ul>
<h3 id="environment">Environment</h3>
<p>For the client code to work, we need a GCP Project, Billing Account, Service Account(s) etc.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>PROJECT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;[[YOUR-PROJECT]]&#34;</span>
</span></span><span style="display:flex;"><span>BILLING<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;[[YOUR-BILLING]]&#34;</span>
</span></span><span style="display:flex;"><span>DEPLOYR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;deployr&#34;</span>
</span></span><span style="display:flex;"><span>INVOKER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;invoker&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gcloud projects create <span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>gcloud beta billing projects link <span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--billing-account<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>BILLING<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gcloud services enable run.googleapis.com <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For Deploying Services</span>
</span></span><span style="display:flex;"><span>gcloud iam service-accounts create <span style="color:#e6db74">${</span>DEPLOYR<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EMAIL<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>DEPLOYR<span style="color:#e6db74">}</span>@<span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>.iam.gserviceaccount.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gcloud iam service-accounts keys create <span style="color:#e6db74">${</span>PWD<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>DEPLOYR<span style="color:#e6db74">}</span>.json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--iam-account<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>EMAIL<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gcloud projects add-iam-policy-binding <span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--member<span style="color:#f92672">=</span>serviceAccount:<span style="color:#e6db74">${</span>EMAIL<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--role<span style="color:#f92672">=</span>roles/run.admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For Services to invoke other services</span>
</span></span><span style="display:flex;"><span>gcloud iam service-accounts create <span style="color:#e6db74">${</span>INVOKER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Deployer must be able to act-as the Invoker</span>
</span></span><span style="display:flex;"><span>gcloud iam service-accounts add-iam-policy-binding <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">${</span>INVOKER<span style="color:#e6db74">}</span>@<span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>.iam.gserviceaccount.com <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--member<span style="color:#f92672">=</span>serviceAccount:<span style="color:#e6db74">${</span>DEPLOYR<span style="color:#e6db74">}</span>@<span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>.iam.gserviceaccount.com <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--role<span style="color:#f92672">=</span>roles/iam.serviceAccountUser <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Export variables</span>
</span></span><span style="display:flex;"><span>export PROJECT
</span></span><span style="display:flex;"><span>export REGION<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;[[YOUR-REGION]]&#34;</span>
</span></span><span style="display:flex;"><span>export IMAGE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;[[YOUR-IMAGE]]&#34;</span>
</span></span><span style="display:flex;"><span>export ACCOUNT<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>INVOKER<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>export GOOGLE_APPLICATION_CREDENTIALS<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PWD<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>DEPLOYR<span style="color:#e6db74">}</span>.json
</span></span></code></pre></div><h3 id="golang">Golang</h3>
<p>I&rsquo;ll annotate the code below where there&rsquo;s novelty.</p>
<p>It can be challenging to determine which Google client library to use. Google doesn&rsquo;t always effectively cull dead repos from GitHub.</p>
<p>With Golang, the machine-generated documentation is always <em>excellent</em>:</p>
<p><a href="https://pkg.go.dev/google.golang.org/api/run/v1">https://pkg.go.dev/google.golang.org/api/run/v1</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;google.golang.org/api/googleapi&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;google.golang.org/api/option&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">run</span> <span style="color:#e6db74">&#34;google.golang.org/api/run/v1&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">project</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;PROJECT&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">region</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;REGION&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">image</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;IMAGE&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">account</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;ACCOUNT&#34;</span>)
</span></span></code></pre></div><p>Per above, we must use API Client Libraries, hence <code>google.golang.org</code>. We&rsquo;re also using Golang&rsquo;s Client Options and so <code>google.golang.org/api/option</code>.</p>
<p>For simplicity, we&rsquo;re assuming a bunch of variables from the environment including the Region.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Golang" data-lang="Golang"><span style="display:flex;"><span>  <span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">url</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;https://%s-run.googleapis.com/&#34;</span>, <span style="color:#a6e22e">region</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">opts</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">option</span>.<span style="color:#a6e22e">ClientOption</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">option</span>.<span style="color:#a6e22e">WithEndpoint</span>(<span style="color:#a6e22e">url</span>),
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">runService</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">run</span>.<span style="color:#a6e22e">NewService</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">opts</span><span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>The Region is important because, the Cloud Run Admin service&rsquo;s endpoint is dependent on the Region when we wish to deploy new services. The code above uses <code>ClientOption</code> to override the service&rsquo;s default (<code>https://run.googleapis.com</code>) endpoint with one prefixed with the Region. This is applied to the configuration using <code>WithEndpoint</code>.</p>
<blockquote>
<p><strong>NOTE</strong> The endpoint is also <code>${REGION}-run</code> (hyphenated).</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Golang" data-lang="Golang"><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;golang&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">containerName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;%s-%s-%s&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;00001&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;abc&#34;</span>,
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">serviceAccount</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;%s@%s.iam.gserviceaccount.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">account</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">project</span>,
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">service</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">run</span>.<span style="color:#a6e22e">Service</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ApiVersion</span>: <span style="color:#e6db74">&#34;serving.knative.dev/v1&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Kind</span>:       <span style="color:#e6db74">&#34;Service&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Metadata</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">run</span>.<span style="color:#a6e22e">ObjectMeta</span>{
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">Name</span>:      <span style="color:#a6e22e">name</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">project</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">Labels</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;test&#34;</span>:                          <span style="color:#e6db74">&#34;test&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;cloud.googleapis.com/location&#34;</span>: <span style="color:#a6e22e">region</span>,
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">Annotations</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;client.knative.dev/user-image&#34;</span>:   <span style="color:#a6e22e">image</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;run.googleapis.com/launch-stage&#34;</span>: <span style="color:#e6db74">&#34;BETA&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;run.googleapis.com/sandbox&#34;</span>:      <span style="color:#e6db74">&#34;gvisor&#34;</span>,
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Spec</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">run</span>.<span style="color:#a6e22e">ServiceSpec</span>{
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">Template</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">run</span>.<span style="color:#a6e22e">RevisionTemplate</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Metadata</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">run</span>.<span style="color:#a6e22e">ObjectMeta</span>{
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">containerName</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">Annotations</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;autoscaling.knative.dev/maxScale&#34;</span>: <span style="color:#e6db74">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;client.knative.dev/user-image&#34;</span>:    <span style="color:#a6e22e">image</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;run.googleapis.com/launch-stage&#34;</span>:  <span style="color:#e6db74">&#34;BETA&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;run.googleapis.com/sandbox&#34;</span>:       <span style="color:#e6db74">&#34;gvisor&#34;</span>,
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Spec</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">run</span>.<span style="color:#a6e22e">RevisionSpec</span>{
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">Containers</span>: []<span style="color:#f92672">*</span><span style="color:#a6e22e">run</span>.<span style="color:#a6e22e">Container</span>{
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">Image</span>: <span style="color:#a6e22e">image</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">Ports</span>: []<span style="color:#f92672">*</span><span style="color:#a6e22e">run</span>.<span style="color:#a6e22e">ContainerPort</span>{
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                  <span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;http1&#34;</span>,
</span></span><span style="display:flex;"><span>                  <span style="color:#a6e22e">ContainerPort</span>: <span style="color:#ae81ff">8080</span>,
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>              },
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">ServiceAccountName</span>: <span style="color:#a6e22e">serviceAccount</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>The creation of a <code>run.Service</code> is the heart of the code and, as you&rsquo;d suspect, is where we define the Cloud Run service. This type is to be found under the Cloud Run service&rsquo;s <code>namespaces.services.create</code> <a href="https://cloud.google.com/run/docs/reference/rest/v1/namespaces.services/create">method</a> and is called <a href="https://cloud.google.com/run/docs/reference/rest/v1/namespaces.services#Service">Service</a>.</p>
<p>In theory, you should be able to treat Google&rsquo;s documentation as definitive but I struggled with some discrepancies:</p>
<ul>
<li><code>Metadata.Labels</code>: I was unable to use dot-notation for the keys</li>
<li><code>Metadata.Annotations</code>: I&rsquo;m unsure where these annotations are documented</li>
<li><code>Spec.Template.Metadata.Name</code>: Can&rsquo;t just be <code>name</code> and must be <code>{something}-[0-9]{5}-[a-z]{3}</code></li>
<li><code>Spec.Template.Spec.Containers[].Ports.Name</code>: This is documented but it can&rsquo;t be <code>http</code>, use <code>http1</code></li>
<li><code>Spec.Template.Spec.Containers[].Ports.Protocol</code>: I was unable to use <code>TCP</code>; either remove it or use <code>&quot;&quot;</code></li>
<li><code>Spec.Template.Spec.Containers[].Resources</code>: This is permitted but I&rsquo;ve omitted it</li>
<li><code>Spec.Template.Traffic</code>: I was unsuccessful using this and so omitted it</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Golang" data-lang="Golang"><span style="display:flex;"><span>  <span style="color:#a6e22e">parent</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;namespaces/%s&#34;</span>, <span style="color:#a6e22e">project</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rqst</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runService</span>.<span style="color:#a6e22e">Namespaces</span>.<span style="color:#a6e22e">Services</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">parent</span>, <span style="color:#a6e22e">service</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rqst</span>.<span style="color:#a6e22e">Do</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">err</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">googleapi</span>.<span style="color:#a6e22e">Error</span>); <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Failed to deploy: %s [%d]\n%s&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Message</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Code</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Body</span>,
</span></span><span style="display:flex;"><span>      )
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">resp</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Once the manifest is correct(!), you can make the request and, if there are no errors, return the response.</p>
<blockquote>
<p><strong>NOTE</strong> The <code>parent</code> value is different for Cloud Run and uses <code>namespace/${PROJECT}</code>.</p>
</blockquote>
<p>Then you should be able to: <code>go run .</code></p>
<p>And then:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud run services describe <span style="color:#e6db74">${</span>NAME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span></code></pre></div><h3 id="python">Python</h3>
<p>Here&rsquo;s a somewhat idiosyncratic version of the Golang code in Python:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">import</span> google.auth
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> google.api_core.client_options <span style="color:#f92672">import</span> ClientOptions
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> googleapiclient <span style="color:#f92672">import</span> discovery
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>REGION <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;REGION&#34;</span>)
</span></span><span style="display:flex;"><span>IMAGE <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;IMAGE&#34;</span>)
</span></span><span style="display:flex;"><span>ACCOUNT <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;ACCOUNT&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://</span><span style="color:#e6db74">{region}</span><span style="color:#e6db74">-run.googleapis.com/&#34;</span><span style="color:#f92672">.</span>format(region<span style="color:#f92672">=</span>REGION)
</span></span><span style="display:flex;"><span>options <span style="color:#f92672">=</span> ClientOptions(api_endpoint<span style="color:#f92672">=</span>url)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>credentials, project <span style="color:#f92672">=</span> google<span style="color:#f92672">.</span>auth<span style="color:#f92672">.</span>default()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>service <span style="color:#f92672">=</span> discovery<span style="color:#f92672">.</span>build(<span style="color:#e6db74">&#34;run&#34;</span>, <span style="color:#e6db74">&#34;v1&#34;</span>,
</span></span><span style="display:flex;"><span>  client_options<span style="color:#f92672">=</span>options, credentials<span style="color:#f92672">=</span>credentials)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;python&#34;</span>
</span></span><span style="display:flex;"><span>container_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{name}</span><span style="color:#e6db74">-</span><span style="color:#e6db74">{counter}</span><span style="color:#e6db74">-</span><span style="color:#e6db74">{postfix}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(
</span></span><span style="display:flex;"><span>  name<span style="color:#f92672">=</span>name, counter<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;00001&#34;</span>, postfix<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;abc&#34;</span>)
</span></span><span style="display:flex;"><span>service_account <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{account}</span><span style="color:#e6db74">@</span><span style="color:#e6db74">{project}</span><span style="color:#e6db74">.iam.gserviceaccount.com&#34;</span><span style="color:#f92672">.</span>format(
</span></span><span style="display:flex;"><span>  account<span style="color:#f92672">=</span>ACCOUNT, project<span style="color:#f92672">=</span>project)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>body <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;apiVersion&#34;</span>: <span style="color:#e6db74">&#34;serving.knative.dev/v1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;kind&#34;</span>: <span style="color:#e6db74">&#34;Service&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;metadata&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;name&#34;</span>: name,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;namespace&#34;</span>: project,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;labels&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;test&#34;</span>: <span style="color:#e6db74">&#34;test&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;cloud.googleapis.com/location&#34;</span>: REGION,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;annotations&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;client.knative.dev/user-image&#34;</span>: IMAGE,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;run.googleapis.com/launch-stage&#34;</span>: <span style="color:#e6db74">&#34;BETA&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;run.googleapis.com/sandbox&#34;</span>: <span style="color:#e6db74">&#34;gvisor&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;spec&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;template&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;metadata&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;name&#34;</span>: container_name,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;annotations&#34;</span>: {
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;client.knative.dev/user-image&#34;</span>: IMAGE,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;run.googleapis.com/launch-stage&#34;</span>: <span style="color:#e6db74">&#34;BETA&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;run.googleapis.com/sandbox&#34;</span>: <span style="color:#e6db74">&#34;gvisor&#34;</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;spec&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;containers&#34;</span>: [{
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;image&#34;</span>: IMAGE,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;ports&#34;</span>: [{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;http1&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;containerPort&#34;</span>: <span style="color:#ae81ff">8080</span>,
</span></span><span style="display:flex;"><span>          }]
</span></span><span style="display:flex;"><span>        }],
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;serviceAccountName&#34;</span>: service_account,
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>parent <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;namespaces/</span><span style="color:#e6db74">{project}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(project<span style="color:#f92672">=</span>project)
</span></span><span style="display:flex;"><span>rqst <span style="color:#f92672">=</span> service<span style="color:#f92672">.</span>namespaces()<span style="color:#f92672">.</span>services()<span style="color:#f92672">.</span>create(parent<span style="color:#f92672">=</span>parent, body<span style="color:#f92672">=</span>body)
</span></span><span style="display:flex;"><span>resp <span style="color:#f92672">=</span> rqst<span style="color:#f92672">.</span>execute()
</span></span><span style="display:flex;"><span>print(resp)
</span></span></code></pre></div><h3 id="testing">Testing</h3>
<p>Once you&rsquo;ve deployed a service (requiring authentication), you can test it using:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ENDPOINT<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>  gcloud run services describe <span style="color:#e6db74">${</span>NAME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>  --platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>  --region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>  --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;value(status.address.url)&#34;</span><span style="color:#66d9ef">)</span> <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">${</span>ENDPOINT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--verbose <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--request GET <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--header <span style="color:#e6db74">&#34;Authorization: Bearer </span><span style="color:#66d9ef">$(</span>gcloud auth print-identity-token<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">${</span>ENDPOINT<span style="color:#e6db74">}</span>
</span></span></code></pre></div><h3 id="tidy">Tidy</h3>
<p>When you&rsquo;re done, you may either delete the Project entirely:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud projects delete <span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> --quiet
</span></span></code></pre></div><p>Or delete the services:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud run services delete <span style="color:#e6db74">${</span>NAME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>--quiet
</span></span></code></pre></div><p>And service accounts:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ACCOUNT in <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DEPLOYR<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>INVOKER<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  gcloud iam service-accounts delete <span style="color:#e6db74">${</span>ACCOUNT<span style="color:#e6db74">}</span>@<span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>.iam.gserviceaccount.com <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span>  --quiet
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>That&rsquo;s all!</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/google/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Google</a>
   </li>
  
   <li class="list di">
     <a href="/tags/run/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Run</a>
   </li>
  
   <li class="list di">
     <a href="/tags/cloud-run/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Cloud Run</a>
   </li>
  
   <li class="list di">
     <a href="/tags/golang/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Golang</a>
   </li>
  
   <li class="list di">
     <a href="/tags/python/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Python</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/210222/">Dapr</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201229/">Kubernetes Webhooks</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201203/">webmention</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201113/">Akri</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201029/">GitHub Actions &amp;&amp; GitHub Container Registry</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200930/">Hugo and Google Cloud Storage</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200916/">Actions SDK Conversational Quickstart</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200908/">Trillian Map Mode</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200817/">WASM Transparency</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200807/">waPC and MsgPack (Rust|Golang)</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200630/">Golang Protobuf APIv2</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200310/">Google&#39;s New Golang SDK for Protobufs</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-dark-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://pretired.dazwilkin.com/" >
    &copy;  (p)retired 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>