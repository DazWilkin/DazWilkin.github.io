<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>(p)retired  | NGINX Ingress</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.62.2" />
    
    
      <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
    

    
    
      <link href="/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css" rel="stylesheet">
    

    

    
      
    

    
    
    <meta property="og:title" content="NGINX Ingress" />
<meta property="og:description" content="I&#39;ve written a couple of deployment options (Google Compute Engine; Kubernetes) for an open-source project. The Kubernetes deployment provides NodePort and (TCP) LoadBalancer options and I&#39;ve been trying (unsuccessfully) to add HTTPS Load-balancing.
I should (!) try to deploy to Google Kubernetes Engine (GKE) but I&#39;ve been using microk8s, Digital Ocean Managed Kubernetes and the Linode LKE Beta. Each of these requires an implementation of Ingress controller. For GKE, GCP&#39;s HTTP/S Load-balancer (GCLB) is used." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pretired.dazwilkin.com/posts/191211/" />
<meta property="article:published_time" content="2019-12-11T00:00:00-07:00" />
<meta property="article:modified_time" content="2019-12-11T00:00:00-07:00" />
<meta itemprop="name" content="NGINX Ingress">
<meta itemprop="description" content="I&#39;ve written a couple of deployment options (Google Compute Engine; Kubernetes) for an open-source project. The Kubernetes deployment provides NodePort and (TCP) LoadBalancer options and I&#39;ve been trying (unsuccessfully) to add HTTPS Load-balancing.
I should (!) try to deploy to Google Kubernetes Engine (GKE) but I&#39;ve been using microk8s, Digital Ocean Managed Kubernetes and the Linode LKE Beta. Each of these requires an implementation of Ingress controller. For GKE, GCP&#39;s HTTP/S Load-balancer (GCLB) is used.">
<meta itemprop="datePublished" content="2019-12-11T00:00:00-07:00" />
<meta itemprop="dateModified" content="2019-12-11T00:00:00-07:00" />
<meta itemprop="wordCount" content="1183">



<meta itemprop="keywords" content="kubernetes,Ingress,NGINX," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="NGINX Ingress"/>
<meta name="twitter:description" content="I&#39;ve written a couple of deployment options (Google Compute Engine; Kubernetes) for an open-source project. The Kubernetes deployment provides NodePort and (TCP) LoadBalancer options and I&#39;ve been trying (unsuccessfully) to add HTTPS Load-balancing.
I should (!) try to deploy to Google Kubernetes Engine (GKE) but I&#39;ve been using microk8s, Digital Ocean Managed Kubernetes and the Linode LKE Beta. Each of these requires an implementation of Ingress controller. For GKE, GCP&#39;s HTTP/S Load-balancer (GCLB) is used."/>

      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-148669951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-dark-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://pretired.dazwilkin.com/" class="f3 fw2 hover-white no-underline white-90 dib">
      (p)retired
    </a>
    <div class="flex-l items-center">
      

      
      






<a href="https://www.linkedin.com/in/dazwilkin/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://github.com/DazWilkin" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>



<a href="https://medium.com/@DazWilkin" target="_blank" class="link-transition medium link dib z-999 pt3 pt0-l mr1" title="Medium link" rel="noopener" aria-label="follow on Medium——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 170 170;" version="1.1" viewBox="0 0 170 170" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M46.5340803,65.2157554 C46.6968378,63.6076572 46.0836,62.018231 44.8828198,60.93592 L32.6512605,46.2010582 L32.6512605,44 L70.6302521,44 L99.9859944,108.380952 L125.794585,44 L162,44 L162,46.2010582 L151.542017,56.2281011 C150.640424,56.9153477 150.193188,58.0448862 150.380019,59.1628454 L150.380019,132.837155 C150.193188,133.955114 150.640424,135.084652 151.542017,135.771899 L161.755369,145.798942 L161.755369,148 L110.38282,148 L110.38282,145.798942 L120.963119,135.527337 C122.002801,134.487948 122.002801,134.182246 122.002801,132.592593 L122.002801,73.0417402 L92.585901,147.755438 L88.6106443,147.755438 L54.3622782,73.0417402 L54.3622782,123.115814 C54.0767278,125.221069 54.7759199,127.3406 56.2581699,128.863022 L70.0186741,145.55438 L70.0186741,147.755438 L31,147.755438 L31,145.55438 L44.7605042,128.863022 C46.2319621,127.338076 46.8903838,125.204485 46.5340803,123.115814 L46.5340803,65.2157554 Z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>




    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">NGINX Ingress</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2019-12-11T00:00:00-07:00">December 11, 2019</time>
      
      
        <span class="f6 mv4 dib tracked"> - 6 minutes read</span>
        <span class="f6 mv4 dib tracked"> - 1183 words</span>
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>I've written a couple of deployment options (Google Compute Engine; Kubernetes) for an open-source project. The Kubernetes deployment provides <code>NodePort</code> and (TCP) <code>LoadBalancer</code> options and I've been trying (unsuccessfully) to add HTTPS Load-balancing.</p>
<p>I should (!) try to deploy to <a href="https://cloud.google.com/kubernetes-engine/">Google Kubernetes Engine (GKE)</a> but I've been using <a href="https://microk8s.io">microk8s</a>, Digital Ocean <a href="https://www.digitalocean.com/products/kubernetes/">Managed Kubernetes</a> and the Linode <a href="https://www.linode.com/products/kubernetes/">LKE</a> Beta. Each of these requires an implementation of Ingress controller. For GKE, GCP's HTTP/S Load-balancer (GCLB) is used. But, for the other services, NGINX Ingress is a good option and so I've been exploring NGINX Ingress (Controller) <a href="https://kubernetes.github.io/ingress-nginx/">link</a>. This Ingress appears to work except that I've been unable to get it to work with mutual TLS between the (NGINX) proxy and my backend services.</p>
<p><a href="https://github.com/kubernetes/ingress-nginx/issues/3511">This</a> may be related to my problem.</p>
<p>For microk8s, a TCP Load-balancer is required too. <a href="https://metallb.universe.tf/">MetalLB</a> just works.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply --filename<span style="color:#f92672">=</span>https://raw.githubusercontent.com/google/metallb/v0.8.3/manifests/metallb.yaml

echo <span style="color:#e6db74">&#34;apiVersion: v1
</span><span style="color:#e6db74">kind: ConfigMap
</span><span style="color:#e6db74">metadata:
</span><span style="color:#e6db74">  namespace: metallb-system
</span><span style="color:#e6db74">  name: config
</span><span style="color:#e6db74">data:
</span><span style="color:#e6db74">  config: |
</span><span style="color:#e6db74">    address-pools:
</span><span style="color:#e6db74">    - name: default
</span><span style="color:#e6db74">      protocol: layer2
</span><span style="color:#e6db74">      addresses:
</span><span style="color:#e6db74">      - 192.168.1.240-192.168.1.250
</span><span style="color:#e6db74">&#34;</span> | kubectl apply --filename<span style="color:#f92672">=</span>-

kubectl apply --filename<span style="color:#f92672">=</span>https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml

microk8s.enable ingress
</code></pre></div><p><strong>NB</strong> In the above, I'm allocating <code>192.168.1.240-192.168.1.250</code> to MetalLB to use in creating Load-balancers.</p>
<p>To test:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl run kuard --image<span style="color:#f92672">=</span>gcr.io/kuar-demo/kuard-amd64:blue --port<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span>
kubectl expose deployment/bigmachine-<span style="color:#e6db74">${</span>ID<span style="color:#e6db74">}</span> --type<span style="color:#f92672">=</span>LoadBalancer --port<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span>
</code></pre></div><p>Then browse: <code>http://$(kubectl get service/kuard --output=jsonpath=&quot;{.status.loadBalancer.ingress[0].ip}&quot;):8080</code></p>
<p>To tidy-up:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl delete deployment/kuard
kubectl delete service/kuard
</code></pre></div><h2 id="mutual-tls">Mutual TLS</h2>
<p>I then used openssl to generate &lsquo;CA&rsquo; cert|key and server cert|key PEM files. I combined the <code>.crt</code> and <code>.key</code> files into singular <code>.pem</code> files too.</p>
<p>files: <a href="https://gist.github.com/DazWilkin/ac6ca02a9bee44e5d5621aabe233eb1b">https://gist.github.com/DazWilkin/ac6ca02a9bee44e5d5621aabe233eb1b</a></p>
<p>Lastly &ndash; and where I've been spending my time &ndash; the Kubernetes spec to create secrets, Deployments|Services and an Ingress. The file is at the end of this document.</p>
<p>In my file, there are 3 distinct Deployments|Services and path specs but, for conciseness, I've collapsed that to a single Deployment|Service and 3 path specs.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply --filename<span style="color:#f92672">=</span>test.yaml
</code></pre></div><p>All being well:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get services --namespace<span style="color:#f92672">=</span>test
</code></pre></div><p>And:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">NODEPORT<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  kubectl get services/something-00 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --namespace<span style="color:#f92672">=</span>test <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.spec.ports[0].nodePort}&#34;</span><span style="color:#66d9ef">)</span>

curl --insecure --cert /path/to/ca.pem https://localhost:<span style="color:#e6db74">${</span>NODEPORT<span style="color:#e6db74">}</span>/healthz
ok
curl --insecure --cert /path/to/ca.pem https://localhost:<span style="color:#e6db74">${</span>NODEPORT<span style="color:#e6db74">}</span>/certs
-----BEGIN CERTIFICATE-----
MIIC6TCCAdGgAwIBAgIBATANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwpiaWdt
YWNoaW5lMCAXDTE5MTIwMjE5MjIyOVoYDzIwNjAwMTAxMDAwMDAwWjAVMRMwEQYD
VQQDEwpiaWdtYWNoaW5lMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA
vG3g/mKgWUkKmC3PJ8pKFXW6Gd4LMpVcMLzxJfT9RbtrwWl9FVFUEBeROlYJIvS8
5gccuZvW870noGOvMvcZNl+VjeJ/RjQeblp4siS+aGiCzCJ/l8+NsHY+j5nN6GPR
3zbS3P/sNXjtzWcLX759rpxEUzaIW6j1TgMGkG39PEUyqoOj513OzEtCrAKV/zIh
bizmdyTiHmDg7aZPj45XkojMybCdWDxOPBCcvb4qov0FPf8EaeKTzwLADvne1pCZ
uhydMOfluIpZ0AxORpxpQCLQT9ZY4voG3GQQyOlgiBn0VvXJjtpOvWNI8t4NCzUy
PLVl7HuPphJa0u4os/NBsQIDAQABo0IwQDAOBgNVHQ8BAf8EBAMCAqQwHQYDVR0l
BBYwFAYIKwYBBQUHAwIGCCsGAQUFBwMBMA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZI
hvcNAQELBQADggEBAJtePqx5npb2Pc421kaxTH4VaoU4K+BKKd62nZKwILaQbJSt
PIVYktdL2zmr2ajTNOl4YM/EfJcwS6By0duI96zG1j6dG9txMDUFurDGpc4LVr3G
AZbgtqi9gH/R4l7VUQPtGi/CKMFID5dIOrLsx6d6u7Yuohy+5tP2YUqkHHyJXznt
I932aYBPoZmFYc7WrvdSmPSYcbjeTmCO/nBiokCLGY8bP/FftIhaZ/dwf+XBwTnU
Ki+IscwXVDc+qTZLqSJgmr9vJyB+mUYI+XnIEQ7LmlFClykR+eL+BcWXptJ04r24
gQygJvBJ0TvECJkQdYduRgXCi950aE42YtKdisA<span style="color:#f92672">=</span>
-----END CERTIFICATE-----
</code></pre></div><p>Which matches the content of my ca.crt file.</p>
<p>However (!), if I try to route this request through the proxy, no joy :-(</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl --insecure --cert /path/to/ca.pem https://localhost:443/something-00/healthz
&lt;html&gt;
&lt;head&gt;&lt;title&gt;502 Bad Gateway&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;502 Bad Gateway&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;openresty/1.15.8.1&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;

curl --insecure --cert /path/to/ca.pem https://localhost:443/something-00/certs
&lt;html&gt;
&lt;head&gt;&lt;title&gt;502 Bad Gateway&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;502 Bad Gateway&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;openresty/1.15.8.1&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;

</code></pre></div><p>If I look at the Pods&rsquo; logs:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">NAMESPACE<span style="color:#f92672">=</span>test
PODS<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  kubectl get pods <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --output<span style="color:#f92672">=</span>name<span style="color:#66d9ef">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span><span style="color:#66d9ef">for</span> POD in <span style="color:#e6db74">${</span>PODS<span style="color:#e6db74">}</span>
<span style="color:#66d9ef">do</span>
  echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">** </span><span style="color:#e6db74">${</span>POD<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
  kubectl logs <span style="color:#e6db74">${</span>POD<span style="color:#e6db74">}</span> --namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span>
  echo
<span style="color:#66d9ef">done</span>
** pod/something-00-7df4f998df-879tf
2019/12/12 00:45:08 <span style="color:#f92672">[</span>main<span style="color:#f92672">]</span> CA: /secrets/ca/tls.crt
2019/12/12 00:45:08 <span style="color:#f92672">[</span>main<span style="color:#f92672">]</span> Server cert: /secrets/server/tls.crt; key: /secrets/server/tls.key
2019/12/12 00:45:08 <span style="color:#f92672">[</span>main<span style="color:#f92672">]</span> Server starting <span style="color:#f92672">[</span>:443<span style="color:#f92672">]</span>
2019/12/12 00:51:03 http: TLS handshake error from 10.1.1.1:50060: tls: client didn<span style="color:#e6db74">&#39;t provide a certificate
</span><span style="color:#e6db74">2019/12/12 00:51:03 http: TLS handshake error from 10.1.1.1:50062: tls: client didn&#39;</span>t provide a certificate
2019/12/12 00:51:03 http: TLS handshake error from 10.1.1.1:50064: tls: client didn<span style="color:#e6db74">&#39;t provide a certificate
</span><span style="color:#e6db74">2019/12/12 00:51:29 http: TLS handshake error from 10.1.1.1:50164: tls: client didn&#39;</span>t provide a certificate
2019/12/12 00:51:29 http: TLS handshake error from 10.1.1.1:50166: tls: client didn<span style="color:#e6db74">&#39;t provide a certificate
</span><span style="color:#e6db74">2019/12/12 00:51:29 http: TLS handshake error from 10.1.1.1:50168: tls: client didn&#39;</span>t provide a certificate
</code></pre></div><p>I tried restarting the Ingress using the command-line flag <code>--enable-ssl-passthrough</code> and swapping the annotations as outlined below, but this makes no difference. I achieved this by pulling the YAML for the NGINX Ingress controller, editing the YAML to include that arg and then reapplying the YAML.</p>
<p>The Ingress&rsquo; logs show nothing obvious:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">POD<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\ </span>                                                                                        
  kubectl get pods <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --selector<span style="color:#f92672">=</span>app.kubernetes.io/name<span style="color:#f92672">=</span>ingress-nginx <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --namespace<span style="color:#f92672">=</span>ingress-nginx <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.items[0].metadata.name}&#34;</span><span style="color:#66d9ef">)</span>
kubectl logs <span style="color:#e6db74">${</span>POD<span style="color:#e6db74">}</span> --namespace<span style="color:#f92672">=</span>ingress-nginx
</code></pre></div><p>results in:</p>
<pre><code>-------------------------------------------------------------------------------
NGINX Ingress controller
  Release:       0.26.1
  Build:         git-2de5a893a
  Repository:    https://github.com/kubernetes/ingress-nginx
  nginx version: openresty/1.15.8.2

-------------------------------------------------------------------------------

W1212 00:55:46.282364       6 flags.go:243] SSL certificate chain completion is disabled (--enable-ssl-chain-completion=false)
W1212 00:55:46.282446       6 client_config.go:541] Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.
I1212 00:55:46.282650       6 main.go:182] Creating API client for https://10.152.183.1:443
I1212 00:55:46.288624       6 main.go:226] Running in Kubernetes cluster version v1.16 (v1.16.3) - git (clean) commit b3cbbae08ec52a7fc73d334838e18d17e8512749 - platform linux/amd64
I1212 00:55:46.473487       6 main.go:101] SSL fake certificate created /etc/ingress-controller/ssl/default-fake-certificate.pem
I1212 00:55:46.492963       6 nginx.go:263] Starting NGINX Ingress controller
I1212 00:55:46.497370       6 event.go:255] Event(v1.ObjectReference{Kind:&quot;ConfigMap&quot;, Namespace:&quot;ingress-nginx&quot;, Name:&quot;tcp-services&quot;, UID:&quot;a48b9837-035a-40ba-a88d-cad5c4352b98&quot;, APIVersion:&quot;v1&quot;, ResourceVersion:&quot;3615062&quot;, FieldPath:&quot;&quot;}): type: 'Normal' reason: 'CREATE' ConfigMap ingress-nginx/tcp-services
I1212 00:55:46.497414       6 event.go:255] Event(v1.ObjectReference{Kind:&quot;ConfigMap&quot;, Namespace:&quot;ingress-nginx&quot;, Name:&quot;udp-services&quot;, UID:&quot;3e53e812-0fb0-4559-bad6-898577676d3d&quot;, APIVersion:&quot;v1&quot;, ResourceVersion:&quot;3615063&quot;, FieldPath:&quot;&quot;}): type: 'Normal' reason: 'CREATE' ConfigMap ingress-nginx/udp-services
I1212 00:55:46.497468       6 event.go:255] Event(v1.ObjectReference{Kind:&quot;ConfigMap&quot;, Namespace:&quot;ingress-nginx&quot;, Name:&quot;nginx-configuration&quot;, UID:&quot;280901b5-27d0-41da-9771-cf1abe3e28b4&quot;, APIVersion:&quot;v1&quot;, ResourceVersion:&quot;3615059&quot;, FieldPath:&quot;&quot;}): type: 'Normal' reason: 'CREATE' ConfigMap ingress-nginx/nginx-configuration
I1212 00:55:47.594976       6 event.go:255] Event(v1.ObjectReference{Kind:&quot;Ingress&quot;, Namespace:&quot;test&quot;, Name:&quot;something&quot;, UID:&quot;4205269b-0be4-4841-aa10-d9c5a7f09b48&quot;, APIVersion:&quot;networking.k8s.io/v1beta1&quot;, ResourceVersion:&quot;4304305&quot;, FieldPath:&quot;&quot;}): type: 'Normal' reason: 'CREATE' Ingress test/something
I1212 00:55:47.595087       6 backend_ssl.go:66] Adding Secret &quot;test/ca&quot; to the local store
I1212 00:55:47.595322       6 backend_ssl.go:66] Adding Secret &quot;test/server&quot; to the local store
I1212 00:55:47.693495       6 nginx.go:307] Starting NGINX process
I1212 00:55:47.693545       6 leaderelection.go:241] attempting to acquire leader lease  ingress-nginx/ingress-controller-leader-nginx...
I1212 00:55:47.694200       6 controller.go:134] Configuration changes detected, backend reload required.
I1212 00:55:47.694925       6 status.go:86] new leader elected: nginx-ingress-controller-568867bf56-n5q9f
I1212 00:55:47.740046       6 controller.go:150] Backend successfully reloaded.
I1212 00:55:47.740067       6 controller.go:159] Initial sync, sleeping for 1 second.
I1212 00:56:37.251319       6 status.go:86] new leader elected: nginx-ingress-controller-568867bf56-tfbll
I1212 00:56:37.251642       6 leaderelection.go:251] successfully acquired lease ingress-nginx/ingress-controller-leader-nginx
I1212 00:56:37.258543       6 status.go:274] updating Ingress test/something status from [{127.0.0.1 }] to [{10.152.183.75 }]
I1212 00:56:37.263063       6 event.go:255] Event(v1.ObjectReference{Kind:&quot;Ingress&quot;, Namespace:&quot;test&quot;, Name:&quot;something&quot;, UID:&quot;4205269b-0be4-4841-aa10-d9c5a7f09b48&quot;, APIVersion:&quot;networking.k8s.io/v1beta1&quot;, ResourceVersion:&quot;4304427&quot;, FieldPath:&quot;&quot;}): type: 'Normal' reason: 'UPDATE' Ingress test/something
</code></pre><p>Unfortunately, I'm insufficiently well-versed in NGINX configs to make much sense of the result of:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">POD<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  kubectl get pods <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --selector<span style="color:#f92672">=</span>app.kubernetes.io/name<span style="color:#f92672">=</span>ingress-nginx <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --namespace<span style="color:#f92672">=</span>ingress-nginx <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.items[0].metadata.name}&#34;</span><span style="color:#66d9ef">)</span>
kubectl exec --stdin --tty <span style="color:#e6db74">${</span>POD<span style="color:#e6db74">}</span> --namespace<span style="color:#f92672">=</span>ingress-nginx -- cat /etc/nginx/nginx.conf
</code></pre></div><p>To tidy-up</p>
<ul>
<li>either: <code>kubectl delete namespace/test</code></li>
<li>or: <code>kubectl delete --filename=test.yaml</code></li>
</ul>
<h2 id="spec">Spec</h2>
<p>Kubernetes Secret, Deployment|Service and Ingress spec:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML">---
apiVersion: v1
kind: Namespace
metadata:
  name: test
---
apiVersion: v1
kind: Secret
metadata:
  name: server
  namespace: test
data:
  tls.crt: <span style="color:#e6db74">&#34;[REDACTED]&#34;</span>
  tls.key: <span style="color:#e6db74">&#34;[REDACTED]&#34;</span>
---
apiVersion: v1
kind: Secret
metadata:
  name: ca
  namespace: test
data:
  tls.crt: <span style="color:#e6db74">&#34;[REDACTED]&#34;</span>
  tls.key: <span style="color:#e6db74">&#34;[REDACTED]&#34;</span>
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: something
  name: something<span style="color:#ae81ff">-00</span>
  namespace: test
spec:
  replicas: <span style="color:#ae81ff">1</span>
  selector:
    matchLabels:
      run: <span style="color:#e6db74">&#34;00&#34;</span>
  template:
    metadata:
      labels:
        run: <span style="color:#e6db74">&#34;00&#34;</span>
    spec:
      volumes:
        - name: ca
          secret:
            secretName: ca
        - name: server
          secret:
            secretName: server
      containers:
        - name: server
          image: dazwilkin/server@sha256:441210d5204153b4e0873881330711b86e653504cd5971c481637d223e1a82ea
          imagePullPolicy: IfNotPresent
          args:
            - --https_endpoint=:<span style="color:#ae81ff">443</span>
            - --crt_ca=/secrets/ca/tls.crt
            - --crt_server=/secrets/server/tls.crt
            - --key_server=/secrets/server/tls.key
          ports:
            - containerPort: <span style="color:#ae81ff">443</span>
              protocol: TCP
          volumeMounts:
            - name: ca
              mountPath: /secrets/ca
            - name: server
              mountPath: /secrets/server
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: something
  name: something<span style="color:#ae81ff">-00</span>
  namespace: test
spec:
  ports:
    - port: <span style="color:#ae81ff">443</span>
      protocol: TCP
      targetPort: <span style="color:#ae81ff">443</span>
  selector:
    run: <span style="color:#e6db74">&#34;00&#34;</span>
  type: NodePort
---
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  labels:
    app: something
  name: something
  namespace: test
  annotations:
    kubernetes.io/ingress.class: <span style="color:#e6db74">&#34;nginx&#34;</span>
    nginx.ingress.kubernetes.io/rewrite-target: /$<span style="color:#ae81ff">2</span>
    nginx.ingress.kubernetes.io/backend-protocol: <span style="color:#e6db74">&#34;HTTPS&#34;</span>
    nginx.ingress.kubernetes.io/proxy-ssl-secret: <span style="color:#e6db74">&#34;test/ca&#34;</span>
    nginx.ingress.kubernetes.io/proxy-ssl-verify: <span style="color:#e6db74">&#34;on&#34;</span>
    <span style="color:#75715e"># nginx.ingress.kubernetes.io/auth-tls-pass-certificate-to-upstream: &#34;true&#34;</span>
    <span style="color:#75715e"># nginx.ingress.kubernetes.io/ssl-passthrough: &#34;true&#34;</span>
spec:
  rules:
    - http:
        paths:
          - backend:
              serviceName: something<span style="color:#ae81ff">-00</span>
              servicePort: <span style="color:#ae81ff">443</span>
            path: /something<span style="color:#ae81ff">-00</span>(/|$)(.<span style="color:#75715e">*)</span>
    - http:
        paths:
          - backend:
              serviceName: something<span style="color:#ae81ff">-00</span>
              servicePort: <span style="color:#ae81ff">443</span>
            path: /something<span style="color:#ae81ff">-01</span>(/|$)(.<span style="color:#75715e">*)</span>
    - http:
        paths:
          - backend:
              serviceName: something<span style="color:#ae81ff">-00</span>
              servicePort: <span style="color:#ae81ff">443</span>
            path: /something<span style="color:#ae81ff">-02</span>(/|$)(.<span style="color:#75715e">*)</span>
  tls:
    - secretName: server
</code></pre></div><p><strong>NB</strong> crt|key PEMs bundled into Kubernetes Secrets using <code>base64 --wrap=0 ./${FILE}</code> and <code>tls.crt</code> and <code>tls.key</code> filenames respectively.</p>
<p>When trying to use SSL passthrough, I changed the paths to be:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML">spec:
   rules:
    - http:
      paths:
       - path: /
         backend:
           serviceName: something<span style="color:#ae81ff">-00</span>
           servicePort: <span style="color:#ae81ff">443</span>
</code></pre></div><ul class="pa0">
  
   <li class="list">
     <a href="/tags/kubernetes" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">kubernetes</a>
   </li>
  
   <li class="list">
     <a href="/tags/ingress" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Ingress</a>
   </li>
  
   <li class="list">
     <a href="/tags/nginx" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">NGINX</a>
   </li>
  
</ul>
<div class="mt6">
      
      
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-dark-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://pretired.dazwilkin.com/" >
    &copy;  (p)retired 2020 
  </a>
    <div>






<a href="https://www.linkedin.com/in/dazwilkin/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://github.com/DazWilkin" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>



<a href="https://medium.com/@DazWilkin" target="_blank" class="link-transition medium link dib z-999 pt3 pt0-l mr1" title="Medium link" rel="noopener" aria-label="follow on Medium——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 170 170;" version="1.1" viewBox="0 0 170 170" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M46.5340803,65.2157554 C46.6968378,63.6076572 46.0836,62.018231 44.8828198,60.93592 L32.6512605,46.2010582 L32.6512605,44 L70.6302521,44 L99.9859944,108.380952 L125.794585,44 L162,44 L162,46.2010582 L151.542017,56.2281011 C150.640424,56.9153477 150.193188,58.0448862 150.380019,59.1628454 L150.380019,132.837155 C150.193188,133.955114 150.640424,135.084652 151.542017,135.771899 L161.755369,145.798942 L161.755369,148 L110.38282,148 L110.38282,145.798942 L120.963119,135.527337 C122.002801,134.487948 122.002801,134.182246 122.002801,132.592593 L122.002801,73.0417402 L92.585901,147.755438 L88.6106443,147.755438 L54.3622782,73.0417402 L54.3622782,123.115814 C54.0767278,125.221069 54.7759199,127.3406 56.2581699,128.863022 L70.0186741,145.55438 L70.0186741,147.755438 L31,147.755438 L31,145.55438 L44.7605042,128.863022 C46.2319621,127.338076 46.8903838,125.204485 46.5340803,123.115814 L46.5340803,65.2157554 Z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>



</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
