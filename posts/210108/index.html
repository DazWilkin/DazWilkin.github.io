<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Kubernetes cert-manager | (p)retired</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Kubernetes cert-manager for Webhooks">
    <meta name="generator" content="Hugo 0.151.0-DEV">
    
    
    
    
      <meta name="robots" content="index, follow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.b89013985a078d0be77ff0f1ae39ec6d9f2c3c36e0f1aa8195900276fa8a5ad6.css" >



  


    

    
    
      

    

    

    <script data-goatcounter="https://pretired.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
 
    <meta property="og:url" content="https://pretired.dazwilkin.com/posts/210108/">
  <meta property="og:site_name" content="(p)retired">
  <meta property="og:title" content="Kubernetes cert-manager">
  <meta property="og:description" content="Kubernetes cert-manager for Webhooks">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-01-08T00:00:00-08:00">
    <meta property="article:modified_time" content="2021-01-08T00:00:00-08:00">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="Webhook">
    <meta property="article:tag" content="Akri">
    <meta property="article:tag" content="Cert-Manager">

  <meta itemprop="name" content="Kubernetes cert-manager">
  <meta itemprop="description" content="Kubernetes cert-manager for Webhooks">
  <meta itemprop="datePublished" content="2021-01-08T00:00:00-08:00">
  <meta itemprop="dateModified" content="2021-01-08T00:00:00-08:00">
  <meta itemprop="wordCount" content="1130">
  <meta itemprop="keywords" content="Kubernetes,Webhook,Akri,Cert-Manager">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Kubernetes cert-manager">
  <meta name="twitter:description" content="Kubernetes cert-manager for Webhooks">

      
    
	
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-dark-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        (p)retired
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Kubernetes cert-manager</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2021-01-08T00:00:00-08:00">January 8, 2021</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 6 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 1130 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>I developed an <a href="/posts/201229/">admission webhook</a> for Akri, twice (<a href="https://github.com/DazWilkin/akri-webhook">Golang</a>, <a href="https://github.com/DazWilkin/akri-webhook-rust">Rust</a>). I naively followed other examples for the generation of the certificates, created a 1.20 cluster and <a href="https://stackoverflow.com/questions/65587904/">broke</a> that process.</p>
<p>I&rsquo;d briefly considered using <a href="https://cert-manager.io"><code>cert-manager</code></a> recently but quickly abandoned the idea thinking it would be onerous and unnecessary complexity for little-old-me. I was wrong. It&rsquo;s excellent and I recommend it highly.</p>
<p>I won&rsquo;t reproduce the <code>v1beta1</code> and <code>v1</code> examples from the Stackoverflow question as they should be self-explanatory. I suspect (!?) that I should not have used Kubernete&rsquo;s (API Server&rsquo;s) CA for the Webhook but it could well be that I just don&rsquo;t understand the correct approach.</p>
<p>It took me under 2 hours to get <code>cert-manager</code> working though.</p>
<p>I&rsquo;ll leave it to you to deploy <code>cert-manager</code> in a cluster.</p>
<p>I&rsquo;m going to describe the new process that I have for creating a self-signed CA and then signing a Service Certificate for the Webhook with it.</p>
<p>First, some environment variables&hellip; Revise as you wish:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>DIR<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PWD<span style="color:#e6db74">}</span>/secrets
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CA<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ca&#34;</span>
</span></span><span style="display:flex;"><span>SERVICE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;yirella&#34;</span>
</span></span><span style="display:flex;"><span>NAMESPACE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;salvation&#34;</span>
</span></span></code></pre></div><blockquote>
<p><strong>Optional</strong> <code>kubectl create namespace ${NAMESPACE}</code></p></blockquote>
<p>Second, use <code>openssl</code> to generate a private key and certificate for our CA.</p>
<p>In practice, you&rsquo;d use a legitimate CA-signer and would skip this step.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl req <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-nodes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-new <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-x509 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-keyout <span style="color:#e6db74">${</span>DIR<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span>.<span style="color:#e6db74">${</span>CA<span style="color:#e6db74">}</span>.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-out <span style="color:#e6db74">${</span>DIR<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span>.<span style="color:#e6db74">${</span>CA<span style="color:#e6db74">}</span>.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-subj <span style="color:#e6db74">&#34;/CN=</span><span style="color:#e6db74">${</span>CA<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-days <span style="color:#ae81ff">365</span>
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> Common Names (<code>CN</code>) are deprecated but used here primarily for labelling. If you prefer, you could write a config files, generate a CSR and (self-)sign that.</p></blockquote>
<p>Third, cert-manager manages Certificates using Kubernetes Secrets. So, let&rsquo;s create a Secret from the private key and certificate we just created:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create secret tls <span style="color:#e6db74">${</span>CA<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--cert<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>DIR<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span>.<span style="color:#e6db74">${</span>CA<span style="color:#e6db74">}</span>.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--key<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>DIR<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span>.<span style="color:#e6db74">${</span>CA<span style="color:#e6db74">}</span>.key
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> I&rsquo;m create this in a working namespace (<code>${NAMESPACE}</code>) because I&rsquo;m going to use <code>Issuer</code>. If you want cluster-wide issuance, this would need to be created (by default) in <code>cert-manager</code> namespace (configurable) and you&rsquo;d use <code>ClusterIssuer</code>.</p></blockquote>
<p>Fourth, create an <code>Issuer</code> from the Secret:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: cert-manager.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Issuer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: </span><span style="color:#e6db74">${</span>CA<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: </span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ca:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    secretName: </span><span style="color:#e6db74">${</span>CA<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span> | kubectl apply --filename<span style="color:#f92672">=</span>-
</span></span></code></pre></div><p>You may confirm this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get issuer/<span style="color:#e6db74">${</span>CA<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--output<span style="color:#f92672">=</span>wide
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME   READY   STATUS                AGE
</span></span><span style="display:flex;"><span>ca     True    Signing CA verified   15s
</span></span></code></pre></div><p>Fifth, create a <code>Certificate</code> (and Secret) for the Service using the <code>Issuer</code>.</p>
<blockquote>
<p><strong>NOTE</strong> In my case, with the Webhook, I found it necessary to include the Webhook&rsquo;s Endpoint in its certificate. You <em>may</em> be able to drop both <code>commonName</code> and <code>ipAddresses</code> entries from the following specification.</p></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Endpoint for Service `${SERVICE}.${NAMESPACE}.svc`</span>
</span></span><span style="display:flex;"><span>ENDPOINT<span style="color:#f92672">=(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  kubectl get service/<span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.spec.clusterIP}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apiVersion: cert-manager.io/v1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">kind: Certificate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  name: </span><span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  namespace: </span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  # Output
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  secretName: </span><span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  duration: 8760h
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  renewBefore: 720h
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  subject:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  commonName: </span><span style="color:#e6db74">${</span>ENDPOINT<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  isCA: false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  privateKey:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    algorithm: RSA
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    encoding: PKCS1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    size: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  usages:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - server auth
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  dnsNames:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - </span><span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span><span style="color:#e6db74">.</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span><span style="color:#e6db74">.svc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - </span><span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span><span style="color:#e6db74">.</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span><span style="color:#e6db74">.svc.cluster.local
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ipAddresses:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - </span><span style="color:#e6db74">${</span>ENDPOINT<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  issuerRef:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    name: ca
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    kind: Issuer
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    group: cert-manager.io
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span> | kubectl apply --filename<span style="color:#f92672">=</span>-
</span></span></code></pre></div><p>You may confirm this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get certificate/<span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--output<span style="color:#f92672">=</span>wide
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME     READY   SECRET   ISSUER   STATUS                                          AGE
</span></span><span style="display:flex;"><span>yirella  True    yirella  ca       Certificate is up to date and has not expired   15s
</span></span></code></pre></div><p>This results in the creation of a Secret (<code>${SERVICE}</code>) in Namespace (<code>${NAMESPACE}</code>) signed by the self-signed CA</p>
<p>We can <code>get</code> the Secret:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get secret/<span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--output<span style="color:#f92672">=</span>yaml
</span></span></code></pre></div><p>This yields something similar to:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">data</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ca.crt</span>: <span style="color:#ae81ff">LS0tLS1C...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tls.crt</span>: <span style="color:#ae81ff">LS0tLS1C...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tls.key</span>: <span style="color:#ae81ff">LS0tLS1C...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">callum</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">salvation</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">type</span>: <span style="color:#ae81ff">kubernetes.io/tls</span>
</span></span></code></pre></div><p>You&rsquo;ll note that the Secret includes a private key (<code>tls.key</code>) and certificate (<code>tls.crt</code>) for the Service and the CA&rsquo;s certificate (<code>ca.crt</code>). We can grab e.g. the Service certificate, base64 decode it and have openssl display it for us:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get secret/<span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>&gt; --namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>&gt; --output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.data.tls\.crt}&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>&gt; | base64 --decode <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>&gt; | openssl x509 -in - -noout -text
</span></span></code></pre></div><p>Which yields:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>Certificate:
</span></span><span style="display:flex;"><span>    Data:
</span></span><span style="display:flex;"><span>        Version: 3 (0x2)
</span></span><span style="display:flex;"><span>        Serial Number:
</span></span><span style="display:flex;"><span>        Signature Algorithm: sha256WithRSAEncryption
</span></span><span style="display:flex;"><span>        Issuer: CN = ca
</span></span><span style="display:flex;"><span>        Validity
</span></span><span style="display:flex;"><span>            Not Before: Jan  8 20:50:37 2021 GMT
</span></span><span style="display:flex;"><span>            Not After : Jan  8 20:50:37 2022 GMT
</span></span><span style="display:flex;"><span>        Subject: CN = 10.138.0.2
</span></span><span style="display:flex;"><span>        Subject Public Key Info:
</span></span><span style="display:flex;"><span>            Public Key Algorithm: rsaEncryption
</span></span><span style="display:flex;"><span>                RSA Public-Key: (2048 bit)
</span></span><span style="display:flex;"><span>                Modulus:
</span></span><span style="display:flex;"><span>        X509v3 extensions:
</span></span><span style="display:flex;"><span>            X509v3 Extended Key Usage: 
</span></span><span style="display:flex;"><span>                TLS Web Server Authentication
</span></span><span style="display:flex;"><span>            X509v3 Basic Constraints: critical
</span></span><span style="display:flex;"><span>                CA:FALSE
</span></span><span style="display:flex;"><span>            X509v3 Authority Key Identifier: 
</span></span><span style="display:flex;"><span>            X509v3 Subject Alternative Name: 
</span></span><span style="display:flex;"><span>                DNS:callum.salvation.svc, DNS:callum.salvation.svc.cluster.local, IP Address:10.138.0.2
</span></span><span style="display:flex;"><span>    Signature Algorithm: sha256WithRSAEncryption
</span></span></code></pre></div><p>I&rsquo;ve deleted all the superfluous details but:</p>
<ul>
<li>Expiry is 365 days (8760 hours) from today (Jan 8 2021 &ndash;&gt; Jan 8 2020)</li>
<li><code>CN</code> is the value of the <code>${ENDPOINT}</code> that was provided</li>
<li><code>DNS</code> entries are (correct) Kubernetes Services names <code>${SERVICE}.${NAMESPACE}.svc[.cluster.local]</code></li>
</ul>
<p>Sixth, we now have everything that we need to configure a Kubernetes Webhook</p>
<p>You&rsquo;ll recall we already exposed a Service (to get its Endpoint) but this was backed by no Pods.</p>
<p>We can create a Deployment to underpin this Service, configured to use the TLS certificate and private key generated by cert-manager:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SERVICE</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">NAMESPACE</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">webhook</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">component</span>: <span style="color:#ae81ff">webhook</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">component</span>: <span style="color:#ae81ff">webhook</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">webhook</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">some/image</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">Always</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>            - --<span style="color:#ae81ff">tls-crt-file=/secrets/tls.crt</span>
</span></span><span style="display:flex;"><span>            - --<span style="color:#ae81ff">tls-key-file=/secrets/tls.key</span>
</span></span><span style="display:flex;"><span>            - --<span style="color:#ae81ff">port=8443</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">secrets</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/secrets</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">secrets</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">secret</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">SERVICE</span>
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> The <code>VARIABLE</code> names can be replaced at <code>kubectl apply</code> using <code>sed</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat deployment.yaml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| sed <span style="color:#e6db74">&#34;s|SERVICE|</span><span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span><span style="color:#e6db74">|g&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| sed <span style="color:#e6db74">&#34;s|NAMESPACE|</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span><span style="color:#e6db74">|g&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| kubectl apply --filename<span style="color:#f92672">=</span>-
</span></span></code></pre></div></blockquote>
<p>This is an exemplar Deployment spec that runs a container (<code>webhook</code>) configure to use a TLS certificate and private key mounted using the Secret, in this case, generated for us by cert-manager.</p>
<p>Then we can configure a Kubernetes Webhook using the (now backed) Service with the CA bundle (also present in the Secret as <code>ca.crt</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>CABUNDLE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  kubectl get secret/<span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.data.ca\.crt}&#34;</span><span style="color:#66d9ef">)</span> <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">${</span>CABUNDLE<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>With:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-YAML" data-lang="YAML"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">admissionregistration.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ValidatingWebhookConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SERVICE</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">NAMESPACE</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">webhook</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">webhooks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SERVICE.NAMESPACE.svc</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">clientConfig</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SERVICE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">NAMESPACE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port</span>: <span style="color:#ae81ff">443</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">path</span>: <span style="color:#e6db74">&#34;/validate&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">caBundle</span>: <span style="color:#ae81ff">CABUNDLE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">operations</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#e6db74">&#34;CREATE&#34;</span>
</span></span><span style="display:flex;"><span>          - <span style="color:#e6db74">&#34;UPDATE&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">apiGroups</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#e6db74">&#34;akri.sh&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">apiVersions</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#e6db74">&#34;v0&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#e6db74">&#34;configurations&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">scope</span>: <span style="color:#e6db74">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">admissionReviewVersions</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">sideEffects</span>: <span style="color:#ae81ff">None</span>
</span></span></code></pre></div><blockquote>
<p><strong>NOTE</strong> You&rsquo;ll need to revise the <code>ValidatingWebhookConfiguration</code> for your purposes but this shows the overall structure. It&rsquo;s important that the <code>webhook.name</code> be <code>${SERVICE}.${NAMESPACE}.svc</code> and the use of <code>caBundle</code></p></blockquote>
<blockquote>
<p><strong>NOTE</strong> Not shown here, the Service that exposes the Deployment&rsquo;s Pods maps the Pod&rsquo;s port <code>:8443</code> to a Service port: <code>:443</code> which is more conventional for TLS and required (!?) by Kubernetes Webhooks.</p></blockquote>
<blockquote>
<p><strong>NOTE</strong> Kubernetes is configured with the Service&rsquo;s (!) CA bundle and it validates the Webhook service&rsquo;s certificate but the Webhook service does not validate the client (i.e. Kubernetes&rsquo; API Server).</p></blockquote>
<p>When you&rsquo;re done, you can tidy simply by deleting the <code>${NAMESPACE}</code> namespace or, more delicately:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># NB Webhooks aren&#39;t namespaced</span>
</span></span><span style="display:flex;"><span>kubectl delete validatingwebhookconfiguration/<span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl delete deployment/<span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl delete service/<span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl delete secret/<span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl delete certificate/<span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl delete issuer/<span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--namespace<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>NAMESPACE<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>That&rsquo;s all!</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/kubernetes/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Kubernetes</a>
   </li>
  
   <li class="list di">
     <a href="/tags/webhook/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Webhook</a>
   </li>
  
   <li class="list di">
     <a href="/tags/akri/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Akri</a>
   </li>
  
   <li class="list di">
     <a href="/tags/cert-manager/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Cert-Manager</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/201229/">Kubernetes Webhooks</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201217/">Kubernetes Device Plugins</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201113/">Akri</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201022/">akri</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/201029/">GitHub Actions &amp;&amp; GitHub Container Registry</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/191211/">NGINX Ingress</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-dark-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://pretired.dazwilkin.com/" >
    &copy;  (p)retired 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>