<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Google Trillian on Cloud Run | (p)retired</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Running Google Trillian on Google Cloud Run">
    <meta name="generator" content="Hugo 0.150.0-DEV">
    
    
    
    
      <meta name="robots" content="index, follow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.b89013985a078d0be77ff0f1ae39ec6d9f2c3c36e0f1aa8195900276fa8a5ad6.css" >



  


    

    
    
      

    

    

    <script data-goatcounter="https://pretired.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
 
    <meta property="og:url" content="https://pretired.dazwilkin.com/posts/200326/">
  <meta property="og:site_name" content="(p)retired">
  <meta property="og:title" content="Google Trillian on Cloud Run">
  <meta property="og:description" content="Running Google Trillian on Google Cloud Run">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-03-26T00:00:00-08:00">
    <meta property="article:modified_time" content="2020-03-26T00:00:00-08:00">
    <meta property="article:tag" content="Google">
    <meta property="article:tag" content="Trillian">
    <meta property="article:tag" content="Cloud-Run">
    <meta property="article:tag" content="GRPC">
    <meta property="article:tag" content="GRPCurl">

  <meta itemprop="name" content="Google Trillian on Cloud Run">
  <meta itemprop="description" content="Running Google Trillian on Google Cloud Run">
  <meta itemprop="datePublished" content="2020-03-26T00:00:00-08:00">
  <meta itemprop="dateModified" content="2020-03-26T00:00:00-08:00">
  <meta itemprop="wordCount" content="1101">
  <meta itemprop="keywords" content="Google,Trillian,Cloud-Run,GRPC,GRPCurl">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Google Trillian on Cloud Run">
  <meta name="twitter:description" content="Running Google Trillian on Google Cloud Run">

      
    
	
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-dark-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        (p)retired
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Google Trillian on Cloud Run</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2020-03-26T00:00:00-08:00">March 26, 2020</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 6 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 1101 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>I&rsquo;ve written previously (<a href="https://medium.com/google-cloud/google-trillian-for-noobs-1a-c87a78e5e585">Google Trillian for Noobs</a>) about Google&rsquo;s interesting project <a href="https://github.com/google/trillian">Trillian</a> and about some of the &ldquo;personalities&rdquo; (e.g. <a href="/posts/190907/">PyPi Transparency</a>) that I&rsquo;ve build using it.</p>
<p>Having gone slight cra-cra on <a href="https://cloud.google.com/run">Cloud Run</a> and <a href="https://grpc.io">gRPC</a> this week with <a href="/posts/200320/">Golang gRPC Cloud Run</a> and <a href="/posts/200325/">gRPC, Cloud Run &amp; Endpoints</a>, I thought it&rsquo;d be fun to deploy Trillian and a personality to Cloud Run.</p>
<p>It mostly (!) works :-)</p>
<p>At the end of the post, I&rsquo;ve summarized creating a Cloud SQL instance to host the Trillian data(base).</p>
<p>You&rsquo;ll need a GCP project, billing established (!?) and Cloud Run enabled</p>
<h3 id="project">Project</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>BILLING<span style="color:#f92672">=[[</span>YOUR-BILLING<span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>PROJECT<span style="color:#f92672">=[[</span>YOUR-PROJECT<span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>REGION<span style="color:#f92672">=[[</span>YOUR-REGION<span style="color:#f92672">]]</span> <span style="color:#75715e"># Perhaps &#34;us-west1&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gcloud projects create <span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>gcloud beta billing projects link <span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--billing-account<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>BILLING<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Enable Cloud Run</span>
</span></span><span style="display:flex;"><span>gcloud services enable run.googleapis.com <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span></code></pre></div><h3 id="cloud-run">Cloud Run</h3>
<p>OK, using Trillian&rsquo;s public container images, let&rsquo;s deploy a Log Server and a Log Signer configured to use our Cloud SQL instance:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Endpoint for Cloud Run services must be port 8080</span>
</span></span><span style="display:flex;"><span>ENDPOINT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.0.0.0:8080&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cloud SQL Instance details</span>
</span></span><span style="display:flex;"><span>INST<span style="color:#f92672">=[</span>YOUR-INST<span style="color:#f92672">]</span> <span style="color:#75715e"># Perhaps &#34;db&#34;</span>
</span></span><span style="display:flex;"><span>CONN<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  gcloud sql instances describe <span style="color:#e6db74">${</span>INST<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;value(connectionName)&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Details for the database &#34;test&#34; on the instance</span>
</span></span><span style="display:flex;"><span>USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>PASS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zaphod&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Log Server</span>
</span></span><span style="display:flex;"><span>gcloud run deploy trillian-log-server <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--image<span style="color:#f92672">=</span>gcr.io/trillian-opensource-ci/log_server@sha256:a027dd696a20c8741a88264d84ee08ff19343f84f297fb3afbf6b23ef799851f <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--args<span style="color:#f92672">=</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;--mysql_uri=</span><span style="color:#e6db74">${</span>USER<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">${</span>PASS<span style="color:#e6db74">}</span><span style="color:#e6db74">@unix(/cloudsql/</span><span style="color:#e6db74">${</span>CONN<span style="color:#e6db74">}</span><span style="color:#e6db74">)/test&#34;</span>,<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;--rpc_endpoint=</span><span style="color:#e6db74">${</span>ENDPOINT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;alsologtostderr&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--add-cloudsql-instances<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CONN<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set-env-vars<span style="color:#f92672">=</span>INSTANCE_CONNECTION_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CONN<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--allow-unauthenticated <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Log Signer</span>
</span></span><span style="display:flex;"><span>gcloud run deploy trillian-log-signer <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--image<span style="color:#f92672">=</span>gcr.io/trillian-opensource-ci/log_signer@sha256:7d8ff9fba9863adca440c4ddc51080162d3d246c3b71d3929ce3b57bd6f979cf <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--args<span style="color:#f92672">=</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;--mysql_uri=</span><span style="color:#e6db74">${</span>USER<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">${</span>PASS<span style="color:#e6db74">}</span><span style="color:#e6db74">@unix(/cloudsql/</span><span style="color:#e6db74">${</span>CONN<span style="color:#e6db74">}</span><span style="color:#e6db74">)/test&#34;</span>,<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;--rpc_endpoint=</span><span style="color:#e6db74">${</span>ENDPOINT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;--batch_size=1000&#34;</span>,<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;--sequencer_guard_window=0&#34;</span>,<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;--sequencer_interval=200ms&#34;</span>,<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;--force_master&#34;</span>,<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;--logtostderr&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--add-cloudsql-instances<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CONN<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--set-env-vars<span style="color:#f92672">=</span>INSTANCE_CONNECTION_NAME<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CONN<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--allow-unauthenticated <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span></code></pre></div><blockquote>
<p><strong>NB</strong> It is possible to pass flags (<code>--flag=value</code>) to Cloud Run but it&rsquo;s not clearly documented</p></blockquote>
<blockquote>
<p><strong>NB</strong> We must <strong>triple</strong> reference the database (a) <code>--msql_url=</code>; (b) <code>--add-cloudsql-instance</code>; (c) <code>--set-env-vars=INSTANCE_CONNECTION</code></p></blockquote>
<p>Cloud Run injects a proxy (sidecar) into deployments and (among other things?) provides a TLS endpoint. In order to connect to the Trillian Log Server, we must (a) get the service&rsquo;s endpoint; (b) grab the server&rsquo;s TLS certificate; (c) create a Trillian Log using the Log Server (on the Cloud SQL database):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Grab the Log Server&#39;s (Cloud Run) address</span>
</span></span><span style="display:flex;"><span>TRILLIAN_LOG_SERVER<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  gcloud run services describe trillian-log-server <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;value(status.address.url)&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Ditch the prefixing &#34;https://&#34;</span>
</span></span><span style="display:flex;"><span>TRILLIAN_LOG_SERVER<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>TRILLIAN_LOG_SERVER#https://<span style="color:#e6db74">}</span> <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">${</span>TRILLIAN_LOG_SERVER<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Determine the Log Server&#39;s certificate</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cloud Run automatically proxies (sidecar) deployed container&#39;s endpoint</span>
</span></span><span style="display:flex;"><span>openssl s_client -showcerts -servername <span style="color:#e6db74">${</span>TRILLIAN_LOG_SERVER<span style="color:#e6db74">}</span> -connect <span style="color:#e6db74">${</span>TRILLIAN_LOG_SERVER<span style="color:#e6db74">}</span>:443 2&gt;/dev/null &lt;/dev/null <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>| sed -ne <span style="color:#e6db74">&#39;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p&#39;</span> &gt; ./<span style="color:#e6db74">${</span>TRILLIAN_LOG_SERVER<span style="color:#e6db74">}</span>.pem
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create a Log ID</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Requires the Log Server&#39;s cert because Cloud Run proxies traffic through TLS</span>
</span></span><span style="display:flex;"><span>LOGID<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  go run github.com/google/trillian/cmd/createtree <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --tls_cert_file<span style="color:#f92672">=</span>./<span style="color:#e6db74">${</span>TRILLIAN_LOG_SERVER<span style="color:#e6db74">}</span>.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --admin_server<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>TRILLIAN_LOG_SERVER<span style="color:#e6db74">}</span>:443<span style="color:#66d9ef">)</span> <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">${</span>LOGID<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>You&rsquo;ll need a Trillian personality for the next step.</p>
<p>I&rsquo;m using one that I created earlier but I recommend you deploy your own and use my personality as a guide:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Determine personality current commit</span>
</span></span><span style="display:flex;"><span>TAG<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>git rev-parse HEAD<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NB Cloud Run sidecars the container with a(n Envoy proxied?) TLS endpoint on port 443</span>
</span></span><span style="display:flex;"><span>gcloud run deploy pypi-transparency-server <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--image<span style="color:#f92672">=</span>gcr.io/<span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>/server:<span style="color:#e6db74">${</span>TAG<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--args<span style="color:#f92672">=</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;--grpc_endpoint=</span><span style="color:#e6db74">${</span>ENDPOINT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;--tlog_endpoint=</span><span style="color:#e6db74">${</span>TRILLIAN_LOG_SERVER<span style="color:#e6db74">}</span><span style="color:#e6db74">:443&#34;</span>,<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;--tlog_id=</span><span style="color:#e6db74">${</span>LOGID<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">&#34;--package_cache=/tmp&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--allow-unauthenticated <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span></code></pre></div><blockquote>
<p><strong>NB</strong> The personality connects to the Trillian Log Server on the Cloud Run service&rsquo;s host (<code>${TRILLIAN_LOG_SERVER}</code>) and port 443</p></blockquote>
<blockquote>
<p><strong>NB</strong> The personality also uses a log created in the previous step (<code>${LOGID}</code>)</p></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Grab the PyPi Transparency Server&#39;s (Cloud Run) address</span>
</span></span><span style="display:flex;"><span>PYPI_SERVER<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  gcloud run services describe pypi-transparency-server <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;value(status.address.url)&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Ditch the prefixing &#34;https://&#34;</span>
</span></span><span style="display:flex;"><span>PYPI_SERVER<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PYPI_SERVER#https://<span style="color:#e6db74">}</span> <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">${</span>PYPI_SERVER<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>This is where my personality deployment (I think the Trillian services work correctly) falls short. I should be able to now <code>gprcurl</code> the endpoint but this fails:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>grpcurl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{ &#34;package&#34;: {&#34;name&#34;: &#34;protobuf&#34;, &#34;version&#34;: &#34;3.11.3&#34;, &#34;filename&#34;: &#34;protobuf-3.11.3-cp38-cp38-manylinux1_x86_64.whl&#34;, &#34;url&#34;: &#34;https://files.pythonhosted.org/packages/9a/71/5cdb5ed762a537eac39097ae6ecf8785e276b5044efe99b8e53cb3addd7f/protobuf-3.11.3-cp38-cp38-manylinux1_x86_64.whl&#34; }}&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-proto protos/pypi_transparency.proto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-proto protos/package.proto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">${</span>PYPI_SERVER<span style="color:#e6db74">}</span>:443 pypitransparency.v1.PyPiTransparency.AddPackage
</span></span><span style="display:flex;"><span>ERROR:
</span></span><span style="display:flex;"><span>  Code: Unavailable
</span></span><span style="display:flex;"><span>  Message: connection closed
</span></span></code></pre></div><p>Example: <a href="https://pypi.org/project/protobuf/3.11.3/#description">PyPi: protobuf 3.11.3</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JSON" data-lang="JSON"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&#34;Package&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;protobuf&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&#34;version&#34;</span>: <span style="color:#e6db74">&#34;3.11.3&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&#34;filename&#34;</span>: <span style="color:#e6db74">&#34;protobuf-3.11.3-cp38-cp38-manylinux1_x86_64.whl&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&#34;url&#34;</span>: <span style="color:#e6db74">&#34;https://files.pythonhosted.org/packages/9a/71/5cdb5ed762a537eac39097ae6ecf8785e276b5044efe99b8e53cb3addd7f/protobuf-3.11.3-cp38-cp38-manylinux1_x86_64.whl&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I&rsquo;ll update this post when I understand my mistake :-)</p>
<p>Aha! My mistake was that the <code>pypi-transparency-server</code> was failing when making an insecure connection to the <code>trillian-log-server</code> (because this is how I role during development). I revised the <code>pypi-transparency-server</code> so that it uses the system certificate pool to make the connection and now the <code>grpcurl</code> works as expected:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#a6e22e">systemCertPool</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">x509</span>.<span style="color:#a6e22e">SystemCertPool</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;failed to load system root CA cert pool&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">creds</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">credentials</span>.<span style="color:#a6e22e">NewTLS</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">tls</span>.<span style="color:#a6e22e">Config</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">RootCAs</span>: <span style="color:#a6e22e">systemCertPool</span>,
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dialOpts</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">DialOption</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">WithTransportCredentials</span>(<span style="color:#a6e22e">creds</span>),
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">grpc</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">tLogEndpoint</span>, <span style="color:#a6e22e">dialOpts</span><span style="color:#f92672">...</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
</span></span></code></pre></div><p>and:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># AddPackage</span>
</span></span><span style="display:flex;"><span>grpcurl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{ &#34;package&#34;: {&#34;name&#34;: &#34;protobuf&#34;, &#34;version&#34;: &#34;3.11.3&#34;, &#34;filename&#34;: &#34;protobuf-3.11.3-cp38-cp38-manylinux1_x86_64.whl&#34;, &#34;url&#34;: &#34;https://files.pythonhosted.org/packages/9a/71/5cdb5ed762a537eac39097ae6ecf8785e276b5044efe99b8e53cb3addd7f/protobuf-3.11.3-cp38-cp38-manylinux1_x86_64.whl&#34; }}&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-proto protos/pypi_transparency.proto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-proto protos/package.proto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">${</span>PYPI_SERVER<span style="color:#e6db74">}</span>:443 pypitransparency.v1.PyPiTransparency.AddPackage
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ok&#34;</span>: true
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># GetPackage</span>
</span></span><span style="display:flex;"><span>grpcurl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{ &#34;package&#34;: {&#34;name&#34;: &#34;protobuf&#34;, &#34;version&#34;: &#34;3.11.3&#34;, &#34;filename&#34;: &#34;protobuf-3.11.3-cp38-cp38-manylinux1_x86_64.whl&#34;, &#34;url&#34;: &#34;https://files.pythonhosted.org/packages/9a/71/5cdb5ed762a537eac39097ae6ecf8785e276b5044efe99b8e53cb3addd7f/protobuf-3.11.3-cp38-cp38-manylinux1_x86_64.whl&#34; }}&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-proto protos/pypi_transparency.proto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-proto protos/package.proto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">${</span>PYPI_SERVER<span style="color:#e6db74">}</span>:443 pypitransparency.v1.PyPiTransparency.GetPackage
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ok&#34;</span>: true
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The following calls merely parse the protos but...</span>
</span></span><span style="display:flex;"><span>grpcurl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-proto protos/pypi_transparency.proto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-proto protos/package.proto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>list pypitransparency.v1.PyPiTransparency
</span></span><span style="display:flex;"><span>pypitransparency.v1.PyPiTransparency.AddPackage
</span></span><span style="display:flex;"><span>pypitransparency.v1.PyPiTransparency.GetInclusionProof
</span></span><span style="display:flex;"><span>pypitransparency.v1.PyPiTransparency.GetPackage
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>grpcurl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-proto protos/pypi_transparency.proto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-proto protos/package.proto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>describe pypitransparency.v1.PyPiTransparency.AddPackage
</span></span><span style="display:flex;"><span>pypitransparency.v1.PyPiTransparency.AddPackage is a method:
</span></span><span style="display:flex;"><span>rpc AddPackage <span style="color:#f92672">(</span> .pypitransparency.v1.AddPackageRequest <span style="color:#f92672">)</span> returns <span style="color:#f92672">(</span> .pypitransparency.v1.AddPackageResponse <span style="color:#f92672">)</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>grpcurl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-proto protos/pypi_transparency.proto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-proto protos/package.proto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>describe pypitransparency.v1.PyPiTransparency.GetPackage
</span></span><span style="display:flex;"><span>pypitransparency.v1.PyPiTransparency.GetPackage is a method:
</span></span><span style="display:flex;"><span>rpc GetPackage <span style="color:#f92672">(</span> .pypitransparency.v1.GetPackageRequest <span style="color:#f92672">)</span> returns <span style="color:#f92672">(</span> .pypitransparency.v1.GetPackageResponse <span style="color:#f92672">)</span>;
</span></span></code></pre></div><h3 id="cloud-sql">Cloud SQL</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>INST<span style="color:#f92672">=[[</span>YOUR-INST<span style="color:#f92672">]]</span> <span style="color:#75715e"># Perhaps &#34;db&#34;</span>
</span></span><span style="display:flex;"><span>ROOT<span style="color:#f92672">=[[</span>YOUR-ROOT<span style="color:#f92672">]]</span> <span style="color:#75715e"># Something unique to this database instance</span>
</span></span><span style="display:flex;"><span>gcloud sql instances create <span style="color:#e6db74">${</span>INST<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--tier<span style="color:#f92672">=</span>db-f1-micro <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--storage-type<span style="color:#f92672">=</span>HDD <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--availability-type<span style="color:#f92672">=</span>zonal <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--no-backup <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--database-version<span style="color:#f92672">=</span>MYSQL_5_7 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--root-password<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>ROOT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>We&rsquo;ll need to create a database on the instance and populate it with Trillian&rsquo;s schema.</p>
<p>In one shell:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>CONN<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  gcloud sql instances describe <span style="color:#e6db74">${</span>INST<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;value(connectionName)&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>./cloud_sql_proxy -instances<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>CONN<span style="color:#e6db74">}</span><span style="color:#f92672">=</span>tcp:3306
</span></span></code></pre></div><blockquote>
<p><strong>NB</strong> You&rsquo;ll need Google&rsquo;s <a href="https://cloud.google.com/sql/docs/mysql/sql-proxy#install">Cloud SQL Proxy</a></p></blockquote>
<blockquote>
<p><strong>NB</strong> Once the proxy is running, it proxies traffic sent to it (<code>localhost</code>) to the remote instance (<code>${DB}</code>)</p></blockquote>
<p>Then, in another shell, get a client to the database:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>VERSION<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;10.4.12&#34;</span>
</span></span><span style="display:flex;"><span>docker run <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--interactive --tty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--net<span style="color:#f92672">=</span>host <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>mariadb:<span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  sh -c <span style="color:#e6db74">&#34;exec mysql --host=127.0.0.1 --port=3306 --password=</span><span style="color:#e6db74">${</span>ROOT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>And, paste in:</p>
<pre tabindex="0"><code>drop database if exists test;
create database test;
create user if not exists test@&#39;%&#39; identified by &#39;zaphod&#39;;
grant all on test.* to test@&#39;%&#39;;
</code></pre><p>Then quit it and then:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test&#34;</span>
</span></span><span style="display:flex;"><span>PASS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;zaphod&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker run <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--interactive --tty <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--net<span style="color:#f92672">=</span>host <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--volume<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PWD<span style="color:#e6db74">}</span>/trillian.sql:/trillian.sql <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>mariadb:<span style="color:#e6db74">${</span>VERSION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  sh -c <span style="color:#e6db74">&#34;exec mysql --host=127.0.0.1 --port=3306 --user=</span><span style="color:#e6db74">${</span>USER<span style="color:#e6db74">}</span><span style="color:#e6db74"> --password=</span><span style="color:#e6db74">${</span>PASS<span style="color:#e6db74">}</span><span style="color:#e6db74"> test &lt; /trillian.sql&#34;</span>
</span></span></code></pre></div><blockquote>
<p><strong>NB</strong> Here&rsquo;s the script <a href="https://gist.github.com/DazWilkin/5d4cb0974a5f4f4bf88bafdfe8141443"><code>trillian.sql</code></a></p></blockquote>
<h3 id="tidy">Tidy</h3>
<p>If you&rsquo;re <strong>absolutely</strong> certain you don&rsquo;t need the project, you can delete everything by deleting the project:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud projects delete <span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> --quiet
</span></span></code></pre></div><p>Otherwise, you can delete the pieces:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> SERVICE in <span style="color:#e6db74">&#34;trillian-log-server&#34;</span> <span style="color:#e6db74">&#34;trillian-log-signer&#34;</span> <span style="color:#e6db74">&#34;pypi-transparency-server&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  gcloud run services delete <span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --quiet
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>and the Cloud SQL instance:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud sql instances delete <span style="color:#e6db74">${</span>INST<span style="color:#e6db74">}</span> --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Done.
</span></span></code></pre></div><ul class="pa0">
  
   <li class="list di">
     <a href="/tags/google/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Google</a>
   </li>
  
   <li class="list di">
     <a href="/tags/trillian/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Trillian</a>
   </li>
  
   <li class="list di">
     <a href="/tags/cloud-run/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Cloud-Run</a>
   </li>
  
   <li class="list di">
     <a href="/tags/grpc/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">GRPC</a>
   </li>
  
   <li class="list di">
     <a href="/tags/grpcurl/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">GRPCurl</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/200325/">gRPC, Cloud Run &amp; Endpoints</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200320/">Golang gRPC Cloud Run</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200207/">Accessing GCR repos from Kubernetes</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200206/">Cloud Build wishlist: Mountable Golang Modules Proxy</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190930/">PyPi Transparency Client (Rust)</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190926/">PyPi Transparency</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190918/">Cloud Functions Simple(st) HTTP Multi-host Proxy</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190917/">Cloud Functions Simple(st) HTTP Proxy</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-dark-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://pretired.dazwilkin.com/" >
    &copy;  (p)retired 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>