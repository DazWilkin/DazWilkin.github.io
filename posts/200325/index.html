<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>gRPC, Cloud Run &amp; Endpoints | (p)retired</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Combining gRPC, Google Cloud Run and Google Cloud Endpoints">
    <meta name="generator" content="Hugo 0.148.0-DEV">
    
    
    
    
      <meta name="robots" content="index, follow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.8d048772ae72ab11245a0e296d1f2a36d3e3dd376c6c867394d6cc659c68fc37.css" >




    

    
    
      

    

    

    <script data-goatcounter="https://pretired.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
 
    <meta property="og:url" content="https://pretired.dazwilkin.com/posts/200325/">
  <meta property="og:site_name" content="(p)retired">
  <meta property="og:title" content="gRPC, Cloud Run & Endpoints">
  <meta property="og:description" content="Combining gRPC, Google Cloud Run and Google Cloud Endpoints">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-03-25T00:00:00-08:00">
    <meta property="article:modified_time" content="2020-03-25T00:00:00-08:00">
    <meta property="article:tag" content="Google">
    <meta property="article:tag" content="Golang">
    <meta property="article:tag" content="Cloud-Run">
    <meta property="article:tag" content="GRPC">
    <meta property="article:tag" content="GRPCurl">
    <meta property="article:tag" content="Protobufs">

  <meta itemprop="name" content="gRPC, Cloud Run & Endpoints">
  <meta itemprop="description" content="Combining gRPC, Google Cloud Run and Google Cloud Endpoints">
  <meta itemprop="datePublished" content="2020-03-25T00:00:00-08:00">
  <meta itemprop="dateModified" content="2020-03-25T00:00:00-08:00">
  <meta itemprop="wordCount" content="918">
  <meta itemprop="keywords" content="Google,Golang,Cloud-Run,GRPC,GRPCurl,Protobufs,Rust,ESP,Cloud-Endpoints">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="gRPC, Cloud Run & Endpoints">
  <meta name="twitter:description" content="Combining gRPC, Google Cloud Run and Google Cloud Endpoints">

      
    
	
  </head>

  <body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-dark-blue">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        (p)retired
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">gRPC, Cloud Run &amp; Endpoints</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2020-03-25T00:00:00-08:00">March 25, 2020</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 5 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 918 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>&lt;3 Google but there&rsquo;s quite often an assumption that we&rsquo;re all sitting around the engineering table and, of course, we&rsquo;re not.</p>
<p><a href="https://cloud.google.com/endpoints">Cloud Endpoints</a> is a powerful offering but &ndash; IMO &ndash; it&rsquo;s <strong>super</strong> confusing to understand and complex to deploy.</p>
<p>If you&rsquo;re familiar with the motivations behind service meshes (e.g. <a href="https://istio.io">Istio</a>), Cloud Endpoints fits in a similar niche (&ldquo;neesh&rdquo; or &ldquo;nitch&rdquo;?). The underlying ambition is that, developers can take <strong>existing</strong> code and by adding a proxy (or sidecar), general-purpose abstractions, security, logging etc. may be added.</p>
<p>With Cloud Endpoints, the goals are to leverage general-purpose authentication|authorization, logging and monitoring mechanisms offered by Google. And, more specifically, the ability to define your services&rsquo; APIs to Google&rsquo;s infrastructure using either OpenAPI (nee Swagger) or Protobuf so that you may expose, secure, monetize etc. your APIs.</p>
<p>For a long time, Google used NGINX as a proxy (a) underpinning its Cloud Endpoints ESP (&ldquo;Extensible Service Proxy&rdquo;); (b) and also the sidecar deploying alongside your App Engine flexible apps. For good reasons, <a href="https://envoyproxy.io">Envoy</a> has become a darling of the proxy scene and, with Google&rsquo;s commitment to Istio (and beyond), Envoy has become the proxy underpinning the new version of ESP, <a href="https://github.com/GoogleCloudPlatform/esp-v2">ESPv2</a>.</p>
<p>A roundabout way of saying that, when you add Cloud Endpoints to your service, you generally want to route all traffic through ESP and have it proxy the traffic to your backend. By so doing, ESP is able to instrument and secure your API calls among other things.</p>
<p>Having been toying with Cloud Run this week (<a href="https://github.com/grpc-ecosystem/grpc-cloud-run-example/blob/master/golang/README.md">Golang</a> and <a href="https://github.com/grpc-ecosystem/grpc-cloud-run-example/tree/master/rust">Rust</a> samples for <a href="https://github.com/grpc-ecosystem/grpc-cloud-run-example">gRPC in Cloud Run</a>), I was compelled to follow a Google tutorial <a href="https://cloud.google.com/endpoints/docs/grpc/get-started-cloud-run#deploy_configuration">Getting Started with Endpoint for Cloud Run</a> to bring everything together and make <code>grpcurl</code> calls to ESPv2 running under Cloud Run proxying traffic to the Golang|Rust gRPC servers also running under Cloud Run.</p>
<p>Google&rsquo;s documentation is good although I believe the seemingly optional step of <a href="https://cloud.google.com/endpoints/docs/grpc/get-started-cloud-run#configure_esp">Building a new ESPv2 Beta Image</a> is mandatory (<a href="https://issuetracker.google.com/issues/152393789">issue</a>).</p>
<p>I&rsquo;m always one for bash scripting <em>the shit out of</em> tutorials ;-)</p>
<p>Assume you&rsquo;re able to <code>./deploy.sh ${PROJECT} [node|pythongolang|rust]</code> from Google&rsquo;s <a href="https://github.com/DazWilkin/grpc-cloud-run-example">gRPC in Google Cloud Run</a> repo, the following should rebuild and deploy the ESPv2 proxy under Cloud Run, configure Cloud Endpoints and route a test <code>grpcurl</code> through the proxy for you:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Assumes the grpc-calculator service has been deployed to the project</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># See ${HOME}/Projects/grpc-cloud-run-examples/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Parameters from Environment</span>
</span></span><span style="display:flex;"><span>: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PROJECT:?Need to set PROJECT to GCP Project ID<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>REGION:?Need to set REGION to GCP region<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The ESPv2 Cloud Run service will be named &#34;proxy&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Assumes (!) the existence of a Cloud Run service &#34;grpc-calculator&#34;</span>
</span></span><span style="display:flex;"><span>ESP<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;proxy&#34;</span>
</span></span><span style="display:flex;"><span>SRV<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;grpc-calculator&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If not present, download protoc and add it to the path</span>
</span></span><span style="display:flex;"><span>VERS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;3.11.4&#34;</span>
</span></span><span style="display:flex;"><span>ARCH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;linux-x86_64&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -d ./protoc-<span style="color:#e6db74">${</span>VERS<span style="color:#e6db74">}</span>-<span style="color:#e6db74">${</span>ARCH<span style="color:#e6db74">}</span> <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  wget <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  https://github.com/protocolbuffers/protobuf/releases/download/v<span style="color:#e6db74">${</span>VERS<span style="color:#e6db74">}</span>/protoc-<span style="color:#e6db74">${</span>VERS<span style="color:#e6db74">}</span>-<span style="color:#e6db74">${</span>ARCH<span style="color:#e6db74">}</span>.zip <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --output-document<span style="color:#f92672">=</span>./protoc-<span style="color:#e6db74">${</span>VERS<span style="color:#e6db74">}</span>-<span style="color:#e6db74">${</span>ARCH<span style="color:#e6db74">}</span>.zip
</span></span><span style="display:flex;"><span>  unzip -o protoc-<span style="color:#e6db74">${</span>VERS<span style="color:#e6db74">}</span>-<span style="color:#e6db74">${</span>ARCH<span style="color:#e6db74">}</span>.zip -d ./protoc-<span style="color:#e6db74">${</span>VERS<span style="color:#e6db74">}</span>-<span style="color:#e6db74">${</span>ARCH<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PATH<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PATH<span style="color:#e6db74">}</span>:<span style="color:#e6db74">${</span>PWD<span style="color:#e6db74">}</span>/protoc-<span style="color:#e6db74">${</span>VERS<span style="color:#e6db74">}</span>-<span style="color:#e6db74">${</span>ARCH<span style="color:#e6db74">}</span>/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate the Protobuf Descriptor file</span>
</span></span><span style="display:flex;"><span>protoc <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--include_imports <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--include_source_info <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--proto_path<span style="color:#f92672">=</span>. <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--descriptor_set_out<span style="color:#f92672">=</span>api_descriptor.pb <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>calculator.proto
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cloud Build is here to rebuild the ESPv2 image</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> SERVICE in <span style="color:#e6db74">&#34;cloudbuild&#34;</span> <span style="color:#e6db74">&#34;endpoints&#34;</span> <span style="color:#e6db74">&#34;servicecontrol&#34;</span> <span style="color:#e6db74">&#34;servicemanagement&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  gcloud services enable <span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span>.googleapis.com <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Need to deploy ESP proxy in order to be able to query it for configuration in api_config.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># However, this ESP version must be redeployed before the project will work</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># See `Rebuild ESP Image` below</span>
</span></span><span style="display:flex;"><span>gcloud run deploy <span style="color:#e6db74">${</span>ESP<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--image<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gcr.io/endpoints-release/endpoints-runtime-serverless:2&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--allow-unauthenticated <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--platform managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Query Cloud Run for service endpoints (Proxy, Calculator)</span>
</span></span><span style="display:flex;"><span>ESP_HOST<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  gcloud run services list <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;value(status.address.url)&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --filter<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;metadata.name=</span><span style="color:#e6db74">${</span>ESP<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span> 
</span></span><span style="display:flex;"><span>ESP_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>ESP_HOST#https://<span style="color:#e6db74">}</span> <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">${</span>ESP_HOST<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This should have been deployed</span>
</span></span><span style="display:flex;"><span>SRV_HOST<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  gcloud run services list <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;value(status.address.url)&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --filter<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;metadata.name=</span><span style="color:#e6db74">${</span>SRV<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span> 
</span></span><span style="display:flex;"><span>SRV_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>SRV_HOST#https://<span style="color:#e6db74">}</span> <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">${</span>SRV_HOST<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Construct api_config.yaml using the Endpoints</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">type: google.api.Service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">config_version: 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name: ESP_HOST
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">title: gRPC Calculator Service
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">apis:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  - name: Calculator
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">usage:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - selector: Calculator.Calculate
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      allow_unregistered_calls: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">backend:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  rules:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    - selector: &#34;*&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      address: grpcs://SRV_HOST
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span> |<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>sed <span style="color:#e6db74">&#34;s|name: ESP_HOST|name: </span><span style="color:#e6db74">${</span>ESP_HOST<span style="color:#e6db74">}</span><span style="color:#e6db74">|g&#34;</span> |<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>sed <span style="color:#e6db74">&#34;s|address: grpcs://SRV_HOST|address: grpcs://</span><span style="color:#e6db74">${</span>SRV_HOST<span style="color:#e6db74">}</span><span style="color:#e6db74">|g&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>&gt; api_config.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Deploy the Endpoints service</span>
</span></span><span style="display:flex;"><span>gcloud endpoints services deploy api_descriptor.pb api_config.yaml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tidy</span>
</span></span><span style="display:flex;"><span>rm api_config.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Rebuild ESP image</span>
</span></span><span style="display:flex;"><span>CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  gcloud endpoints configs list <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --service<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>ESP_HOST<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;json&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  | jq -r .<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>.id<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>./gcloud_build_image <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-s <span style="color:#e6db74">${</span>ESP_HOST<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-c <span style="color:#e6db74">${</span>CONFIG<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-p <span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Redeploy the Cloud Run ESP proxy</span>
</span></span><span style="display:flex;"><span>gcloud run deploy <span style="color:#e6db74">${</span>ESP<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--image<span style="color:#f92672">=</span>gcr.io/<span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>/endpoints-runtime-serverless:<span style="color:#e6db74">${</span>ESP_HOST<span style="color:#e6db74">}</span>-<span style="color:#e6db74">${</span>CONFIG<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--allow-unauthenticated <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Permit Cloud Run services (i.e. Proxy)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># running as ${PROJECT_NUM}-compute@</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># to invoke Cloud Run services (i.e. Calculator)</span>
</span></span><span style="display:flex;"><span>PROJECT_NUM<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  gcloud projects describe <span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;value(projectNumber)&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>EMAIL<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT_NUM<span style="color:#e6db74">}</span>-compute@developer.gserviceaccount.com
</span></span><span style="display:flex;"><span>gcloud run services add-iam-policy-binding <span style="color:#e6db74">${</span>SRV<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--member<span style="color:#f92672">=</span>serviceAccount:<span style="color:#e6db74">${</span>EMAIL<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--role<span style="color:#f92672">=</span>roles/run.invoker <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Test</span>
</span></span><span style="display:flex;"><span>grpcurl <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-d <span style="color:#e6db74">&#39;{&#34;first_operand&#34;: 2.0, &#34;second_operand&#34;: 3.0, &#34;operation&#34;: &#34;ADD&#34;}&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-proto calculator.proto <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">${</span>ESP_HOST<span style="color:#e6db74">}</span>:443 Calculator.Calculate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tidy</span>
</span></span><span style="display:flex;"><span>rm api_descriptor.pb
</span></span></code></pre></div><p>All being well, this should conclude with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JSON" data-lang="JSON"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;result&#34;</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Yes, one of the world&rsquo;s most resource-intensive calculators :-)</p>
<p>When you&rsquo;re done, you must delete the Endpoints service first as a lien is applied to it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ESP<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;proxy&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ESP_HOST<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  gcloud run services list <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;value(status.address.url)&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --filter<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;metadata.name=</span><span style="color:#e6db74">${</span>ESP<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span> 
</span></span><span style="display:flex;"><span>ESP_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>ESP_HOST#https://<span style="color:#e6db74">}</span> <span style="color:#f92672">&amp;&amp;</span> echo <span style="color:#e6db74">${</span>ESP_HOST<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gcloud endpoints services delete <span style="color:#e6db74">${</span>ESP_HOST<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--quiet
</span></span></code></pre></div><p>And then you can optionally delete the Cloud Run services:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SRV<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;grpc-calculator&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> SERVICE in <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ESP<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SRV<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  gcloud run services delete <span style="color:#e6db74">${</span>SERVICE<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --platform<span style="color:#f92672">=</span>managed <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --region<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --project<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --quiet
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>And then &ndash; if you&rsquo;re absolutely certain you don&rsquo;t need any of its resource &ndash; sure? Whack the entire project:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud projects delete <span style="color:#e6db74">${</span>PROJECT<span style="color:#e6db74">}</span> --quiet
</span></span></code></pre></div><p>HTH!</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/google/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Google</a>
   </li>
  
   <li class="list di">
     <a href="/tags/golang/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Golang</a>
   </li>
  
   <li class="list di">
     <a href="/tags/cloud-run/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Cloud-Run</a>
   </li>
  
   <li class="list di">
     <a href="/tags/grpc/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">GRPC</a>
   </li>
  
   <li class="list di">
     <a href="/tags/grpcurl/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">GRPCurl</a>
   </li>
  
   <li class="list di">
     <a href="/tags/protobufs/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Protobufs</a>
   </li>
  
   <li class="list di">
     <a href="/tags/rust/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Rust</a>
   </li>
  
   <li class="list di">
     <a href="/tags/esp/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">ESP</a>
   </li>
  
   <li class="list di">
     <a href="/tags/cloud-endpoints/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Cloud-Endpoints</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/200320/">Golang gRPC Cloud Run</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200206/">Cloud Build wishlist: Mountable Golang Modules Proxy</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190918/">Cloud Functions Simple(st) HTTP Multi-host Proxy</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/190917/">Cloud Functions Simple(st) HTTP Proxy</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200310/">Google&#39;s New Golang SDK for Protobufs</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200227/">ESPHome, MQTT, Prometheus and almost Cloud IoT</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200226/">OriginStamp: Verifying Proofs</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200219/">FreeTSA &amp; Digitorus&#39; Timestamp SDK</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200217/">OriginStamp Python|Golang SDK Examples</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200207/">Accessing GCR repos from Kubernetes</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200122/">Setting up a GCE Instance as an Inlets Exit Node</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200110/">Google Fit</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/200107/">Google Home Exporter</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/191220/">Google Cloud Platform (GCP) Exporter</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/191218/">Linode Prometheus Exporter</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-dark-blue bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://pretired.dazwilkin.com/" >
    &copy;  (p)retired 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>